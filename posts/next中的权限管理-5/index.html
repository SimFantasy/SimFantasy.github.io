<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Next中的权限管理(五) | SimFantasy</title>
<meta name=author content="Simz"><meta name=description content="lucia是一个小众的权限管理工具，适用于多个运行时包括：node、bun、deno、cloudflare workers，也提供了多个数据库或orm的适配器。
lucia在配置上比auth.js简单了很多，这也导致了它在功能层面上比auth.js弱了很多。因为作者理念的关系，lucia优点和缺点都很明显，我们还是通过项目来看下为什么优缺点都很明显吧。"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Next中的权限管理(五)"><meta name=twitter:description content="lucia是一个小众的权限管理工具，适用于多个运行时包括：node、bun、deno、cloudflare workers，也提供了多个数据库或orm的适配器。
lucia在配置上比auth.js简单了很多，这也导致了它在功能层面上比auth.js弱了很多。因为作者理念的关系，lucia优点和缺点都很明显，我们还是通过项目来看下为什么优缺点都很明显吧。"><meta property="og:url" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-5/"><meta property="og:site_name" content="SimFantasy"><meta property="og:title" content="Next中的权限管理(五)"><meta property="og:description" content="lucia是一个小众的权限管理工具，适用于多个运行时包括：node、bun、deno、cloudflare workers，也提供了多个数据库或orm的适配器。
lucia在配置上比auth.js简单了很多，这也导致了它在功能层面上比auth.js弱了很多。因为作者理念的关系，lucia优点和缺点都很明显，我们还是通过项目来看下为什么优缺点都很明显吧。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-08T10:21:12+08:00"><meta property="article:modified_time" content="2024-08-08T10:21:12+08:00"><meta property="article:tag" content="React"><meta property="article:tag" content="Nextjs"><meta property="og:see_also" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-6/"><meta property="og:see_also" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-4/"><meta property="og:see_also" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-3/"><meta property="og:see_also" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-2/"><meta property="og:see_also" content="http://localhost/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-1/"><meta property="og:see_also" content="http://localhost/posts/nextjs%E9%87%8D%E6%96%B0%E5%AD%A6%E4%B9%A0%E4%B9%8B%E4%B8%89/"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=123"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=123"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=123"><link rel=manifest href=/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=http://localhost/>SimFantasy</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/archive/ title=Archive>Archive</a></li><li><a href=/series/ title=Note>Note</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Next中的权限管理(五)</h1><h2 class=subheading></h2><span class=meta><div class=meta-item><i class="far fa-user-circle"></i> Simz</div><div class=meta-item><i class="far fa-calendar"></i> 2024-08-08</div><div class=meta-item><i class="fa fa-tag"></i>
<a href=/tags/react/ title=React>React</a>
<a href=/tags/nextjs/ title=Nextjs>Nextjs</a></div></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><code>lucia</code>是一个小众的权限管理工具，适用于多个运行时包括：<code>node</code>、<code>bun</code>、<code>deno</code>、<code>cloudflare workers</code>，也提供了多个数据库或<code>orm</code>的适配器。</p><p><code>lucia</code>在配置上比<code>auth.js</code>简单了很多，这也导致了它在功能层面上比<code>auth.js</code>弱了很多。因为作者理念的关系，<code>lucia</code>优点和缺点都很明显，我们还是通过项目来看下为什么优缺点都很明显吧。</p><h3 id=项目五luciaprisma实现task项目的权限管理>项目五：lucia+prisma实现Task项目的权限管理<a class=anchorjs-link href=#%e9%a1%b9%e7%9b%ae%e4%ba%94luciaprisma%e5%ae%9e%e7%8e%b0task%e9%a1%b9%e7%9b%ae%e7%9a%84%e6%9d%83%e9%99%90%e7%ae%a1%e7%90%86></a></h3><h4 id=项目初始化>项目初始化<a class=anchorjs-link href=#%e9%a1%b9%e7%9b%ae%e5%88%9d%e5%a7%8b%e5%8c%96></a></h4><p>也是替换之前相应的权限包即可。因为<code>lucia</code>支持<code>adapter</code>，所以还需要装一个<code>@lucia-auth/adapter-prisma</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic># 使用pnpm，初始化Next.js项目</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>pnpm create next-app@latest next-lucia-prisma-demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic># 安装shadcn-ui作为UI库</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>pnpm dlx shadcn-ui@latest init
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>pnpm dlx shadcn-ui@latest add alert avatar button card dialog form input separator sonner
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic># 安装其他第三方库</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>pnpm add zod react-hook-form @hookform@resolvers lucia @lucia-auth/adapter-prisma bcryptjs @prisma/client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>pnpm add -D prisma @types/bcryptjs
</span></span></code></pre></div><h4 id=项目准备>项目准备<a class=anchorjs-link href=#%e9%a1%b9%e7%9b%ae%e5%87%86%e5%a4%87></a></h4><p>项目也是使用<code>prisma + sqlite</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>// This is your Prisma schema file,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>// learn more about it in the docs: https://pris.ly/d/prisma-schema
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>generator client {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  provider = &#34;prisma-client-js&#34;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>datasource db {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  provider = &#34;sqlite&#34;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  url      = env(&#34;DATABASE_URL&#34;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>model User {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  id       String    @id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>  email    String    @unique
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>  username String    @unique
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>  password String
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>  image    String?   @default(&#34;/images/default-avatar.png&#34;)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>  sessions Session[]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>  tasks    Task[]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>  createdAt DateTime @default(now())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>  updatedAt DateTime @updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>model Session {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>  id        String   @id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>  userId    String
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>  expiresAt DateTime @default(now())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>  user User @relation(references: [id], fields: [userId], onDelete: Cascade)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>model Task {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>  id          String  @id @default(uuid())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>  content     String
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>  isCompleted Boolean @default(false)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>  authorId String
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>  author   User   @relation(fields: [authorId], references: [id])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>  createdAt DateTime @default(now())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>  updatedAt DateTime @updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>}
</span></span></code></pre></div><p>和之前的也差不多，需要注意，这里的<code>User</code>和<code>Session</code>的<code>id</code>都是由<code>lucia</code>来生成的，<code>lucia</code>在生成<code>session</code>时需要使用到这个<code>id</code>，后面在创建用户时，我们在详细看看。</p><h4 id=配置lucia>配置lucia<a class=anchorjs-link href=#%e9%85%8d%e7%bd%aelucia></a></h4><h5 id=auth>Auth<a class=anchorjs-link href=#auth></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/lib/auth.ts
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>import</span> { cache } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;react&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>import</span> { cookies } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next/headers&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>import</span> { Lucia, Session, User } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;lucia&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#8839ef>import</span> { PrismaAdapter } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@lucia-auth/adapter-prisma&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#8839ef>import</span> { db } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/db&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic>// 定义数据库用户属性，相当于Session.user的类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>export</span> <span style=color:#8839ef>interface</span> DatabaseUserAttributes {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	id: <span style=color:#d20f39>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	username: <span style=color:#d20f39>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	email: <span style=color:#d20f39>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	image: <span style=color:#d20f39>string</span> <span style=color:#04a5e5;font-weight:700>|</span> <span style=color:#fe640b>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span><span style=color:#9ca0b0;font-style:italic>// 扩展lucia的类型定义
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>declare</span> module <span style=color:#40a02b>&#39;lucia&#39;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	<span style=color:#8839ef>interface</span> Register {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>		Lucia: <span style=color:#d20f39>typeof</span> lucia
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>		DatabaseUserAttributes: <span style=color:#d20f39>DatabaseUserAttributes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span><span style=color:#9ca0b0;font-style:italic>// 创建prisma适配器
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> adapter <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> PrismaAdapter(db.session, db.user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span><span style=color:#9ca0b0;font-style:italic>// 创建lucia实例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> lucia <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Lucia(adapter, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>	sessionCookie<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		expires: <span style=color:#d20f39>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>		attributes<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			secure: <span style=color:#d20f39>process.env.NODE_ENV</span> <span style=color:#04a5e5;font-weight:700>===</span> <span style=color:#40a02b>&#39;production&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>	getUserAttributes(databaseUserAttributes) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>		<span style=color:#8839ef>return</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>			id: <span style=color:#d20f39>databaseUserAttributes.id</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>			username: <span style=color:#d20f39>databaseUserAttributes.username</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>			email: <span style=color:#d20f39>databaseUserAttributes.email</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>			image: <span style=color:#d20f39>databaseUserAttributes.image</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">47</span><span><span style=color:#9ca0b0;font-style:italic>// 在官方说明里这里的变量名称是validateSession
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">48</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> getSession <span style=color:#04a5e5;font-weight:700>=</span> cache(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">49</span><span>	<span style=color:#8839ef>async</span> ()<span style=color:#04a5e5;font-weight:700>:</span> Promise<span style=color:#04a5e5;font-weight:700>&lt;</span>{ user: <span style=color:#d20f39>User</span>; session: <span style=color:#d20f39>Session</span> } <span style=color:#04a5e5;font-weight:700>|</span> { user: <span style=color:#d20f39>null</span>; session: <span style=color:#d20f39>null</span> }<span style=color:#04a5e5;font-weight:700>&gt;</span> <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">50</span><span>		<span style=color:#8839ef>const</span> sessionId <span style=color:#04a5e5;font-weight:700>=</span> cookies().<span style=color:#8839ef>get</span>(lucia.sessionCookieName)<span style=color:#04a5e5;font-weight:700>?</span>.value <span style=color:#04a5e5;font-weight:700>??</span> <span style=color:#fe640b>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">51</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>sessionId) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">52</span><span>			<span style=color:#8839ef>return</span> { user: <span style=color:#d20f39>null</span>, session: <span style=color:#d20f39>null</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">53</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">54</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">55</span><span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> lucia.validateSession(sessionId)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">57</span><span>		<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">58</span><span>			<span style=color:#8839ef>if</span> (result.session <span style=color:#04a5e5;font-weight:700>&amp;&amp;</span> result.session.fresh) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">59</span><span>				<span style=color:#8839ef>const</span> sessionCookie <span style=color:#04a5e5;font-weight:700>=</span> lucia.createSessionCookie(result.session.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">60</span><span>				cookies().<span style=color:#8839ef>set</span>(sessionCookie.name, sessionCookie.value, sessionCookie.attributes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">61</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">63</span><span>			<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>result.session) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">64</span><span>				<span style=color:#8839ef>const</span> sessionCookie <span style=color:#04a5e5;font-weight:700>=</span> lucia.createBlankSessionCookie()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">65</span><span>				cookies().<span style=color:#8839ef>set</span>(sessionCookie.name, sessionCookie.value, sessionCookie.attributes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">66</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">67</span><span>		} <span style=color:#8839ef>catch</span> {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">69</span><span>		<span style=color:#8839ef>return</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">70</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">71</span><span>)
</span></span></code></pre></div><p>在<code>getSession</code>中，<code>Lucia.sessionCookieName</code>获取<code>cookie</code>名称，并使用<code>Lucia.validateSession（）</code>验证会话<code>cookie</code>。如果会话<code>cookie</code>无效，则删除它。</p><p>使用<code>cache()</code>包装该函数，这样它就可以被多次调用，而不会引发多次数据库调用。</p><p>以上则是<code>lucia</code>所有的配置了。相比之前的<code>auth.js</code>简单了太多。</p><h5 id=action>Action<a class=anchorjs-link href=#action></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  1</span><span><span style=color:#9ca0b0;font-style:italic>// src/actions/auth.ts
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#40a02b>&#39;use server&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  4</span><span><span style=color:#8839ef>import</span> { cookies } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next/headers&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  5</span><span><span style=color:#8839ef>import</span> { z } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;zod&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  6</span><span><span style=color:#8839ef>import</span> { generateIdFromEntropySize } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;lucia&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  8</span><span><span style=color:#8839ef>import</span> { lucia, getSession, DatabaseUserAttributes } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/auth&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  9</span><span><span style=color:#8839ef>import</span> { db } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/db&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 10</span><span><span style=color:#8839ef>import</span> { registerSchema, loginSchema } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/schemas&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 11</span><span><span style=color:#8839ef>import</span> { hashPassword, comparePassword } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/utils&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 12</span><span><span style=color:#8839ef>import</span> { IResponse, IResponseBase } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/types&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 13</span><span><span style=color:#8839ef>import</span> { ActionResponse } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/action-response&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 15</span><span><span style=color:#9ca0b0;font-style:italic>// 设置lucia session，并设置cookie
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 16</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> setLuciaSession <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> (userId: <span style=color:#d20f39>string</span>) <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 17</span><span>	<span style=color:#8839ef>const</span> session <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> lucia.createSession(userId, {})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 18</span><span>	<span style=color:#8839ef>const</span> sessionCookie <span style=color:#04a5e5;font-weight:700>=</span> lucia.createSessionCookie(session.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 20</span><span>	cookies().<span style=color:#8839ef>set</span>(sessionCookie.name, sessionCookie.value, sessionCookie.attributes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 23</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> registerAction <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 24</span><span>	values: <span style=color:#d20f39>z.infer</span>&lt;<span style=color:#8839ef>typeof</span> <span style=color:#1e66f5>registerSchema</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 25</span><span>)<span style=color:#04a5e5;font-weight:700>:</span> Promise&lt;<span style=color:#8839ef>IResponse</span><span style=color:#d20f39>&lt;</span><span style=color:#1e66f5>DatabaseUserAttributes</span>&gt;<span style=color:#04a5e5;font-weight:700>&gt;</span> <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 26</span><span>	<span style=color:#8839ef>const</span> validatedFields <span style=color:#04a5e5;font-weight:700>=</span> registerSchema.safeParse(values)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 27</span><span>	<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>validatedFields.success) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 28</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Invalid input data&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 29</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 31</span><span>	<span style=color:#8839ef>const</span> { username, email, password } <span style=color:#04a5e5;font-weight:700>=</span> validatedFields.data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 33</span><span>	<span style=color:#8839ef>const</span> existingUserEmail <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> db.user.findFirst({ where<span style=color:#04a5e5;font-weight:700>:</span> { email } })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 34</span><span>	<span style=color:#8839ef>if</span> (existingUserEmail) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 35</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Email already registered&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 36</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 38</span><span>	<span style=color:#8839ef>const</span> existingUserUsername <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> db.user.findFirst({ where<span style=color:#04a5e5;font-weight:700>:</span> { username } })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 39</span><span>	<span style=color:#8839ef>if</span> (existingUserUsername) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 40</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Username already registered&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 41</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 43</span><span>	<span style=color:#8839ef>const</span> hashedPassword <span style=color:#04a5e5;font-weight:700>=</span> hashPassword(password)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 44</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 45</span><span>	<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 46</span><span>		<span style=color:#8839ef>const</span> userId <span style=color:#04a5e5;font-weight:700>=</span> generateIdFromEntropySize(<span style=color:#fe640b>16</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 47</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> db.user.create({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 48</span><span>			data<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 49</span><span>				id: <span style=color:#d20f39>userId</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 50</span><span>				username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 51</span><span>				email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 52</span><span>				password: <span style=color:#d20f39>hashedPassword</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 53</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 54</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 56</span><span>		<span style=color:#8839ef>await</span> setLuciaSession(userId)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 57</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 58</span><span>		<span style=color:#8839ef>return</span> ActionResponse.ok({ data: <span style=color:#d20f39>user</span>, message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User created successfully&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 59</span><span>	} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 60</span><span>		console.log(<span style=color:#40a02b>&#39;Error while creating user&#39;</span>, error)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 61</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Error while creating user&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 62</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 63</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 65</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> loginAction <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> (values: <span style=color:#d20f39>z.infer</span>&lt;<span style=color:#8839ef>typeof</span> <span style=color:#1e66f5>loginSchema</span>&gt;)<span style=color:#04a5e5;font-weight:700>:</span> Promise&lt;<span style=color:#8839ef>IResponseBase</span>&gt; <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 66</span><span>	<span style=color:#8839ef>const</span> validatedFields <span style=color:#04a5e5;font-weight:700>=</span> loginSchema.safeParse(values)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 67</span><span>	<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>validatedFields.success) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 68</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Invalid input data&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 69</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 71</span><span>	<span style=color:#8839ef>const</span> { email, password } <span style=color:#04a5e5;font-weight:700>=</span> validatedFields.data
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 72</span><span>	<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 73</span><span>		<span style=color:#8839ef>const</span> existingUser <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> db.user.findFirst({ where<span style=color:#04a5e5;font-weight:700>:</span> { email } })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 74</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>existingUser) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 75</span><span>			<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Invalid email or password&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 76</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 77</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 78</span><span>		<span style=color:#8839ef>const</span> isMatch <span style=color:#04a5e5;font-weight:700>=</span> comparePassword(password, existingUser.password)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 79</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>isMatch) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 80</span><span>			<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Invalid email or password&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 81</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 83</span><span>		<span style=color:#8839ef>await</span> setLuciaSession(existingUser.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 84</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 85</span><span>		<span style=color:#8839ef>return</span> ActionResponse.noContent(<span style=color:#40a02b>&#39;User logged in successfully&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 86</span><span>	} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 87</span><span>		console.log(<span style=color:#40a02b>&#39;Error while logging in user&#39;</span>, error)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 88</span><span>		<span style=color:#8839ef>return</span> ActionResponse.badRequest(<span style=color:#40a02b>&#39;Error while logging in user&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 89</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 90</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 91</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 92</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> logoutAction <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> ()<span style=color:#04a5e5;font-weight:700>:</span> Promise&lt;<span style=color:#8839ef>IResponseBase</span>&gt; <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 93</span><span>	<span style=color:#8839ef>const</span> { session } <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> getSession()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 94</span><span>	<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>session) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 95</span><span>		<span style=color:#8839ef>return</span> ActionResponse.noContent(<span style=color:#40a02b>&#39;User already logged out&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 96</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 97</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 98</span><span>	<span style=color:#8839ef>await</span> lucia.invalidateSession(session.id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 99</span><span>	<span style=color:#8839ef>const</span> sessionCookie <span style=color:#04a5e5;font-weight:700>=</span> lucia.createBlankSessionCookie()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">100</span><span>	cookies().<span style=color:#8839ef>set</span>(sessionCookie.name, sessionCookie.value, sessionCookie.attributes)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">101</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">102</span><span>	<span style=color:#8839ef>return</span> ActionResponse.noContent(<span style=color:#40a02b>&#39;User logged out successfully&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">103</span><span>}
</span></span></code></pre></div><p>在<code>registerAction</code>和<code>loginAction</code>中我们都通过<code>setLuciaSession</code>来设置<code>lucia session</code>，这样在注册或登录成功后，就直接登录到根目录。</p><p><code>logoutAction</code>则需要通过<code>session.id</code>来移除对应的<code>session</code>和<code>cookie</code>。</p><h5 id=provider>Provider<a class=anchorjs-link href=#provider></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/components/providers/auth-user-provider.tsx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#40a02b>&#39;use client&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>import</span> { useEffect, useState } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;react&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#8839ef>import</span> { useAuth } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/hooks/use-auth&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#8839ef>import</span> { Loader } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/components/common/loader&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#8839ef>import</span> { Session, User } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;lucia&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#8839ef>interface</span> AuthUserProviderProps {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	children: <span style=color:#d20f39>React.ReactNode</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	auth<span style=color:#04a5e5;font-weight:700>:</span> { session: <span style=color:#d20f39>Session</span>; user: <span style=color:#d20f39>User</span> } <span style=color:#04a5e5;font-weight:700>|</span> { session: <span style=color:#d20f39>null</span>; user: <span style=color:#d20f39>null</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> AuthUserProvider <span style=color:#04a5e5;font-weight:700>=</span> ({ children, auth }<span style=color:#04a5e5;font-weight:700>:</span> AuthUserProviderProps) <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>	<span style=color:#8839ef>const</span> [loading, setLoading] <span style=color:#04a5e5;font-weight:700>=</span> useState(<span style=color:#fe640b>true</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>	<span style=color:#8839ef>const</span> setAuthUser <span style=color:#04a5e5;font-weight:700>=</span> useAuth(state <span style=color:#04a5e5;font-weight:700>=&gt;</span> state.setAuthUser)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	useEffect(() <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>		<span style=color:#8839ef>if</span> (auth) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			setLoading(<span style=color:#fe640b>false</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			setAuthUser(auth.user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>			setLoading(<span style=color:#fe640b>false</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>			setAuthUser(<span style=color:#fe640b>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>	}, [auth, setAuthUser])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>	<span style=color:#8839ef>if</span> (loading) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		<span style=color:#8839ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>			&lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>className</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;flex items-center gap-x-2 p-2&#39;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>				&lt;<span style=color:#8839ef>Loader</span> <span style=color:#1e66f5>text</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;Task Loading...&#39;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	<span style=color:#8839ef>return</span> &lt;&gt;{children}&lt;/&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>}
</span></span></code></pre></div><p>这里应该是<code>lucia</code>第一个坑的解决方案了，<code>lucia</code>只提供了在服务端使用的<code>getSession</code>，并没有在客户端使用的方法，我记得好像看到过官方的一个解决方案是使用<code>api</code>的<code>route</code>的解决方式，看的我都有点懵逼。</p><p>这里我们需要在最外层的<code>layout</code>上传入<code>session</code>。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/app/layout.tsx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>import</span> <span style=color:#8839ef>type</span> { Metadata } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>import</span> { Inter } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next/font/google&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>import</span> <span style=color:#40a02b>&#39;./globals.css&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#8839ef>import</span> { getSession } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/auth&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#8839ef>import</span> { AuthUserProvider } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/components/providers/auth-user-provider&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#8839ef>import</span> { ModalProvider } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/components/providers/modal-provider&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#8839ef>import</span> { Toaster } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/components/ui/sonner&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#8839ef>const</span> inter <span style=color:#04a5e5;font-weight:700>=</span> Inter({ subsets<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#40a02b>&#39;latin&#39;</span>] })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>const</span> metadata: <span style=color:#d20f39>Metadata</span> <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Create Next App&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>	description<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Generated by create next app&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>default</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span> RootLayout({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	children
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>}<span style=color:#04a5e5;font-weight:700>:</span> Readonly<span style=color:#04a5e5;font-weight:700>&lt;</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>	children: <span style=color:#d20f39>React.ReactNode</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>}<span style=color:#04a5e5;font-weight:700>&gt;</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>	<span style=color:#8839ef>const</span> auth <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> getSession()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>	<span style=color:#8839ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		&lt;<span style=color:#8839ef>html</span> <span style=color:#1e66f5>lang</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;en&#39;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>			&lt;<span style=color:#8839ef>body</span> <span style=color:#1e66f5>className</span><span style=color:#04a5e5;font-weight:700>=</span>{inter.className}&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>				&lt;<span style=color:#8839ef>AuthUserProvider</span> <span style=color:#1e66f5>auth</span><span style=color:#04a5e5;font-weight:700>=</span>{auth}&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>					{children}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>					&lt;<span style=color:#8839ef>ModalProvider</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>					&lt;<span style=color:#8839ef>Toaster</span> <span style=color:#1e66f5>position</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;top-right&#39;</span> <span style=color:#1e66f5>richColors</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>				&lt;/<span style=color:#8839ef>AuthUserProvider</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			&lt;/<span style=color:#8839ef>body</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>		&lt;/<span style=color:#8839ef>html</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>	)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>}
</span></span></code></pre></div><p>虽然不太习惯在<code>layout</code>层来从获取数据传数据，但这应该是<code>lucia</code>比较好的客户端获取<code>session</code>和<code>user</code>的方案了，后面还有个大坑，不要慌。</p><h5 id=middleware>Middleware<a class=anchorjs-link href=#middleware></a></h5><p>说到中间件，这里就是<code>lucia</code>最大的坑，我找了好久的解决方案，直到看到<code>rabbit</code>上老哥分析的话，看下为什么<code>lucia</code>上不能使用<code>middleware</code>来检查权限。用<code>ChatGPT</code>翻译并总结了下：</p><blockquote><p>翻译：</p><p>不想冒犯Lucia的开发者，但我最近一直在思考这个问题，特别是在看到Lucia v3测试版文档后。这引发了一些基本问题（其中大部分是我自己刚刚发现的，所以请原谅我的回答不太成熟，也请原谅如果这些你已经知道了，写下基础有助于我自己理清思路）。</p><p>Auth.js（前身为next-auth）和Lucia在身份验证方式上存在根本差异。Lucia只使用会话进行验证，而Auth.js提供了会话或JWT两种验证方式（你可以选择）。这对中间件的使用有重大影响，因为会话需要数据库调用，而JWT则不需要。</p><p>在Vercel上托管的NextJS中间件使用边缘运行时。这个运行时不同于node.js，因此只能使用有限的一部分JavaScript库。要在使用会话验证时使用中间件进行用户认证和设置Cookie（目前Lucia的github示例中在Page.tsx中实现的功能），需要驱动程序和数据库连接与边缘运行时兼容。由于这是复杂的，许多数据库/ORM都不兼容边缘运行时，Auth.js完全绕过了这个选项，只允许在使用JWT策略时使用中间件进行验证。Lucia不提供JWT，可能是因为它们在多种原因下不够安全（虽然我认为开发者在早期版本中使用了JWT验证，然后改用了其他方法）。</p><p>在这种背景下，你可以用中间件进行Lucia验证的方式有两种以上，但问题是你是否愿意使用它们，因为它们都有缺点。注意：我没有亲自尝试过这些方法，但我已经广泛研究过，并相信这些都是可能的。</p><p>选项1：使用与边缘运行时兼容的数据库/ORM选项。我认为一般需要TCP连接的数据库不可行，像Prisma这种臃肿的ORM也不行。你需要一种（无服务器的）数据库，它可以通过WebSockets（非常慢，高延迟）或HTTP（更快）连接。选项包括neon、planetscale和upstash。主要问题在于中间件在边缘运行，需要与数据库通信，因此会有一个往返——通常主服务器会尽量靠近数据库（同一区域以提高效率），你并不会从这种方法中获得太多速度上的优势（换句话说，从用户到中间件再到数据库再回到中间件的行程可能比直接到服务器的行程更长）。主要例外是如果你有更靠近边缘功能的数据库只读副本（如upstash），但这可能需要一些额外的资金投入和网络架构的工程。</p><p>选项2：设置一个单独的API路由来处理来自中间件的身份验证请求。一些希望使用next-auth进行会话验证的人建议了这个选项（你可以在next-auth的github上搜索）。一个人设置一个API路由，中间件使用收到的Cookie ping这个路由来检查用户是否已验证。这需要中间件与服务器之间的额外往返。</p><p>总结来说，没有完美的选择，只有权衡。如果你将逻辑放在布局中，它会显得不那么简洁和可维护。把它放在每个受保护的路由顶部也不是最优选择。然而，上述选项各自都有成本，包括可能减慢你的应用程序。随着时间的推移，我看到两种可能的情况：要么边缘运行时架构改善，以支持更复杂的软件，要么NextJs更改其中间件架构，以便可以选择非边缘运行时选项。抱歉我啰嗦了。</p><p>附注：如果你在其他平台或自行托管NextJs应用程序，你就不会遇到这些边缘中间件运行的问题——这是Vercel部署中的一个问题。详见此页底部的中间件部分：https://nextjs.org/docs/app/building-your-application/deploying</p><p>总结：</p><p>这段文字探讨了Auth.js和Lucia在身份验证上的不同，重点在于Lucia只支持会话验证，而Auth.js支持会话和JWT两种方式。这种差异导致了在Vercel的边缘运行时上使用中间件的难度，因为会话验证需要数据库调用，而JWT则不需要。文章还讨论了使用Lucia的两种可能方法及其各自的权衡，最终指出没有完美的解决方案，只能在功能和性能之间做出选择。如果使用非Vercel部署，这些问题可能会减少。</p></blockquote><p>简单来说，就是使用<code>session</code>的方式需要调用数据库，如果在<code>middleware</code>中使用就会需要使用到<code>edge runtime</code>，如果需要使用到<code>edge runtime</code>一般的<code>tcp</code>和<code>orm</code>都不行。</p><p>所以这里的解决办法是在需要权限验证的地方使用<code>getSeesion</code>来加以隔离。具体如下：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/app/(auth)/layout.tsx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>import</span> { getSession } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/auth&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>import</span> { redirect } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next/navigation&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#8839ef>const</span> AuthLayout <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> ({ children }<span style=color:#04a5e5;font-weight:700>:</span> { children: <span style=color:#d20f39>React.ReactNode</span> }) <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#8839ef>const</span> session <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> getSession()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	<span style=color:#8839ef>if</span> (session.user) redirect(<span style=color:#40a02b>&#39;/&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#8839ef>return</span> &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>className</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;flex justify-center items-center w-full h-screen&#39;</span>&gt;{children}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>default</span> AuthLayout
</span></span></code></pre></div><p>在登录、注册的<code>layout</code>中设置，如果登录了，就直接跳转到根目录。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tsx data-lang=tsx><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/app/(main)/layout.tsx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>import</span> { getSession } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;@/lib/auth&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>import</span> { redirect } <span style=color:#8839ef>from</span> <span style=color:#40a02b>&#39;next/navigation&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#8839ef>const</span> MainLayout <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> ({ children }<span style=color:#04a5e5;font-weight:700>:</span> { children: <span style=color:#d20f39>React.ReactNode</span> }) <span style=color:#04a5e5;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#8839ef>const</span> session <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> getSession()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>session.user) redirect(<span style=color:#40a02b>&#39;/login&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#8839ef>return</span> &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>className</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#39;flex justify-center w-full h-full min-h-screen py-10&#39;</span>&gt;{children}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#8839ef>export</span> <span style=color:#8839ef>default</span> MainLayout
</span></span></code></pre></div><p>在进入到<code>main</code>下的页面时，如果没有登录则跳转到登录页面。</p><p>这样会使得权限的验证非常麻烦。</p><h4 id=lucia在客户端和服务端的方法>lucia在客户端和服务端的方法<a class=anchorjs-link href=#lucia%e5%9c%a8%e5%ae%a2%e6%88%b7%e7%ab%af%e5%92%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e7%9a%84%e6%96%b9%e6%b3%95></a></h4><p>服务端：</p><p><code>getSession</code>，从<code>src/lib/auth.ts</code>中导入。可以获取到对应的<code>session</code>和之前在<code>auth.ts</code>中定义的<code>user</code>信息。</p><p>客户端：</p><p><code>useAuth</code>，从<code>layout</code>加载时获取到的<code>session</code>和<code>user</code>。</p><h4 id=总结>总结<a class=anchorjs-link href=#%e6%80%bb%e7%bb%93></a></h4><p>优点：</p><ul><li>配置比<code>auth.js</code>简单了太多，轻量的配置即可获得一个权限系统。</li><li>持多种运行时，支持多种数据库或<code>orm</code>的适配器，支持第三方登录<code>OAuth</code></li><li>官方的文档还不错，比<code>auth.js</code>的不知道好到哪去了，给了很多示例模板和说明，学习成本小了很多。</li></ul><p>缺点：</p><ul><li>因为仅使用<code>session</code>的方式来进行验证，导致不能在<code>next.js</code>的<code>middleware</code>中进行权限验证过滤。</li><li>没有提供客户端<code>session</code>的获取的方法，需要自己来处理。</li></ul><p>总结：</p><p><code>lucia</code>的虽然优缺点都很明显，但还是可以根据项目情况酌情来使用的，因为支持多种运行时，看到很多大佬的示例项目都使用了<code>bun</code>+<code>lucia</code>+<code>hono</code>或者<code>bun</code>+<code>lucia</code>+<code>elysia</code>。也从一个侧面说明，还是有一定的受众人群的。尤其是在运行时环境大爆发的时代，给到的权限验证选择却不是那么多。</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-4/ data-toggle=tooltip data-placement=top title=Next中的权限管理(四)>Previous<br><span>Next中的权限管理(四)</span></a></li><li class=next><a href=/posts/next%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-6/ data-toggle=tooltip data-placement=top title=Next中的权限管理(六)>Next<br><span>Next中的权限管理(六)</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/api/>Api</a>
<a href=/tags/auth0/>Auth0</a>
<a href=/tags/chakraui/>Chakraui</a>
<a href=/tags/css/>Css</a>
<a href=/tags/egg/>Egg</a>
<a href=/tags/electron/>Electron</a>
<a href=/tags/elementplus/>ElementPlus</a>
<a href=/tags/elementui/>Elementui</a>
<a href=/tags/elint/>Elint</a>
<a href=/tags/eslint/>Eslint</a>
<a href=/tags/express/>Express</a>
<a href=/tags/firebase/>Firebase</a>
<a href=/tags/formik/>Formik</a>
<a href=/tags/git/>Git</a>
<a href=/tags/graphql/>GraphQL</a>
<a href=/tags/hexo/>Hexo</a>
<a href=/tags/hooks/>Hooks</a>
<a href=/tags/icon/>Icon</a>
<a href=/tags/javascript/>Javascript</a>
<a href=/tags/koa/>Koa</a>
<a href=/tags/mongoddb/>Mongoddb</a>
<a href=/tags/nextjs/>Nextjs</a>
<a href=/tags/node/>Node</a>
<a href=/tags/pinia/>Pinia</a>
<a href=/tags/prettier/>Prettier</a>
<a href=/tags/prisma/>Prisma</a>
<a href=/tags/react/>React</a>
<a href=/tags/react-query/>React-Query</a>
<a href=/tags/react-router/>React-Router</a>
<a href=/tags/redux-toolkit/>Redux-Toolkit</a>
<a href=/tags/sequelize/>Sequelize</a>
<a href=/tags/strapi/>Strapi</a>
<a href=/tags/styled-components/>Styled-Components</a>
<a href=/tags/typescript/>Typescript</a>
<a href=/tags/valtio/>Valtio</a>
<a href=/tags/vite/>Vite</a>
<a href=/tags/vscode/>Vscode</a>
<a href=/tags/vue/>Vue</a>
<a href=/tags/vuex/>Vuex</a>
<a href=/tags/zustand/>Zustand</a>
<a href=/tags/%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/>避坑指南</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; SimFantasy 2024<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js crossorigin=anonymous></script><script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script><script src=/js/simple-jekyll-search.min.js></script><script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")})</script><script type=text/javascript src=/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js></script><script>$(document).ready(function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script src=/zoomjs/zoom.min.js></script></body></html>