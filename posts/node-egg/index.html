<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Node 16 Egg | SimFantasy</title>
<meta name=author content="Simz"><meta name=description content="egg.js是阿里旗下基于node.js和koa是一个node企业级应用开发框架，可以帮助开发团队，和开发人员减少成本。
基于koa2、es6、es7使得node具有更有规范的开发模式，更低的学习成本、更优雅的代码、更少的维护成本。"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Node 16 Egg"><meta name=twitter:description content="egg.js是阿里旗下基于node.js和koa是一个node企业级应用开发框架，可以帮助开发团队，和开发人员减少成本。 基于koa2、es6、es7使得node具有更有规范的开发模式，更低的学习成本、更优雅的代码、更少的维护成本。"><meta property="og:url" content="http://localhost/posts/node-egg/"><meta property="og:site_name" content="SimFantasy"><meta property="og:title" content="Node 16 Egg"><meta property="og:description" content="egg.js是阿里旗下基于node.js和koa是一个node企业级应用开发框架，可以帮助开发团队，和开发人员减少成本。 基于koa2、es6、es7使得node具有更有规范的开发模式，更低的学习成本、更优雅的代码、更少的维护成本。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-08T23:39:26+08:00"><meta property="article:modified_time" content="2023-10-08T23:39:26+08:00"><meta property="article:tag" content="Egg"><meta property="article:tag" content="Node"><meta property="og:see_also" content="http://localhost/posts/node-mongoose/"><meta property="og:see_also" content="http://localhost/posts/node-mongodb/"><meta property="og:see_also" content="http://localhost/posts/node-log/"><meta property="og:see_also" content="http://localhost/posts/node-validator/"><meta property="og:see_also" content="http://localhost/posts/node-prisma/"><meta property="og:see_also" content="http://localhost/posts/node-sequelize/"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=123"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=123"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=123"><link rel=manifest href=/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=http://localhost/>SimFantasy</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/archive/ title=Archive>Archive</a></li><li><a href=/series/ title=Note>Note</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Node 16 Egg</h1><h2 class=subheading></h2><span class=meta><div class=meta-item><i class="far fa-user-circle"></i> Simz</div><div class=meta-item><i class="far fa-calendar"></i> 2023-10-08</div><div class=meta-item><i class="fa fa-tag"></i>
<a href=/tags/egg/ title=Egg>Egg</a>
<a href=/tags/node/ title=Node>Node</a></div></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><code>egg.js</code>是阿里旗下基于<code>node.js</code>和<code>koa</code>是一个<code>node</code>企业级应用开发框架，可以帮助开发团队，和开发人员减少成本。
基于<code>koa2</code>、<code>es6</code>、<code>es7</code>使得<code>node</code>具有更有规范的开发模式，更低的学习成本、更优雅的代码、更少的维护成本。</p><h3 id=egg基础>Egg基础<a class=anchorjs-link href=#egg%e5%9f%ba%e7%a1%80></a></h3><h4 id=安装>安装<a class=anchorjs-link href=#%e5%ae%89%e8%a3%85></a></h4><p><code>egg</code>安装有多种方式，手动按照<code>egg</code>的目录结构手工搭建和使用脚手架工具生成对应的目录，下面使用脚手架的两种方式来安装<code>egg</code></p><h5 id=方法一>方法一<a class=anchorjs-link href=#%e6%96%b9%e6%b3%95%e4%b8%80></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>#创建目录</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>mkdir egg-demo <span style=color:#04a5e5;font-weight:700>&amp;&amp;</span> <span style=color:#04a5e5>cd</span> egg-demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic># 使用脚手架安装</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>npm init egg --type<span style=color:#04a5e5;font-weight:700>=</span>simple
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic># 安装依赖</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>pnpm i
</span></span></code></pre></div><h5 id=方法二>方法二<a class=anchorjs-link href=#%e6%96%b9%e6%b3%95%e4%ba%8c></a></h5><p>安装全局脚手架，通过脚手架安装</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>#安装egg全局脚手架</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>npm i egg-init -g
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic># 使用全局脚手架egg-init 安装</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>egg-init egg-demo --type<span style=color:#04a5e5;font-weight:700>=</span>simple
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic># 进入目录</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#04a5e5>cd</span> egg-demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic># 安装依赖</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>pnpm i
</span></span></code></pre></div><h5 id=方法三>方法三<a class=anchorjs-link href=#%e6%96%b9%e6%b3%95%e4%b8%89></a></h5><p>手动的方式配置</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic># 创建目录</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>mkdir egg-demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic># 进入目录</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#04a5e5>cd</span> egg-demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic># 初始化项目</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>pnpm init
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic># 安装egg</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>pnpm add egg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic># 安装egg-bin到开发环境</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>pnpm add egg-bin -D
</span></span></code></pre></div><h5 id=骨架类型说明>骨架类型说明<a class=anchorjs-link href=#%e9%aa%a8%e6%9e%b6%e7%b1%bb%e5%9e%8b%e8%af%b4%e6%98%8e></a></h5><table><thead><tr><th>骨架类型</th><th>说明</th></tr></thead><tbody><tr><td><code>simple</code></td><td>简单的<code>egg</code>项目骨架</td></tr><tr><td><code>empty</code></td><td>空的<code>egg</code>项目骨架</td></tr><tr><td><code>plugin</code></td><td><code>egg plugin</code>骨架</td></tr><tr><td><code>framework</code></td><td><code>egg framework</code>骨架</td></tr></tbody></table><h4 id=目录结构>目录结构<a class=anchorjs-link href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84></a></h4><p>egg是个约定优先的框架，所以目录结构就是约定之一</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>egg-project
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>├── package.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>├── app.js <span style=color:#9ca0b0;font-style:italic>#  用于自定义启动时的初始化工作，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>├── agent.js <span style=color:#9ca0b0;font-style:italic># egg 多进程初始化，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>├── app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>|   ├── router.js	<span style=color:#9ca0b0;font-style:italic># 用于配置 URL 路由规则</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>│   ├── controller <span style=color:#9ca0b0;font-style:italic># 用于解析用户的输入，处理后返回相应的结果</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>│   |   └── home.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>│   ├── service <span style=color:#9ca0b0;font-style:italic># 用于编写业务逻辑层，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>│   |   └── user.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>│   ├── model <span style=color:#9ca0b0;font-style:italic># 用于放置领域模型，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>│   |   └── User.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>│   ├── middleware <span style=color:#9ca0b0;font-style:italic>#用于编写中间件，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>│   |   └── response_time.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>│   ├── schedule <span style=color:#9ca0b0;font-style:italic># 用于定时任务，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>│   |   └── my_task.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>│   ├── public <span style=color:#9ca0b0;font-style:italic># 用于放置静态资源</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>│   |   └── reset.css
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>│   ├── view <span style=color:#9ca0b0;font-style:italic># 用于放置模板文件，可选</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>│   |   └── home.tpl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>│   └── extend <span style=color:#9ca0b0;font-style:italic># 用于框架的扩展</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>│       ├── helper.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>│       ├── request.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>│       ├── response.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>│       ├── context.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>│       ├── application.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>│       └── agent.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>├── config 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>|   ├── plugin.js <span style=color:#9ca0b0;font-style:italic># 用于配置需要加载的插件</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>|   ├── config.default.js <span style=color:#9ca0b0;font-style:italic># 用于编写配置文件</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>│   ├── config.prod.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>|   ├── config.test.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>|   ├── config.local.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>|   └── config.unittest.js <span style=color:#04a5e5;font-weight:700>(</span>可选<span style=color:#04a5e5;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>└── <span style=color:#04a5e5>test</span> <span style=color:#9ca0b0;font-style:italic># 用于单元测试</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>    ├── middleware
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>    |   └── response_time.test.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>    └── controller
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>        └── home.test.js
</span></span></code></pre></div><h4 id=基础结构>基础结构<a class=anchorjs-link href=#%e5%9f%ba%e7%a1%80%e7%bb%93%e6%9e%84></a></h4><p>使用方法三手动安装，并从最基础的结构进行配置，编写代码实现一个最基础的egg结构。</p><h5 id=目录结构-1>目录结构<a class=anchorjs-link href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>egg-example
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>├── app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>│   ├── controller
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>│   │   └── home.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>│   └── router.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>├── config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>│   └── config.default.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>└── package.json
</span></span></code></pre></div><h5 id=路由>路由<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	router.get(<span style=color:#40a02b>&#39;/&#39;</span>, controller.home.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><h5 id=控制器>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>class</span> HomeController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;Hello world&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> HomeController
</span></span></code></pre></div><h5 id=配置>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.keys <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;sim@egg-demo&#39;</span>
</span></span></code></pre></div><p>添加<code>dev</code>到<code>package.json</code>中</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  <span style=color:#8839ef>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    <span style=color:#8839ef>&#34;dev&#34;</span>: <span style=color:#40a02b>&#34;egg-bin dev&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><p>然后运行<code>pnpm dev</code>启动服务，访问：<code>http://localhost:7001</code></p><h4 id=核心概念>核心概念<a class=anchorjs-link href=#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5></a></h4><h5 id=约定>约定<a class=anchorjs-link href=#%e7%ba%a6%e5%ae%9a></a></h5><p><code>Egg</code>中使用了很多约定，包括对文件夹的约定、对文件名的约定等等，这些约定的存在，减少了大量的配置。</p><p>在Koa中我们需要在router文件中引入controller、middleware的各种函数、方法，但在egg中，会自动通过约定的方式指定对应的controller目录下的文件中的方法。比如上的示例中，路由中引入的是controller目录下的home.js文件中的index方法。不需要我们来引入对应的文件而可以直接进行配置。</p><h5 id=运行流程>运行流程<a class=anchorjs-link href=#%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>graph LR
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>run(egg-bin dev)--&gt;generate(生成配置)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>generate(生成配置)--&gt;start(启动egg)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>request(请求到达)--&gt;match(匹配路由)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>match--&gt;action(请求处理)
</span></span></code></pre></div><ul><li>生成配置：<code>egg</code>会在启动时读取<code>config</code>文件夹中的配置，以及<code>app/router.js</code>中的路由信息，然后将最终的配置生成到<code>run</code>文件夹中</li><li>启动<code>egg</code>：<code>egg</code>会在内部创建<code>Koa</code>实例，并作出适当的初始化工作，然后监听<code>7001</code>端口（默认）</li><li>匹配路由：egg在内部使用了<code>@koa/router</code>，会根据路由表中请求的路径和方法，把请求交给指定的<code>action</code>进行处理</li><li>请求处理：egg遵循<code>MVC</code>模式请求始终是交给<code>Controller</code>中的<code>Action</code>进行处理<ul><li><code>Controller</code>表现为一个类，继承自<code>egg</code>中的<code>Controller</code></li><li><code>Action</code>表现为一个<code>Controller</code>中的实例方法，用于处理请求</li></ul></li></ul><h3 id=路由router>路由(Router)<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1router></a></h3><p><code>Router</code> 主要用来描述请求 <code>URL</code> 和具体承担执行动作的 <code>Controller</code> 的对应关系， 框架约定了 <code>app/router.js</code> 文件用于统一所有路由规则。</p><p>通过统一的配置，我们可以避免路由规则逻辑散落在多个地方，从而出现未知的冲突，集中在一起我们可以更方便的来查看全局的路由规则。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>graph LR
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>客户端--&gt;|请求|服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>服务器--&gt;egg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>egg--&gt;|路由匹配|创建controller对象
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>创建controller对象--&gt;运行action
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>运行action--&gt;|响应|客户端
</span></span></code></pre></div><h4 id=定义路由>定义路由<a class=anchorjs-link href=#%e5%ae%9a%e4%b9%89%e8%b7%af%e7%94%b1></a></h4><p><code>app/router.js</code> 里面定义 URL 路由规则</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic>// app对象是全局对象，跨越所有请求，它在egg启动后就会创建
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  <span style=color:#9ca0b0;font-style:italic>// app.router：通过 new Router 创建的路由对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#9ca0b0;font-style:italic>// app.controller: 根据 app/controller 文件夹中的文件创建的对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>  router.get(<span style=color:#40a02b>&#39;/user/:id&#39;</span>, controller.user.info);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>  <span style=color:#9ca0b0;font-style:italic>// 等价上面的写法 router.get(&#39;/user/:id&#39;, &#34;user.info&#34;);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span><span style=color:#9ca0b0;font-style:italic></span>};
</span></span></code></pre></div><p><code>app/controller</code> 目录下面实现 <code>Controller</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>class</span> UserController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#8839ef>async</span> info() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    <span style=color:#8839ef>const</span> { ctx } <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>    ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>      name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`hello </span><span style=color:#40a02b>${</span>ctx.params.id<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>    };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>}
</span></span></code></pre></div><h4 id=路由的详细定义>路由的详细定义<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1%e7%9a%84%e8%af%a6%e7%bb%86%e5%ae%9a%e4%b9%89></a></h4><p>路由的完整定义</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>router.verb(<span style=color:#40a02b>&#39;router-name&#39;</span>, <span style=color:#40a02b>&#39;path-match&#39;</span>, middleware1, ..., middlewareN, app.controller.action);
</span></span></code></pre></div><p>路由完整的定义分为5个部分：</p><ul><li><p><strong><code>verb</code></strong>：用户触发动作，支持 <code>get</code>，<code>post</code> 等所有 <code>HTTP</code> 方法</p><ul><li><code>router.head</code> - <code>HEAD</code></li><li><code>router.options</code> - <code>OPTIONS</code></li><li><code>router.get</code> - <code>GET</code></li><li><code>router.put</code> - <code>PUT</code></li><li><code>router.post</code> - <code>POST</code></li><li><code>router.patch</code> - <code>PATCH</code></li><li><code>router.delete</code> - <code>DELETE</code></li><li><code>router.del</code> - 由于 <code>delete</code> 是一个保留字，所以提供了一个 <code>delete</code> 方法的别名。</li><li><code>router.redirect</code> - 可以对 <code>URL</code> 进行重定向处理，比如我们最经常使用的可以把用户访问的根目录路由到某个主页</li></ul></li><li><p><code>router-name</code> 给路由设定一个别名，可以通过 Helper 提供的辅助函数 <code>pathFor</code> 和 <code>urlFor</code> 来生成 <code>URL</code>。(可选)</p></li><li><p><code>path-match</code> - 路由 <code>URL</code> 路径。</p></li><li><p><code>middleware1</code> - 在 <code>Router</code> 里面可以配置多个 <code>Middleware</code>。(可选)</p></li><li><p><code>controller</code> - 指定路由映射到的具体的 <code>controller</code> 上，<code>controller</code> 可以有两种写法：</p><ul><li><code>app.controller.user.fetch</code> - 直接指定一个具体的 <code>controller</code></li><li><code>'user.fetch'</code> - 可以简写为字符串形式</li></ul></li></ul><h5 id=注意事项>注意事项<a class=anchorjs-link href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9></a></h5><blockquote><ul><li>在 <code>Router</code> 定义中， 可以支持多个 <code>Middleware</code> 串联执行</li><li><code>Controller</code> 必须定义在 <code>app/controller</code> 目录中。</li><li>一个文件里面也可以包含多个 <code>Controller</code> 定义，在定义路由的时候，可以通过 <code>${fileName}.${functionName}</code> 的方式指定对应的 <code>Controller</code>。</li><li><code>Controller</code> 支持子目录，在定义路由的时候，可以通过 <code>${directoryName}.${fileName}.${functionName}</code> 的方式指定对应的 <code>Controller</code>。</li></ul></blockquote><h4 id=重定向>重定向<a class=anchorjs-link href=#%e9%87%8d%e5%ae%9a%e5%90%91></a></h4><p>在访问路由时，跳转到内部的另外一个路由上</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>router.get(<span style=color:#40a02b>&#39;/&#39;</span>, controller.home.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>router.redirect(<span style=color:#40a02b>&#39;/index&#39;</span>, <span style=color:#40a02b>&#39;/&#39;</span>)
</span></span></code></pre></div><h4 id=控制器在子目录>控制器在子目录<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8%e5%9c%a8%e5%ad%90%e7%9b%ae%e5%bd%95></a></h4><p>假设控制器在<code>app/controller/user/auth</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>router.get(<span style=color:#40a02b>&#39;/users/login&#39;</span>, controller.users.auth.login)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic>// 或者
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span>router.get(<span style=color:#40a02b>&#39;/users/login&#39;</span>, <span style=color:#40a02b>&#39;users.auth.login&#39;</span>)
</span></span></code></pre></div><h4 id=restful-风格的-url-定义>RESTful 风格的 URL 定义<a class=anchorjs-link href=#restful-%e9%a3%8e%e6%a0%bc%e7%9a%84-url-%e5%ae%9a%e4%b9%89></a></h4><p>如果想通过 <code>RESTful</code> 的方式来定义路由，<code>egg</code>提供了 <code>app.router.resources('routerName', 'pathMatch', controller)</code> 快速在一个路径上生成 <code>CRUD</code> 路由结构。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	router.resources(<span style=color:#40a02b>&#39;users&#39;</span>, <span style=color:#40a02b>&#39;/users&#39;</span>, controller.users)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><p>以上的<code>router.resources</code>代码的结果类似：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>router.get(<span style=color:#40a02b>&#34;users&#34;</span>, <span style=color:#40a02b>&#34;/users&#34;</span>, controller.users.index); <span style=color:#9ca0b0;font-style:italic>// 获取所有用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>router.get(<span style=color:#40a02b>&#34;new_user&#34;</span>, <span style=color:#40a02b>&#34;/users/new&#34;</span>, controller.users.<span style=color:#8839ef>new</span>); <span style=color:#9ca0b0;font-style:italic>// 获取添加用户的表单页面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span>router.get(<span style=color:#40a02b>&#34;user&#34;</span>, <span style=color:#40a02b>&#34;/users/:id&#34;</span>, controller.users.show); <span style=color:#9ca0b0;font-style:italic>// 获取某用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>router.get(<span style=color:#40a02b>&#34;edit_user&#34;</span>, <span style=color:#40a02b>&#34;/users/:id/edit&#34;</span>, controller.users.edit); <span style=color:#9ca0b0;font-style:italic>// 获取某个用户的编辑界面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>router.post(<span style=color:#40a02b>&#34;users&#34;</span>, <span style=color:#40a02b>&#34;/users&#34;</span>, controller.users.create); <span style=color:#9ca0b0;font-style:italic>// 添加用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>router.put(<span style=color:#40a02b>&#34;user&#34;</span>, <span style=color:#40a02b>&#34;/users/:id&#34;</span>, controller.users.update); <span style=color:#9ca0b0;font-style:italic>// 修改用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic></span>router.<span style=color:#8839ef>delete</span>(<span style=color:#40a02b>&#34;user&#34;</span>, <span style=color:#40a02b>&#34;/users/:id&#34;</span>, controller.users.destroy); <span style=color:#9ca0b0;font-style:italic>// 删除用户
</span></span></span></code></pre></div><p>上面的代码在<code>/user</code>路由上部署了一组<code>CRUD</code>结构的路由，对应的<code>controller</code>为<code>app/controller/user.js</code>，只需要在<code>user.js</code>里实现对应的方法即可。</p><table><thead><tr><th>Method</th><th>Path</th><th>Route Name</th><th>Controller.Action</th></tr></thead><tbody><tr><td><code>GET</code></td><td><code>/users</code></td><td><code>users</code></td><td><code>app.controllers.users.index</code></td></tr><tr><td><code>GET</code></td><td><code>/users/new</code></td><td><code>new_user</code></td><td><code>app.controllers.users.new</code></td></tr><tr><td><code>GET</code></td><td><code>/users/:id</code></td><td><code>user</code></td><td><code>app.controllers.users.show</code></td></tr><tr><td><code>GET</code></td><td><code>/users/:id/edit</code></td><td><code>edit_user</code></td><td><code>app.controllers.users.edit</code></td></tr><tr><td><code>POST</code></td><td><code>/users</code></td><td><code>users</code></td><td><code>app.controllers.users.create</code></td></tr><tr><td><code>PUT</code></td><td><code>/users/:id</code></td><td><code>user</code></td><td><code>app.controllers.users.update</code></td></tr><tr><td><code>DELETE</code></td><td><code>/users/:id</code></td><td><code>user</code></td><td><code>app.controllers.users.destroy</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/users.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>class</span> UserController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle users list&#39;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#8839ef>async</span> <span style=color:#8839ef>new</span>() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;new user page&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#8839ef>async</span> edit() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;edit user page&#39;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	<span style=color:#8839ef>async</span> show() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle user detail&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#8839ef>async</span> create() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle create user&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	<span style=color:#8839ef>async</span> update() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle update user&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	<span style=color:#8839ef>async</span> destroy() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle destroy user&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> UserController
</span></span></code></pre></div><blockquote><p>如果不需要其中的某几个方法，可以不用在 <code>users.js</code> 里面实现，这样对应 <code>URL</code> 路径也不会注册到 <code>Router</code>。</p></blockquote><h4 id=路由映射过多>路由映射过多<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1%e6%98%a0%e5%b0%84%e8%bf%87%e5%a4%9a></a></h4><p>不建议把路由规则逻辑散落在多个地方，会给排查问题带来困扰。</p><h5 id=按页面拆分路由>按页面拆分路由<a class=anchorjs-link href=#%e6%8c%89%e9%a1%b5%e9%9d%a2%e6%8b%86%e5%88%86%e8%b7%af%e7%94%b1></a></h5><p>若确实有需求，可以如下拆分：</p><h6 id=路由入口>路由入口<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1%e5%85%a5%e5%8f%a3></a></h6><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	require(<span style=color:#40a02b>&#39;./router/users&#39;</span>)(app)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	require(<span style=color:#40a02b>&#39;./router/posts&#39;</span>)(app)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><h6 id=拆分的路由>拆分的路由<a class=anchorjs-link href=#%e6%8b%86%e5%88%86%e7%9a%84%e8%b7%af%e7%94%b1></a></h6><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router/users.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> {router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	router.get(<span style=color:#40a02b>&#39;/users&#39;</span>, controller.users.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	router.get(<span style=color:#40a02b>&#39;/users/:userId&#39;</span>, controller.users.show)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic>// app/router/posts.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  <span style=color:#8839ef>const</span> {router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	router.get(<span style=color:#40a02b>&#39;/posts&#39;</span>, controller.posts.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	router.get(<span style=color:#40a02b>&#39;/posts/:postId&#39;</span>, controller.posts.show)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>}
</span></span></code></pre></div><h6 id=控制器-1>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-1></a></h6><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/users.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>class</span> UserController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#8839ef>async</span> index() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle users list&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> show() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle user detail&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> UserController
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/posts.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#8839ef>class</span> PostController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	<span style=color:#8839ef>async</span> index() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle posts list&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	<span style=color:#8839ef>async</span> show() { <span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;handle post detail&#39;</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> PostController
</span></span></code></pre></div><h5 id=按模块拆分路由推荐>按模块拆分路由（推荐）<a class=anchorjs-link href=#%e6%8c%89%e6%a8%a1%e5%9d%97%e6%8b%86%e5%88%86%e8%b7%af%e7%94%b1%e6%8e%a8%e8%8d%90></a></h5><p>实现了按模块拆分路由，并且可以配置多级路由前缀，更推荐使用此方法</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> routemapper <span style=color:#04a5e5;font-weight:700>=</span> {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> rootPrefix <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;/api&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>routemapper.usermapper <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	<span style=color:#8839ef>const</span> prefix <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>rootPrefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/users`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	router.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/`</span>, controller.users.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	router.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/:userId`</span>, controller.users.show)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>routemapper.postmapper <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>	<span style=color:#8839ef>const</span> prefix <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>rootPrefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/posts`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>	router.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/`</span>, controller.posts.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	router.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/:userId`</span>, controller.posts.show)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>	<span style=color:#04a5e5>Object</span>.values(routemapper).forEach(mapper =&gt; mapper(app))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>}
</span></span></code></pre></div><h3 id=插件>插件<a class=anchorjs-link href=#%e6%8f%92%e4%bb%b6></a></h3><p><code>egg</code>本身其实只是搭建了一个框架，拥有一套规范，更多的额外功能都是靠各种插件完成的。</p><h4 id=插件的命名>插件的命名<a class=anchorjs-link href=#%e6%8f%92%e4%bb%b6%e7%9a%84%e5%91%bd%e5%90%8d></a></h4><p>egg插件的命名规范为<code>egg-*</code>。比如，静态资源映射的插件名称为<code>egg-static</code>。</p><h4 id=插件的启用>插件的启用<a class=anchorjs-link href=#%e6%8f%92%e4%bb%b6%e7%9a%84%e5%90%af%e7%94%a8></a></h4><p>安装好插件后，默认是没有启动该插件的，需要在<code>config/plugin.js</code>中启用插件。</p><p>启用插件有三种方式：</p><p>使用统一导出方式配置，格式：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  插件名称<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    enable<span style=color:#04a5e5;font-weight:700>:</span> 是否启用,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    <span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> 插件在node_modules中的包名,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>    path<span style=color:#04a5e5;font-weight:700>:</span> 插件的绝对路径<span style=color:#d20f39>，</span>与package配置互斥
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>}
</span></span></code></pre></div><p>使用单独导出方式配置，格式：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.插件名称 <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  enable<span style=color:#04a5e5;font-weight:700>:</span> 是否启用,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> 插件在node_modules中的包名,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  path<span style=color:#04a5e5;font-weight:700>:</span> 插件的绝对路径<span style=color:#d20f39>，</span>与package配置互斥
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><p>如果是内置插件，则可以直接配置是否启用</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.插件名称 <span style=color:#04a5e5;font-weight:700>=</span> 是否启用
</span></span></code></pre></div><h4 id=静态资源>静态资源<a class=anchorjs-link href=#%e9%9d%99%e6%80%81%e8%b5%84%e6%ba%90></a></h4><p>默认情况下，<code>app/public</code>目录为静态资源目录，请求路径<code>/public/*</code>中<code>*</code>位置对应的请求将被映射到<code>app/public</code>目录。<code>egg</code>之所以能够映射静态资源，并非它本身具有这样的能力，而是它在内部使用了插件<code>egg-static</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>https://github.com/eggjs/egg-static
</span></span></code></pre></div><p>以下插件示例都使用该插件作为示例说明。</p><p>egg默认是启用静态资源这个插件的，但是可以通过配置进行关闭</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/plugin.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.<span style=color:#8839ef>static</span> <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  <span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;egg-static&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic>// 或者
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.<span style=color:#8839ef>static</span> <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>false</span>
</span></span></code></pre></div><h4 id=插件的配置>插件的配置<a class=anchorjs-link href=#%e6%8f%92%e4%bb%b6%e7%9a%84%e9%85%8d%e7%bd%ae></a></h4><p><code>config/plugin.js</code>只是控制插件的启用和关闭，对于插件的配置需要在<code>config/config.default.js</code>中完成</p><p>这样做的逻辑理念是：集中配置，集中管理。不同的插件有不同的配置，需要阅读插件的官方文档。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.<span style=color:#8839ef>static</span> <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>	prefix<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 设置静态目录为 根目录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span>}
</span></span></code></pre></div><h3 id=模板引擎-view>模板引擎 (View)<a class=anchorjs-link href=#%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e-view></a></h3><p>框架内置 <code>egg-view</code> 作为模板解决方案，并支持多模板渲染，每个模板引擎都以插件的方式引入，但保持渲染的 <code>API</code> 一致。</p><h4 id=引入-view-插件>引入 view 插件<a class=anchorjs-link href=#%e5%bc%95%e5%85%a5-view-%e6%8f%92%e4%bb%b6></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add egg<span style=color:#04a5e5;font-weight:700>-</span>view<span style=color:#04a5e5;font-weight:700>-</span>nunjucks
</span></span></code></pre></div><blockquote><p>插件地址：<a href=https://github.com/eggjs/egg-view-nunjucks target=_blank>egg-view-nunjucks</a></p><p>nunjucks模板引擎官网：<a href=https://mozilla.github.io/nunjucks/ target=_blank>nunjucks</a></p></blockquote><h4 id=启用插件>启用插件<a class=anchorjs-link href=#%e5%90%af%e7%94%a8%e6%8f%92%e4%bb%b6></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/plugin.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.nunjucks <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	<span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg-view-nunjucks&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><h4 id=配置模板引擎>配置模板引擎<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae%e6%a8%a1%e6%9d%bf%e5%bc%95%e6%93%8e></a></h4><p><code>egg</code>启用后，会自动加载插件<code>egg-view</code>，<code>egg-view</code>会读取配置中的<code>view</code>配置，来使用你指定的模板引擎</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic>// 该配置会被 egg-view 读取
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.view <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  root<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;app/view&#34;</span>, <span style=color:#9ca0b0;font-style:italic>// 告诉egg-view到哪里去寻找模板，多个绝对路径使用逗号分割，默认 /app/view，默认不需要配置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>  cache<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 是否在启动时缓存模板路径，以提高效率，默认开启
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>  mapping<span style=color:#04a5e5;font-weight:700>:</span> { <span style=color:#9ca0b0;font-style:italic>// 映射配置，将不同的模板后缀映射到对应的模板引擎处理
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>    <span style=color:#40a02b>&#34;.tpl&#34;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;nunjucks&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    <span style=color:#40a02b>&#34;.html&#34;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;nunjucks&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  defaultViewEngine<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;nunjucks&#34;</span>, <span style=color:#9ca0b0;font-style:italic>//如果映射找不到对应的模板引擎，将使用该值作为默认使用的模板引擎
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>  defaultExtension<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;.tpl&#34;</span>, <span style=color:#9ca0b0;font-style:italic>//后续在controller中渲染模板时，默认渲染的模板后缀名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>}
</span></span></code></pre></div><h4 id=渲染页面>渲染页面<a class=anchorjs-link href=#%e6%b8%b2%e6%9f%93%e9%a1%b5%e9%9d%a2></a></h4><p>配置好模板引擎后，即可在<code>app/view</code>中书写各种模板。当某个请求到达后，如果需要经过模板渲染页面，只需要在<code>action</code>中使用对应代码即可。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>  router.get(<span style=color:#40a02b>&#39;/news&#39;</span>, <span style=color:#40a02b>&#39;home.news&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>class</span> HomeController <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#8839ef>async</span> news() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    <span style=color:#9ca0b0;font-style:italic>// 渲染模板文件, 并赋值给 ctx.body
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;index.html&#39;</span>, { title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;服务端渲染模板&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>    <span style=color:#9ca0b0;font-style:italic>// 渲染模板文件, 仅返回不赋值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>// this.ctx.body = await this.ctx.renderView(&#39;index.html&#39;, { title: &#39;服务端渲染模板renderView&#39; })
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		<span style=color:#9ca0b0;font-style:italic>// 渲染模板字符串, 仅返回不赋值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>// this.ctx.body = await this.ctx.renderString(&#39;&lt;h1&gt;{{ title }}&lt;/h1&gt;&#39;, { title: &#39;服务端渲染模板renderString&#39; })
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> HomeController
</span></span></code></pre></div><h3 id=mvc示例>MVC示例<a class=anchorjs-link href=#mvc%e7%a4%ba%e4%be%8b></a></h3><p>通过MVC的方式实现一个简单的示例，示例需要实现：</p><ul><li>通过模板渲染首页、登录页</li><li>首页需要登录才能进入，通过Cookie中的token值，向服务器获取当前用户信息</li><li>登录后获取到服务端的token保存到Cookie中</li><li>登录如出错，需要返回服务端的错误信息</li></ul><p>示例使用<code>egg-view-nunjucks</code>作为模板引擎</p><h4 id=配置-1>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae-1></a></h4><p>配置模板引擎插件，开启</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/plugin.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.nunjucks <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	<span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg-view-nunjucks&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><p>配置<code>keys</code>、<code>view</code>、关闭<code>security</code>中的<code>csrf</code>（无法让表单进行跳转）和自定义服务器<code>baseUrl</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.keys <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;sim@demo_mvc&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>exports.view <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	defaultViewEngine<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;nunjucks&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	cache<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	mapping<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#40a02b>&#39;.html&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;nunjucks&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	csrf<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>exports.$baseUrl <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;http://localhost:5712/api&#39;</span>
</span></span></code></pre></div><p>在<code>app.js</code>中引入安装好的<code>axios</code>，将<code>axios</code>挂载到<code>app</code>上，在其他地方使用时不需要再进行引用，直接使用<code>this.app.axios</code>就可以了。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	app.axios <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;axios&#39;</span>).<span style=color:#8839ef>default</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>}
</span></span></code></pre></div><h4 id=路由-1>路由<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1-1></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	<span style=color:#9ca0b0;font-style:italic>// 首页
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>	router.get(<span style=color:#40a02b>&#39;/&#39;</span>, controller.home.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>	<span style=color:#9ca0b0;font-style:italic>// 登录页
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic></span>	router.get(<span style=color:#40a02b>&#39;/login&#39;</span>, controller.user.login)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>	router.post(<span style=color:#40a02b>&#39;/login&#39;</span>, controller.user.handleLogin)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>}
</span></span></code></pre></div><h4 id=模板>模板<a class=anchorjs-link href=#%e6%a8%a1%e6%9d%bf></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!-- app/view/layout.html --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>&lt;<span style=color:#8839ef>html</span> <span style=color:#1e66f5>lang</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	&lt;<span style=color:#8839ef>head</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>		&lt;<span style=color:#8839ef>meta</span> <span style=color:#1e66f5>charset</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;UTF-8&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		&lt;<span style=color:#8839ef>meta</span> <span style=color:#1e66f5>http-equiv</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;X-UA-Compatible&#34;</span> <span style=color:#1e66f5>content</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;IE=edge&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		&lt;<span style=color:#8839ef>meta</span> <span style=color:#1e66f5>name</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;viewport&#34;</span> <span style=color:#1e66f5>content</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;width=device-width, initial-scale=1.0&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		&lt;<span style=color:#8839ef>title</span>&gt;{% block title %}{%endblock%}&lt;/<span style=color:#8839ef>title</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		&lt;<span style=color:#8839ef>link</span> <span style=color:#1e66f5>rel</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;stylesheet&#34;</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/css/base.css&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		&lt;<span style=color:#8839ef>link</span> <span style=color:#1e66f5>rel</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;stylesheet&#34;</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/css/layout.css&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		{% block css %} {% endblock%}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	&lt;/<span style=color:#8839ef>head</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	&lt;<span style=color:#8839ef>body</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		&lt;<span style=color:#8839ef>header</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			&lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;logo&#34;</span>&gt;Título&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			&lt;<span style=color:#8839ef>nav</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;nav&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>				&lt;<span style=color:#8839ef>li</span>&gt;&lt;<span style=color:#8839ef>a</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/&#34;</span>&gt;home&lt;/<span style=color:#8839ef>a</span>&gt;&lt;/<span style=color:#8839ef>li</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>				&lt;<span style=color:#8839ef>li</span>&gt;&lt;<span style=color:#8839ef>a</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/login&#34;</span>&gt;login&lt;/<span style=color:#8839ef>a</span>&gt;&lt;/<span style=color:#8839ef>li</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			&lt;/<span style=color:#8839ef>nav</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>		&lt;/<span style=color:#8839ef>header</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>		&lt;<span style=color:#8839ef>main</span>&gt;{% block main %}{% endblock %}&lt;/<span style=color:#8839ef>main</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		&lt;<span style=color:#8839ef>footer</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>			&lt;<span style=color:#8839ef>section</span>&gt;footer&lt;/<span style=color:#8839ef>section</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		&lt;/<span style=color:#8839ef>footer</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>	&lt;/<span style=color:#8839ef>body</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>&lt;/<span style=color:#8839ef>html</span>&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!-- app/view/home.html --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>{% extends &#34;./layout.html&#34; %} {% block css %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>&lt;<span style=color:#8839ef>link</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/css/home.css&#34;</span> <span style=color:#1e66f5>rel</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;stylesheet&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>{%endblock%} {% block title %} {{title}} {%endblock%} {% block main %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>&lt;<span style=color:#8839ef>h1</span>&gt;Home Page&lt;/<span style=color:#8839ef>h1</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>&lt;<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	&lt;<span style=color:#8839ef>label</span>&gt;Username:&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	&lt;<span style=color:#8839ef>div</span>&gt;{{ username }}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>&lt;<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	&lt;<span style=color:#8839ef>label</span>&gt;Email:&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	&lt;<span style=color:#8839ef>div</span>&gt;{{ email }}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>{% endblock %}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!-- app/view/login.html --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>{% extends &#34;./layout.html&#34; %} {% block css %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>&lt;<span style=color:#8839ef>link</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/css/login.css&#34;</span> <span style=color:#1e66f5>rel</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;stylesheet&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>{%endblock%} {% block title %} {{title}} {%endblock%}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>{% block main %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>&lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;login-main&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;login-box&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;login-box-header&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>      &lt;<span style=color:#8839ef>h3</span>&gt;登录&lt;/<span style=color:#8839ef>h3</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    &lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    &lt;<span style=color:#8839ef>form</span> <span style=color:#1e66f5>action</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/login&#34;</span> <span style=color:#1e66f5>method</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;post&#34;</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;login-box-body&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>      &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;form-group&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>        &lt;<span style=color:#8839ef>label</span> <span style=color:#1e66f5>for</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;username&#34;</span>&gt;邮箱&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>        &lt;<span style=color:#8839ef>input</span> <span style=color:#1e66f5>type</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;text&#34;</span> <span style=color:#1e66f5>name</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;email&#34;</span> <span style=color:#1e66f5>placeholder</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;请输入邮箱&#34;</span> <span style=color:#1e66f5>value</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;{{ email }}&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>      &lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>      &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;form-group&#34;</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>        &lt;<span style=color:#8839ef>label</span> <span style=color:#1e66f5>for</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;password&#34;</span>&gt;密码&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>        &lt;<span style=color:#8839ef>input</span> <span style=color:#1e66f5>type</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;password&#34;</span> <span style=color:#1e66f5>name</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;password&#34;</span> <span style=color:#1e66f5>placeholder</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;请输入密码&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>      &lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>      &lt;<span style=color:#8839ef>button</span> <span style=color:#1e66f5>type</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;submit&#34;</span>&gt;登录&lt;/<span style=color:#8839ef>button</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>    &lt;/<span style=color:#8839ef>form</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>    {% if error %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>    &lt;<span style=color:#8839ef>div</span> <span style=color:#1e66f5>class</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;login-error&#34;</span>&gt;{{ error }}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>    {% endif %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>  &lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>&lt;<span style=color:#8839ef>script</span> <span style=color:#1e66f5>src</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/js/login.js&#34;</span>&gt;&lt;/<span style=color:#8839ef>script</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>{% endblock %}
</span></span></code></pre></div><p>通过js来控制当在<code>input</code>中输入内容时，移除<code>.login-error</code>服务端发送过来的验证错误信息。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/public/js/login.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> inputs <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#04a5e5>document</span>.querySelectorAll(<span style=color:#40a02b>&#39;input&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>for</span> (<span style=color:#8839ef>const</span> inp <span style=color:#8839ef>of</span> inputs) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	inp.oninput <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#d20f39>function</span> () {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> err <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#04a5e5>document</span>.querySelector(<span style=color:#40a02b>&#39;.login-error&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>if</span> (err) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			err.remove()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span></code></pre></div><h4 id=控制器-2>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-2></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Home Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#9ca0b0;font-style:italic>// 从Cookie中获取token
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.cookies.get(<span style=color:#40a02b>&#39;token&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		<span style=color:#9ca0b0;font-style:italic>// 当没有获取到token，则跳转到登录页
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			<span style=color:#8839ef>this</span>.ctx.redirect(<span style=color:#40a02b>&#39;/login&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#9ca0b0;font-style:italic>// 如果有获取到Cookie中的token，在请求当前用户信息时，在请求头中添加authorization，携带上token信息
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.app.axios.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.config.$baseUrl<span style=color:#40a02b>}</span><span style=color:#40a02b>/user`</span>, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>			headers<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>				authorization<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`Bearer </span><span style=color:#40a02b>${</span>token<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		<span style=color:#9ca0b0;font-style:italic>// 将获得到的用户名和邮箱定义到model中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span><span style=color:#9ca0b0;font-style:italic></span>		model.username <span style=color:#04a5e5;font-weight:700>=</span> result.data.user.username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		model.email <span style=color:#04a5e5;font-weight:700>=</span> result.data.user.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>		<span style=color:#9ca0b0;font-style:italic>// 渲染model到home.html页面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;home.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#9ca0b0;font-style:italic>// 渲染登录页面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> login() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Login Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			error<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;login.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  <span style=color:#9ca0b0;font-style:italic>// 处理登录信息
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> handleLogin() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>    <span style=color:#9ca0b0;font-style:italic>// 获取服务端登录地址
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> url <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.config.$baseUrl<span style=color:#40a02b>}</span><span style=color:#40a02b>/users/login`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    <span style=color:#9ca0b0;font-style:italic>// 配置model信息，email为登录页面提交过来的email
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Login Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>			error<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.ctx.request.body.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>      <span style=color:#9ca0b0;font-style:italic>// 发起请求
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.app.axios.post(url, <span style=color:#8839ef>this</span>.ctx.request.body)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>			<span style=color:#9ca0b0;font-style:italic>// 从返回的dat中获取user.token值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> result.data.user.token
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>      <span style=color:#9ca0b0;font-style:italic>// 设置token值到Cookie
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>this</span>.ctx.cookies.set(<span style=color:#40a02b>&#39;token&#39;</span>, token)<span style=color:#d20f39>‘</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>      <span style=color:#9ca0b0;font-style:italic>// 跳转页面到首页
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>this</span>.ctx.redirect(<span style=color:#40a02b>&#39;/&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>		} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>			<span style=color:#9ca0b0;font-style:italic>// 如果请求错误，则返回错误信息中的response.data.message中的内容，并复制到model.error上
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span><span style=color:#9ca0b0;font-style:italic></span>			model.error <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#04a5e5>Object</span>.values(error.response.data.message)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>				.map(item =&gt; item[<span style=color:#fe640b>0</span>])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>				.join(<span style=color:#40a02b>&#39;&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>		<span style=color:#9ca0b0;font-style:italic>// 携带返回的错误信息，重新渲染登录页面
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;login.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>}
</span></span></code></pre></div><h3 id=中间件>中间件<a class=anchorjs-link href=#%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h3><p>在<code>egg</code>中编写<code>koa</code>的中间件，需要满足一定的规范。在实际开发中，绝大部分中间件都是通过一个高阶函数得到的。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#d20f39>var</span> myMiddleware <span style=color:#04a5e5;font-weight:700>=</span> (options) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  <span style=color:#8839ef>return</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span>(ctx, next){
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic>// 使用
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span><span style=color:#9ca0b0;font-style:italic></span>myMiddleware(配置对象); <span style=color:#9ca0b0;font-style:italic>// 得到一个中间件
</span></span></span></code></pre></div><h4 id=定义中间件>定义中间件<a class=anchorjs-link href=#%e5%ae%9a%e4%b9%89%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h4><p><code>egg</code>秉承了这种思想，并把它当做规范使用</p><ul><li>需要在<code>app/middleware</code>文件夹中编写中间件</li><li>需要将中间件写成一个存函数，传入<code>options</code>和<code>app</code></li></ul><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/middleware/mymid.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (options, app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#9ca0b0;font-style:italic>// options是针对该中间件的配置，app是egg全局应用对象，在使用中间件时，需要根据中间件的类型来传入对应的配置和全局对象。
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>return</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span>(ctx, next){
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>    console.log(<span style=color:#40a02b>&#34;中间件开始&#34;</span>, options);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>    <span style=color:#8839ef>await</span> next();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>    console.log(<span style=color:#40a02b>&#34;中间件结束&#34;</span>, options)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>}
</span></span></code></pre></div><h4 id=使用中间件>使用中间件<a class=anchorjs-link href=#%e4%bd%bf%e7%94%a8%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h4><p>在<code>egg</code>中，中间件的使用也是遵循规范的，它的使用分为两种，分别是<strong>全局</strong>和<strong>局部</strong></p><h5 id=全局中间件>全局中间件<a class=anchorjs-link href=#%e5%85%a8%e5%b1%80%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h5><p>全局中间件会在<strong>所有</strong>控制器处理之前运行，按照<code>egg</code>统一配置的原则，需要在<code>config/config.default.js</code>中配置中间件。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic>// 配置全局中间件，数组中的字符串对应 app/middleware 中的文件名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic>// 数组中的顺序对应中间件的运行顺序
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.middleware <span style=color:#04a5e5;font-weight:700>=</span> [<span style=color:#40a02b>&#34;mymid&#34;</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// mymid 对应中间件的配置，该配置会传递到中间件的options参数中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.middleware <span style=color:#04a5e5;font-weight:700>=</span> [<span style=color:#40a02b>&#39;mymid&#39;</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>exports.mymid <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	a<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;abc&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	b<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;bcd&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 开启中间件，默认开启，可以不写，写了会显示在在options中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>	match<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/login&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 当路由字符串中包含&#39;/login&#39;字符串的
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>}
</span></span></code></pre></div><p>在中间件的配置中，有一部分是通用配置，通用配置会影响<code>egg</code>是否运行中间件，通用配置包括：</p><ul><li><code>enable</code>：<code>boolean</code>，是否启用中间件</li><li><code>match</code> 和 <code>ignore</code>，分别表示匹配和忽略，它们均支持多种类型的配置方式<ul><li>字符串：当参数为字符串类型时，配置的是一个 <code>url</code> 的路径前缀，所有以配置的字符串作为前缀的 <code>url</code> 都会匹配上。 当然，你也可以直接使用字符串数组。</li><li>正则：当参数为正则时，直接匹配满足正则验证的 <code>url</code> 的路径。</li><li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（<code>true/false</code>）来判断是否匹配。</li></ul></li></ul><h5 id=路由中间件>路由中间件<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h5><p>有些中间件并不需要全局使用，而是仅仅针对某个或某几个路由使用。此时，就不需要在<code>config/config.default.js</code>进行配置了，而是在路由中进行配置。</p><p>示例：</p><p>使用之前mvc示例中的token鉴权，将鉴权部分提取出来放到中间件，然后在路由中使用。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/middleware/verifyAuth.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (options, app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	<span style=color:#8839ef>return</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span> (ctx, next) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> ctx.cookies.get(<span style=color:#40a02b>&#39;token&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			ctx.redirect(<span style=color:#40a02b>&#39;/login&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> app.axios.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>app.config.$baseUrl<span style=color:#40a02b>}</span><span style=color:#40a02b>/user`</span>, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			headers<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>				authorization<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`Bearer </span><span style=color:#40a02b>${</span>token<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		<span style=color:#9ca0b0;font-style:italic>// 将获取到的user信息挂载到ctx.user上
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		ctx.user <span style=color:#04a5e5;font-weight:700>=</span> result.data.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>		<span style=color:#8839ef>await</span> next()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>}
</span></span></code></pre></div><blockquote><p>注意：</p><ul><li>之前通过<code>this</code>来获取的<code>app</code>、<code>config</code>、<code>ctx</code>，需要去掉对应的<code>this</code></li><li><code>config</code>，需要从导入的<code>app</code>中获取</li></ul></blockquote><p>调整通过<code>this.ctx.user</code>来获取通过中间件拿到的对应的用户信息</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Home Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		<span style=color:#8839ef>if</span> (user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			model.username <span style=color:#04a5e5;font-weight:700>=</span> user.username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			model.email <span style=color:#04a5e5;font-weight:700>=</span> user.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;home.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>}
</span></span></code></pre></div><p>路由中间件需要手动导入对应的参数</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.sj
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#9ca0b0;font-style:italic>// 拿到中间件并传入响应的options和app
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>const</span> verifyAuth <span style=color:#04a5e5;font-weight:700>=</span> app.middleware.verifyAuth({}, app)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	router.get(<span style=color:#40a02b>&#39;/&#39;</span>, verifyAuth, controller.home.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	router.get(<span style=color:#40a02b>&#39;/login&#39;</span>, controller.user.login)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	router.post(<span style=color:#40a02b>&#39;/login&#39;</span>, controller.user.handleLogin)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span></code></pre></div><h5 id=内置中间件>内置中间件<a class=anchorjs-link href=#%e5%86%85%e7%bd%ae%e4%b8%ad%e9%97%b4%e4%bb%b6></a></h5><p><code>egg</code>提供了一些内置的中间件，可通过<code>app.config.coreMiddlewares</code>查看，这些内置中间件将会和自定义的中间件配置合并，最终形成一个真正的中间件函数数组：<code>app.middleware</code>，真正起作用的是该数组中的函数</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>[
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  [AsyncFunction<span style=color:#04a5e5;font-weight:700>:</span> meta] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;meta&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  [AsyncFunction<span style=color:#04a5e5;font-weight:700>:</span> siteFile] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;siteFile&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  [AsyncFunction<span style=color:#04a5e5;font-weight:700>:</span> notfound] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;notfound&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  [<span style=color:#04a5e5>Function</span> (anonymous)] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;static&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  [AsyncFunction<span style=color:#04a5e5;font-weight:700>:</span> bodyParser] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;bodyParser&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>  [<span style=color:#04a5e5>Function</span><span style=color:#04a5e5;font-weight:700>:</span> overrideMethod] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;overrideMethod&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  [AsyncFunction<span style=color:#04a5e5;font-weight:700>:</span> session] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;session&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  [<span style=color:#04a5e5>Function</span> (anonymous)] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;securities&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  [<span style=color:#04a5e5>Function</span><span style=color:#04a5e5;font-weight:700>:</span> i18n] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;i18n&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  [AsyncFunction (anonymous)] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;eggLoaderTrace&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  [<span style=color:#04a5e5>Function</span><span style=color:#04a5e5;font-weight:700>:</span> fn] { _name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;mymidmiddlewareWrapper&#39;</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>  [<span style=color:#04a5e5>Function</span><span style=color:#04a5e5;font-weight:700>:</span> dispatch] {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>    router<span style=color:#04a5e5;font-weight:700>:</span> EggRouter {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>      opts<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Object</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>      methods<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Array</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>      params<span style=color:#04a5e5;font-weight:700>:</span> {},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>      stack<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Array</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>      app<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Object</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>      head<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>      options<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>      get<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>      put<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>      patch<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>      post<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>      <span style=color:#8839ef>delete</span><span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>      all<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>Function</span> (anonymous)]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>]
</span></span></code></pre></div><h3 id=变量locals>变量(Locals)<a class=anchorjs-link href=#%e5%8f%98%e9%87%8flocals></a></h3><p>在渲染页面的过程中，通常需要一个变量来收集需要传递给模板的变量，在<code>egg</code>里面，提供了 <code>app.locals</code> 和 <code>ctx.locals</code>。</p><ul><li><code>app.locals</code> 为全局的，一般在 <code>app.js</code> 里面配置全局变量。</li><li><code>ctx.locals</code> 为单次请求的，会合并 <code>app.locals</code>。</li><li>可以直接赋值对象，框架在对应的 <code>setter</code> 里面会自动 <code>merge</code>。</li></ul><h4 id=示例>示例<a class=anchorjs-link href=#%e7%a4%ba%e4%be%8b></a></h4><ul><li>在<code>app.locals</code>中设置一个站点名称，在模板的title中显示</li><li>将中间件中获取到的用户信息，挂载到<code>ctx.locals</code>中</li></ul><h5 id=全局变量>全局变量<a class=anchorjs-link href=#%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 设置全局变量
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>	app.locals <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>		globalTitle<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Título&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>	app.axios <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;axios&#39;</span>).<span style=color:#8839ef>default</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>}
</span></span></code></pre></div><p>在模板页面直接使用全局变量</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>// app/view/layout.html
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>&lt;<span style=color:#8839ef>title</span>&gt;{% block title %}{%endblock%} - {{ globalTitle }}&lt;/<span style=color:#8839ef>title</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>...
</span></span></code></pre></div><h5 id=局部变量>局部变量<a class=anchorjs-link href=#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/middleware/verifyAuth.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (options, app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	<span style=color:#8839ef>return</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span> (ctx, next) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> ctx.cookies.get(<span style=color:#40a02b>&#39;token&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			ctx.redirect(<span style=color:#40a02b>&#39;/login&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> app.axios.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>app.config.$baseUrl<span style=color:#40a02b>}</span><span style=color:#40a02b>/user`</span>, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			headers<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>				authorization<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`Bearer </span><span style=color:#40a02b>${</span>token<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		<span style=color:#9ca0b0;font-style:italic>// 将获取到的user信息挂载到局部变量ctx.locals.user上
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		ctx.locals.user <span style=color:#04a5e5;font-weight:700>=</span> result.data.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    <span style=color:#9ca0b0;font-style:italic>// ctx.user = result.data.user
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>		<span style=color:#8839ef>await</span> next()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>}
</span></span></code></pre></div><p>在控制器中也不需要多余的导入和判断了</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Home Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#9ca0b0;font-style:italic>// username: &#39;&#39;,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#9ca0b0;font-style:italic>// email: &#39;&#39;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		<span style=color:#9ca0b0;font-style:italic>// const user = this.ctx.user
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>// if (user) {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>//	 model.username = user.username
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>//	 model.email = user.email
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>// }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;home.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>}
</span></span></code></pre></div><p>修改下模板中的数据直接从局部变量<code>ctx.locals.user</code>中获取</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!-- app/view/home.html --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>{% extends &#34;./layout.html&#34; %} {% block css %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>&lt;<span style=color:#8839ef>link</span> <span style=color:#1e66f5>href</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;/public/css/home.css&#34;</span> <span style=color:#1e66f5>rel</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;stylesheet&#34;</span> /&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>{%endblock%} {% block title %} {{title}} {%endblock%} {% block main %}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>&lt;<span style=color:#8839ef>h1</span>&gt;Home Page&lt;/<span style=color:#8839ef>h1</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>&lt;<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	&lt;<span style=color:#8839ef>label</span>&gt;Username:&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#9ca0b0;font-style:italic>&lt;!-- &lt;div&gt;{{ username }}&lt;/div&gt; --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  &lt;<span style=color:#8839ef>div</span>&gt;{{ user.username }}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>&lt;<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	&lt;<span style=color:#8839ef>label</span>&gt;Email:&lt;/<span style=color:#8839ef>label</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	<span style=color:#9ca0b0;font-style:italic>&lt;!-- &lt;div&gt;{{ email }}&lt;/div&gt; --&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>  &lt;<span style=color:#8839ef>div</span>&gt;{{ user.email }}&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>&lt;/<span style=color:#8839ef>div</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>{% endblock %}
</span></span></code></pre></div><h3 id=服务-service>服务 (Service)<a class=anchorjs-link href=#%e6%9c%8d%e5%8a%a1-service></a></h3><p><code>Service</code> 就是在复杂业务场景下用于做业务逻辑封装的一个抽象层，提供这个抽象有以下几个好处：</p><ul><li>保持 <code>Controller</code> 中的逻辑更加简洁。</li><li>保持业务逻辑的独立性，抽象出来的 <code>Service</code> 可以被多个 <code>Controller</code> 重复调用。</li><li>将逻辑和展现分离，更容易编写测试用例</li></ul><h4 id=创建service>创建Service<a class=anchorjs-link href=#%e5%88%9b%e5%bb%baservice></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/service/article.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Service } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Service {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> getArticles() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> url <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.app.config.$baseUrl<span style=color:#40a02b>}</span><span style=color:#40a02b>/articles`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.app.axios.get(url)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#8839ef>return</span> result.data.articles
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span></code></pre></div><ul><li><code>service</code>模块必须放到<code>app/service</code>目录中</li><li><code>service</code>模块必须导出一个继承自<code>Service</code>的类</li><li><code>egg</code>会在<strong>每次请求</strong>到达后创建该类的实例</li><li>父类<code>Service</code>中包含了下面的属性：<ul><li><code>this.ctx</code>: 当前请求的上下文 <code>Context</code> 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。</li><li><code>this.app</code>: 当前应用 <code>Application</code> 对象的实例，通过它我们可以拿到框架提供的全局对象和方法。</li><li><code>this.service</code>：应用定义的 <code>Service</code>，通过它我们可以访问到其他业务层，等价于 <code>this.ctx.service</code> 。</li><li><code>this.config</code>：应用运行时的配置项。</li><li><code>this.logger</code>：<code>logger</code> 对象，上面有四个方法（<code>debug</code>，<code>info</code>，<code>warn</code>，<code>error</code>），分别代表打印四个不同级别的日志，使用方法和效果与 <code>context logger</code> 中介绍的一样，但是通过这个 <code>logger</code> 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</li></ul></li></ul><h4 id=使用service>使用Service<a class=anchorjs-link href=#%e4%bd%bf%e7%94%a8service></a></h4><p>每次请求到达后，<code>egg</code>会实例化所有的<code>Service</code>，并保存到<code>context.service</code>中</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/constroller/home.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> model <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Home Page&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			articles<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.service.article.getArticles()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;home.html&#39;</span>, model)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>}
</span></span></code></pre></div><blockquote><p>不仅仅在<code>controller</code>中可以使用<code>service</code>，在<code>service</code>中也可以通过 <code>thix.ctx.service</code> 获取其他的<code>service</code></p></blockquote><p>为了让使用更加方便，<code>egg</code>定义了别名，在<code>controller</code>和<code>service</code>中均可以使用下面的方式更加简单的获取<code>this.service</code></p><h3 id=数据库>数据库<a class=anchorjs-link href=#%e6%95%b0%e6%8d%ae%e5%ba%93></a></h3><p>官方维护的 ORM 模型是基于 <a href=https://leoric.js.org/zh target=_blank>Leoric</a> 实现的 <a href=https://github.com/eggjs/egg-orm/blob/master/Readme.zh-CN.md target=_blank>egg-orm</a>，目前可用的数据库插件：</p><ul><li><a href=https://github.com/eggjs/egg-orm/blob/master/Readme.zh-CN.md target=_blank>egg-orm</a></li><li><a href=https://github.com/eggjs/egg-sequelize target=_blank>egg-sequelize</a></li><li><a href=https://github.com/eggjs/egg-mongoose target=_blank>egg-mongoose</a></li><li><a href=https://github.com/eggjs/egg-mysql target=_blank>egg-mysql</a>，可查看 <a href=https://www.eggjs.org/zh-CN/tutorials/mysql target=_blank>MySQL 教程</a></li><li><a href=https://github.com/eggjs/egg-graphql target=_blank>egg-graphql</a></li></ul><h4 id=示例-1>示例<a class=anchorjs-link href=#%e7%a4%ba%e4%be%8b-1></a></h4><p>使用<code>egg-mongoose</code>来实现一个简单的用户注册、登录、查询</p><h5 id=安装-1>安装<a class=anchorjs-link href=#%e5%ae%89%e8%a3%85-1></a></h5><p>安装<code>egg-mongoose</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add egg-mongoose
</span></span></code></pre></div><h5 id=配置-2>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae-2></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/plugin.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.mongoose <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>	enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>	<span style=color:#8839ef>package</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg-mongoose&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.keys <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;sim@egg_2023&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>exports.mongoose <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>	url<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;mongodb://127.0.0.1:27017/egg_test&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>	options<span style=color:#04a5e5;font-weight:700>:</span> {},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>	plugins<span style=color:#04a5e5;font-weight:700>:</span> []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>}
</span></span></code></pre></div><h5 id=模型>模型<a class=anchorjs-link href=#%e6%a8%a1%e5%9e%8b></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/model/User.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	<span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> app.mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#8839ef>const</span> { Schema, model } <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>				required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>				unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>				trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>				required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>				unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>				trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>			password<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>				required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>				<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>				<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/public/images/default_avatar.jpg&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>		{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			timestamp<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>	)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	userSchema.methods.toUserJson <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#d20f39>function</span> () {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>		<span style=color:#8839ef>return</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">47</span><span>	<span style=color:#8839ef>return</span> model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">48</span><span>}
</span></span></code></pre></div><p>如果需要在model中引入其他的model，则需要按照以下的方式调整</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/model/User.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 从app中导出数据库定义的model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>const</span> { mongoose, model } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#8839ef>const</span> { Article } <span style=color:#04a5e5;font-weight:700>=</span> model
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	<span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Schema(...)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#9ca0b0;font-style:italic>// 为了避免命名冲突，这里使用monngse.model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>return</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span></code></pre></div><h5 id=路由-2>路由<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1-2></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> routesmapper <span style=color:#04a5e5;font-weight:700>=</span> {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> rootPrefix <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;/api&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>routesmapper.usermapper <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#8839ef>const</span> prefix <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>rootPrefix<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	router.post(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/users`</span>, controller.user.create)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	router.post(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/users/login`</span>, controller.user.login)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	router.get(<span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>prefix<span style=color:#40a02b>}</span><span style=color:#40a02b>/users`</span>, controller.user.getUsers)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	<span style=color:#04a5e5>Object</span>.values(routesmapper).forEach(mapper =&gt; mapper(app))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span></code></pre></div><h5 id=控制器-3>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-3></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/contorller/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#9ca0b0;font-style:italic>// 注册
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> create() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.create(userInfo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> user.toUserJson()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	<span style=color:#9ca0b0;font-style:italic>// 登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> login() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.findOne({ email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>400</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>				message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户不存在&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>		<span style=color:#8839ef>if</span> (user.password <span style=color:#04a5e5;font-weight:700>!==</span> userInfo.password) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>			<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>400</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>				message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码错误&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> user.toUserJson()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>	<span style=color:#9ca0b0;font-style:italic>// 获取所有用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> getUsers() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>		<span style=color:#8839ef>const</span> users <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.find().sort({ _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5;font-weight:700>-</span><span style=color:#fe640b>1</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> users.map(user =&gt; user.toUserJson())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>}
</span></span></code></pre></div><h3 id=运行环境>运行环境<a class=anchorjs-link href=#%e8%bf%90%e8%a1%8c%e7%8e%af%e5%a2%83></a></h3><p>一个 Web 应用本身应该是无状态的，并拥有根据运行环境设置自身的能力。</p><h4 id=指定运行环境>指定运行环境<a class=anchorjs-link href=#%e6%8c%87%e5%ae%9a%e8%bf%90%e8%a1%8c%e7%8e%af%e5%a2%83></a></h4><p><code>egg</code>框架有两种方式指定运行环境：</p><ol><li><p>通过 <code>config/env</code> 文件指定，该文件的内容就是运行环境，如 <code>prod</code>。一般通过构建工具来生成这个文件。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>// config/env
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>prod
</span></span></code></pre></div></li><li><p>通过 <code>EGG_SERVER_ENV</code> 环境变量指定运行环境更加方便，比如在生产环境启动应用：<strong>（推荐此方式）</strong></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// package.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#8839ef>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>		<span style=color:#8839ef>&#34;dev&#34;</span>: <span style=color:#40a02b>&#34;egg-bin dev&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>		<span style=color:#8839ef>&#34;prod&#34;</span>: <span style=color:#40a02b>&#34;EGG_SERVER_ENV=prod egg-bin dev&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>}
</span></span></code></pre></div></li></ol><h4 id=获取运行环境>获取运行环境<a class=anchorjs-link href=#%e8%8e%b7%e5%8f%96%e8%bf%90%e8%a1%8c%e7%8e%af%e5%a2%83></a></h4><p><code>egg</code>框架提供了变量 <code>app.config.env</code> 来表示应用当前的运行环境。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  console.log(app.config.env)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>}
</span></span></code></pre></div><p>若没有指定<code>config/env</code>文件，同时也没有指定<code>EGG_SERVER_ENV</code>环境变量，<code>app.config.env</code>的值由<code>NODE_ENV</code>确定</p><p>确定的方式如下：</p><table><thead><tr><th>NODE_ENV</th><th>EGG_SERVER_ENV</th><th>说明</th></tr></thead><tbody><tr><td>其他</td><td>local</td><td>本地开发环境</td></tr><tr><td>test</td><td>unittest</td><td>单元测试</td></tr><tr><td>production</td><td>prod</td><td>生产环境</td></tr></tbody></table><h4 id=针对环境变量的配置>针对环境变量的配置<a class=anchorjs-link href=#%e9%92%88%e5%af%b9%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%9a%84%e9%85%8d%e7%bd%ae></a></h4><p><code>egg</code>支持下面这些配置</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>config
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>|- config.default.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>|- config.prod.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>|- config.unittest.js
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>|- config.local.js
</span></span></code></pre></div><p><code>config.default.js</code> 为默认的配置文件，所有环境都会加载这个配置文件，一般也会作为开发环境的默认配置文件。</p><p>当指定 <code>env</code> 时会同时加载对应的配置文件，并覆盖默认配置文件的同名配置。如 <code>prod</code> 环境会加载 <code>config.prod.js</code> 和 <code>config.default.js</code> 文件，<code>config.prod.js</code> 会覆盖 <code>config.default.js</code> 的同名配置</p><p>示例</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.cluster <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  listen<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>    port<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>7001</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.prod.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.cluster <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  listen<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    port<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>5000</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>};
</span></span></code></pre></div><p>当为<code>local</code>环境时，会使用默认配置7001端口，而当为<code>prod</code>环境时，会使用<code>prod</code>配置的5000端口</p><p>有的时候，可能需要自定义环境，比如开发阶段，不同的开发者可能使用的开发环境有差异，尽管这很少见。</p><p>如果是这种情况，可以设置<code>EGG_SERVER_ENV</code>为一个自定义的值，然后配置相应值的<code>config</code>文件即可</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// package.json
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#40a02b>&#34;scripts&#34;</span><span style=color:#04a5e5;font-weight:700>:</span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>      <span style=color:#40a02b>&#34;dev&#34;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;EGG_SERVER_ENV=yuanjin egg-bin dev&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.yuanjin.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.cluster <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  listen<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    port<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>6000</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>};
</span></span></code></pre></div><h3 id=应用部署>应用部署<a class=anchorjs-link href=#%e5%ba%94%e7%94%a8%e9%83%a8%e7%bd%b2></a></h3><p>服务器需要预装 <code>Node.js</code>，框架支持的 <code>Node</code> 版本为<code> >= 14.20.0</code>。</p><p>框架内置了 <code>egg-cluster</code> 来启动 <code>Master</code> 进程，<code>Master</code> 有足够的稳定性，不再需要使用 <code>pm2</code> 等进程守护模块。</p><h4 id=egg-cluster>egg-cluster<a class=anchorjs-link href=#egg-cluster></a></h4><p><code>egg</code>内置了一个插件<code>egg-cluster</code>，作用是在<code>egg</code>启动时，启动多个子进程。因此，<code>egg</code>实际上是运行在多个进程上的应用，这些进程的职责分别为：</p><ul><li><strong>主进程</strong>，<code>Master 进程</code>：稳定性极高的进程，主要负责管理其他进程。因此，对于<code>egg</code>应用，无须使用<code>pm2</code>等工具。</li><li><strong>worker进程</strong>：由主进程开启，通常情况下数量和<code>cpu</code>的核数保持一致。<code>worker</code>进程是真正用于处理请求的进程。某次请求具体交给哪个<code>worker</code>进程来处理由主进程调度</li><li><strong>Agent进程</strong>：由主进程在启动后开启，只有一个，相当于其他进程的秘书，通常用于做各种脏活累活，比如维持一个长连接。<code>agent</code>进程通常对开发者是隐形的，我们平时并不会接触它。</li></ul><h4 id=egg-scripts>egg-scripts<a class=anchorjs-link href=#egg-scripts></a></h4><p><code>egg-scripts</code>能够提供一些命令，来启动和停止线上环境</p><h5 id=安装-2>安装<a class=anchorjs-link href=#%e5%ae%89%e8%a3%85-2></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add egg-scripts
</span></span></code></pre></div><h5 id=配置脚本packagejson>配置脚本<code>package.json</code><a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae%e8%84%9a%e6%9c%acpackagejson></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  <span style=color:#8839ef>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    <span style=color:#8839ef>&#34;start&#34;</span>: <span style=color:#40a02b>&#34;egg-scripts start --daemon&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    <span style=color:#8839ef>&#34;stop&#34;</span>: <span style=color:#40a02b>&#34;egg-scripts stop&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>}
</span></span></code></pre></div><h5 id=运行>运行<a class=anchorjs-link href=#%e8%bf%90%e8%a1%8c></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm start <span style=color:#9ca0b0;font-style:italic># 启动</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>pnpm stop <span style=color:#9ca0b0;font-style:italic># 停止</span>
</span></span></code></pre></div><p>启动命令中支持以下参数：</p><ul><li><p><code>--title=name</code>，设置应用全名，默认为<code>egg-server-${APP_NAME}</code></p><ul><li><p>在停止时，建议指定停止的egg应用名称，否则，如果服务器运行了多个<code>egg</code>应用，将会停止所有的<code>egg</code>应用</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>egg-scripts stop --title=myegg-server
</span></span></code></pre></div></li></ul></li><li><p><code>--port=7001</code> 端口号，默认会读取环境变量 <code>process.env.PORT</code>，如未传递将使用框架内置端口 <code>7001</code>。</p></li><li><p><code>--daemon</code> 是否允许以守护进程的模式运行。</p></li><li><p><code>--env=prod</code> 框架运行环境，默认会读取环境变量 <code>process.env.EGG_SERVER_ENV</code>， 如未传递将使用框架内置环境 <code>prod</code>。</p></li><li><p><code>--workers=2</code> 框架 <code>worker</code> 线程数，默认会创建和 CPU 核数相当的 <code>app worker</code> 数，可以充分的利用 <code>CPU</code> 资源。</p></li><li><p><code>--https.key</code> 指定 <code>HTTPS</code> 所需密钥文件的完整路径。</p></li><li><p><code>--https.cert</code> 指定 <code>HTTPS</code> 所需证书文件的完整路径。</p></li></ul><h3 id=定时任务>定时任务<a class=anchorjs-link href=#%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1></a></h3><p>虽然我们通过框架开发的 <code>HTTP Server</code> 是请求响应模型的，但是仍然还会有许多场景需要执行一些定时任务，例如：</p><ol><li>定时上报应用状态。</li><li>定时从远程接口更新本地缓存。</li><li>定时进行文件切割、临时文件删除。</li></ol><p>尽管我们完全可以通过<code>setInterval</code>来处理该问题，但在<code>egg</code>中，可以非常简单的完成该操作，你只需要在<code>app/schedule</code>文件夹中编写各种任务即可</p><p><code>egg</code>启动后，会读取该文件夹中的所有模块，把它们的导出当做任务定期执行</p><h4 id=编写定时任务>编写定时任务<a class=anchorjs-link href=#%e7%bc%96%e5%86%99%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1></a></h4><h5 id=方法一-1>方法一<a class=anchorjs-link href=#%e6%96%b9%e6%b3%95%e4%b8%80-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/schedule/createUser.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Subscription } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Subscription {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#9ca0b0;font-style:italic>// 通过 schedule 属性来设置定时任务的执行间隔等配置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>static</span> get schedule() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>return</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			interval<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;10s&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 10秒间隔
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;all&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 指定所有的 worker 都需要执行
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	<span style=color:#9ca0b0;font-style:italic>// subscribe 是真正定时任务执行时被运行的函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> subscribe() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>		console.log(<span style=color:#40a02b>&#39;自动创建用户&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		<span style=color:#9ca0b0;font-style:italic>// 生成一个长度为2的随机36进制随机字符串作为用户名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> username <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#04a5e5>Math</span>.random().toString(<span style=color:#fe640b>36</span>).substring(<span style=color:#fe640b>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>username<span style=color:#40a02b>}</span><span style=color:#40a02b>@sim.com`</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>			password<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;123456&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.create(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>}
</span></span></code></pre></div><h5 id=方法二-1>方法二<a class=anchorjs-link href=#%e6%96%b9%e6%b3%95%e4%ba%8c-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  schedule<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>    interval<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;10s&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 10秒间隔
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>    type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;all&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 指定所有的 worker 都需要执行
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#8839ef>async</span> task(ctx) { <span style=color:#9ca0b0;font-style:italic>// task 是真正定时任务执行时被运行的函数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>    console.log(<span style=color:#40a02b>&#34;自动创建用户&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>`</span><span style=color:#40a02b>${</span>username<span style=color:#40a02b>}</span><span style=color:#40a02b>@sim.com`</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			password<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;123456&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    <span style=color:#8839ef>await</span> ctx.model.User.create(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>}
</span></span></code></pre></div><blockquote><p><strong>推荐使用方法一</strong>，可以直接使用<code>this</code>来获得<code>this.ctx</code>、<code>this.app</code>、<code>this.config</code>，在方法二中只能通过导入的<code>ctx</code>来获取，<code>ctx.app</code>、<code>ctx.app.config</code></p></blockquote><h4 id=schedule配置>schedule配置<a class=anchorjs-link href=#schedule%e9%85%8d%e7%bd%ae></a></h4><p>无论使用哪一种方式，都必须提供<code>schedule</code>属性来配置任务</p><ul><li><p><code>interval</code>：字符串，描述任务执行的间隔时间。参考：https://github.com/vercel/ms</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>ms(<span style=color:#40a02b>&#39;2 days&#39;</span>)  <span style=color:#9ca0b0;font-style:italic>// 172800000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;1d&#39;</span>)      <span style=color:#9ca0b0;font-style:italic>// 86400000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;10h&#39;</span>)     <span style=color:#9ca0b0;font-style:italic>// 36000000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;2.5 hrs&#39;</span>) <span style=color:#9ca0b0;font-style:italic>// 9000000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;2h&#39;</span>)      <span style=color:#9ca0b0;font-style:italic>// 7200000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;1m&#39;</span>)      <span style=color:#9ca0b0;font-style:italic>// 60000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;5s&#39;</span>)      <span style=color:#9ca0b0;font-style:italic>// 5000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;1y&#39;</span>)      <span style=color:#9ca0b0;font-style:italic>// 31557600000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;100&#39;</span>)     <span style=color:#9ca0b0;font-style:italic>// 100
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;-3 days&#39;</span>) <span style=color:#9ca0b0;font-style:italic>// -259200000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;-1h&#39;</span>)     <span style=color:#9ca0b0;font-style:italic>// -3600000
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>ms(<span style=color:#40a02b>&#39;-200&#39;</span>)    <span style=color:#9ca0b0;font-style:italic>// -200
</span></span></span></code></pre></div></li><li><p><code>cron</code>：字符串，任务执行的契机，它和<code>interval</code>设置一个即可。参考：https://github.com/harrisiirak/cron-parser</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#04a5e5;font-weight:700>*</span>    <span style=color:#04a5e5;font-weight:700>*</span>    <span style=color:#04a5e5;font-weight:700>*</span>    <span style=color:#04a5e5;font-weight:700>*</span>    <span style=color:#04a5e5;font-weight:700>*</span>    <span style=color:#04a5e5;font-weight:700>*</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#d20f39>┬</span>    <span style=color:#d20f39>┬</span>    <span style=color:#d20f39>┬</span>    <span style=color:#d20f39>┬</span>    <span style=color:#d20f39>┬</span>    <span style=color:#d20f39>┬</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#04a5e5;font-weight:700>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>└</span> 周 (<span style=color:#fe640b>0</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>7</span>, <span style=color:#fe640b>1</span>L <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>7</span>L) (<span style=color:#fe640b>0</span> or <span style=color:#fe640b>7</span> is Sun)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>└─────</span> 月 (<span style=color:#fe640b>1</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>12</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>└──────────</span> 日 (<span style=color:#fe640b>1</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>31</span>, L)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>│</span>    <span style=color:#d20f39>└───────────────</span> 时 (<span style=color:#fe640b>0</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>23</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span><span style=color:#d20f39>│</span>    <span style=color:#d20f39>└────────────────────</span> 分 (<span style=color:#fe640b>0</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>59</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span><span style=color:#d20f39>└─────────────────────────</span> 秒 (<span style=color:#fe640b>0</span> <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>59</span>, optional)
</span></span></code></pre></div><p>在线生成器：https://cron.qqe2.com/</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#40a02b>&#34;* */3 * * * * &#34;</span>  <span style=color:#9ca0b0;font-style:italic>// 每隔3分钟执行一次
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#40a02b>&#34;0 0 0 * * 3&#34;</span> <span style=color:#9ca0b0;font-style:italic>// 每周3的凌晨执行一次
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#40a02b>&#34;0 0 0 24 12 *&#34;</span> <span style=color:#9ca0b0;font-style:italic>// 每年圣诞节执行一次
</span></span></span></code></pre></div></li><li><p><code>type</code>，任务类型，支持两种配置：</p><ul><li><code>worker</code>，只有一个 worker 会执行这个定时任务，每次执行定时任务的 <code>worker</code> 的选择是随机的</li><li><code>all</code>，每个 <code>worker</code> 都会执行这个定时任务。</li></ul></li><li><p><code>immediate</code>，如果设置为<code>true</code>，应用启动时会立即执行该任务</p></li><li><p><code>env</code>，数组，只有在指定的环境中才会启动该任务</p></li><li><p><code>disable</code>，一个开关，表示任务是否被禁用</p></li></ul><blockquote><p>更多关于任务的操作参考：https://eggjs.org/zh-cn/basics/schedule.html</p></blockquote><h3 id=框架扩展>框架扩展<a class=anchorjs-link href=#%e6%a1%86%e6%9e%b6%e6%89%a9%e5%b1%95></a></h3><p><code>egg</code>框架提供了多种扩展点扩展自身的功能：</p><ul><li>Application</li><li>Context</li><li>Request</li><li>Response</li><li>Helper</li></ul><p>在开发中，我们既可以使用已有的扩展 <code>API</code> 来方便开发，也可以对以上对象进行自定义扩展，进一步加强框架的功能。</p><h4 id=application>Application<a class=anchorjs-link href=#application></a></h4><p><code>app</code> 对象指的是 <code>Koa</code> 的全局应用对象，全局只有一个，在应用启动时被创建。</p><h5 id=访问方式>访问方式<a class=anchorjs-link href=#%e8%ae%bf%e9%97%ae%e6%96%b9%e5%bc%8f></a></h5><ul><li><code>ctx.app</code></li><li><code>Controller</code>，<code>Middleware</code>，<code>Helper</code>，<code>Service</code> 中都可以通过 <code>this.app</code> 访问到 <code>Application</code> 对象，例如 <code>this.app.config</code> 访问配置对象。</li><li>在 <code>app.js</code> 中 <code>app</code> 对象会作为第一个参数注入到入口函数中</li></ul><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 使用 app 对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>}
</span></span></code></pre></div><h5 id=扩展方式>扩展方式<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e6%96%b9%e5%bc%8f></a></h5><p><code>egg</code>框架会把 <code>app/extend/application.js</code> 中定义的对象与 <code>Koa Application</code> 的 <code>prototype</code> 对象进行合并，在应用启动时会基于扩展后的 <code>prototype</code> 生成 <code>app</code> 对象。</p><h4 id=context>Context<a class=anchorjs-link href=#context></a></h4><p><code>Context</code> 指的是 <code>Koa</code> 的请求上下文，这是 <strong>请求级别</strong> 的对象，每次请求生成一个 <code>Context</code> 实例，通常我们也简写成 <code>ctx</code>。在所有的文档中，<code>Context</code> 和 <code>ctx</code> 都是指 <code>Koa</code> 的上下文对象。</p><h5 id=访问方式-1>访问方式<a class=anchorjs-link href=#%e8%ae%bf%e9%97%ae%e6%96%b9%e5%bc%8f-1></a></h5><ul><li><code>middleware</code> 中 <code>this</code> 就是 <code>ctx</code>，例如 <code>this.cookies.get('foo')</code>。</li><li><code>controller</code> 有两种写法，类的写法通过 <code>this.ctx</code>，方法的写法直接通过 <code>ctx</code> 入参。</li><li><code>helper</code>，<code>service</code> 中的 <code>this</code> 指向 <code>helper</code>，<code>service</code> 对象本身，使用 <code>this.ctx</code> 访问 <code>context</code> 对象，例如 <code>this.ctx.cookies.get('foo')</code>。</li></ul><blockquote><p>在<code>Context</code>中访问<code>config</code>中的配置，需要使用<code>this.app.config</code>来访问，在<code>Controller</code>中使用扩展的<code>context</code>中的方法时，可以使用<code>this.ctx</code>来使用对应的方法。</p></blockquote><h5 id=扩展方式-1>扩展方式<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e6%96%b9%e5%bc%8f-1></a></h5><p>框架会把 <code>app/extend/context.js</code> 中定义的对象与<code>Koa Context 的 prototype</code> 对象进行合并，在处理请求时会基于扩展后的 <code>prototype</code> 生成 <code>ctx</code> 对象。</p><h4 id=request>Request<a class=anchorjs-link href=#request></a></h4><p><code>Request</code> 对象和 <code>Koa</code> 的 <code>Request</code> 对象相同，是 <strong>请求级别</strong> 的对象，它提供了大量请求相关的属性和方法供使用。</p><h5 id=访问方式-2>访问方式<a class=anchorjs-link href=#%e8%ae%bf%e9%97%ae%e6%96%b9%e5%bc%8f-2></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>ctx.request;
</span></span></code></pre></div><p><code>ctx</code> 上的很多属性和方法都被代理到 <code>request</code> 对象上，对于这些属性和方法使用 <code>ctx</code> 和使用 <code>request</code> 去访问它们是等价的，例如 <code>ctx.url === ctx.request.url</code>。</p><p><code>Koa</code> 内置的代理 <code>request</code> 的属性和方法列表：<a href=http://koajs.com/#request-aliases target=_blank>Koa - Request aliases</a></p><h5 id=扩展方式-2>扩展方式<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e6%96%b9%e5%bc%8f-2></a></h5><p>框架会把 <code>app/extend/request.js</code> 中定义的对象与内置 <code>request</code> 的 <code>prototype</code> 对象进行合并，在处理请求时会基于扩展后的 <code>prototype</code> 生成 <code>request</code> 对象。</p><h4 id=response>Response<a class=anchorjs-link href=#response></a></h4><p><code>Response</code> 对象和 <code>Koa 的 Response</code> 对象相同，是 <strong>请求级别</strong> 的对象，它提供了大量响应相关的属性和方法供使用。</p><h5 id=访问方式-3>访问方式<a class=anchorjs-link href=#%e8%ae%bf%e9%97%ae%e6%96%b9%e5%bc%8f-3></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>ctx.response;
</span></span></code></pre></div><p><code>ctx</code> 上的很多属性和方法都被代理到 <code>response</code> 对象上，对于这些属性和方法使用 <code>ctx</code> 和使用 <code>response</code> 去访问它们是等价的，例如 <code>ctx.status = 404</code> 和 <code>ctx.response.status = 404</code> 是等价的。</p><p><code>Koa</code> 内置的代理 <code>response</code> 的属性和方法列表：<a href=http://koajs.com/#response-aliases target=_blank>Koa Response aliases</a></p><h5 id=扩展方式-3>扩展方式<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e6%96%b9%e5%bc%8f-3></a></h5><p><code>egg</code>框架会把 <code>app/extend/response.js</code> 中定义的对象与内置 <code>response</code> 的 <code>prototype</code> 对象进行合并，在处理请求时会基于扩展后的 <code>prototype</code> 生成 <code>response</code> 对象。</p><h4 id=helper>Helper<a class=anchorjs-link href=#helper></a></h4><p><code>Helper</code> 函数用来提供一些实用的 <code>utility</code> 函数。</p><p>它的作用在于我们可以将一些常用的动作抽离在 <code>helper.js</code> 里面成为一个独立的函数，这样可以用 <code>JavaScript</code> 来写复杂的逻辑，避免逻辑分散各处。另外还有一个好处是 <code>Helper</code> 这样一个简单的函数，可以让我们更容易编写测试用例。</p><p>框架内置了一些常用的 <code>Helper</code> 函数。我们也可以编写自定义的 <code>Helper</code> 函数。</p><blockquote><p>在<code>helper</code>扩展中访问<code>config</code>中的配置，可以直接使用<code>this.config</code>来访问，但在Controller中获取helper中的扩展方法时，则需要使用<code>this.ctx.helper</code>来获取对应的方法。</p></blockquote><h5 id=访问方式-4>访问方式<a class=anchorjs-link href=#%e8%ae%bf%e9%97%ae%e6%96%b9%e5%bc%8f-4></a></h5><p>通过 <code>ctx.helper</code> 访问到 <code>helper</code> 对象，例如：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// 假设在 app/router.js 中定义了 home routerapp.get(&#39;home&#39;, &#39;/&#39;, &#39;home.index&#39;);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic>// 使用 helper 计算指定 url pathctx.helper.pathFor(&#39;home&#39;, { by: &#39;recent&#39;, limit: 20 });// =&gt; /?by=recent&amp;limit=20
</span></span></span></code></pre></div><h5 id=扩展方式-4>扩展方式<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e6%96%b9%e5%bc%8f-4></a></h5><p>框架会把 <code>app/extend/helper.js</code> 中定义的对象与内置 <code>helper</code> 的 <code>prototype</code> 对象进行合并，在处理请求时会基于扩展后的 <code>prototype</code> 生成 <code>helper</code> 对象。</p><h4 id=扩展决策树>扩展决策树<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e5%86%b3%e7%ad%96%e6%a0%91></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>graph TD
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>opInContext[一定在请求处理中发生吗]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>opOfContext[继续确定扩展目标]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>setInRequest{{扩展request}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>setInResponse{{扩展response}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>setInContext{{扩展context}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>setInHelper{{扩展helper}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>setInApplication{{扩展application}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>opInContext--&gt;|是|opOfContext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>opOfContext--&gt;|获取请求中的信息|setInRequest
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>opOfContext--&gt;|设置响应中的信息|setInResponse
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>opOfContext--&gt;|其他|setInContext
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>opOfContext--&gt;|其他|setInHelper
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>opInContext--&gt;|否|setInApplication
</span></span></code></pre></div><h4 id=示例-2>示例<a class=anchorjs-link href=#%e7%a4%ba%e4%be%8b-2></a></h4><ul><li>使用扩展<code>helper</code>加密用户密码</li><li>使用扩展<code>context</code>生成<code>token</code>和验证<code>token</code></li></ul><h5 id=安装-3>安装<a class=anchorjs-link href=#%e5%ae%89%e8%a3%85-3></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add jsonwebtoken
</span></span></code></pre></div><h5 id=配置-3>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae-3></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	csrf<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>		enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic>// md5加密加盐
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.md5_salt <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;egg_2023&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic>// jwt 密钥和过期时间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.jwt <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	secret<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg_2023&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	expiresIn<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;1d&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>}
</span></span></code></pre></div><h5 id=扩展>扩展<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/extend/context.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> jwt <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;jsonwebtoken&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>async</span> jwtSign(payload) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>return</span> jwt.sign(payload, <span style=color:#8839ef>this</span>.app.config.jwt.secret, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			expiresIn<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.app.config.jwt.expiresIn
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	<span style=color:#8839ef>async</span> jwtVerify(token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		<span style=color:#8839ef>return</span> jwt.verify(token, <span style=color:#8839ef>this</span>.app.config.jwt.secret)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/extend/helper.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> crypto <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;crypto&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#9ca0b0;font-style:italic>// 加密
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> handleMd5(str) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> md5 <span style=color:#04a5e5;font-weight:700>=</span> crypto.createHash(<span style=color:#40a02b>&#39;md5&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#8839ef>return</span> md5.update(str <span style=color:#04a5e5;font-weight:700>+</span> <span style=color:#8839ef>this</span>.config.md5_salt).digest(<span style=color:#40a02b>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span></code></pre></div><h5 id=修改模型>修改模型<a class=anchorjs-link href=#%e4%bf%ae%e6%94%b9%e6%a8%a1%e5%9e%8b></a></h5><p>之前模型的methods不能返回token，这里需要根据是否传入token来显示。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/model/User.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>userSchema.methods.toUserJson <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#d20f39>function</span> (token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#8839ef>if</span> (token) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    <span style=color:#8839ef>return</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>      username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>      email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>      bio<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>      image<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>      token
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  } <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    <span style=color:#8839ef>return</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>      username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>      email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>      bio<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>      image<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>...
</span></span></code></pre></div><h5 id=控制器-4>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-4></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#9ca0b0;font-style:italic>// 注册
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> create() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#9ca0b0;font-style:italic>// 将密码加密后传入数据库
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>		userInfo.password <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.helper.handleMd5(userInfo.password)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.create(userInfo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> user.toUserJson()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	<span style=color:#9ca0b0;font-style:italic>// 登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> login() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.findOne({ email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>400</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>				message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户不存在&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		<span style=color:#8839ef>if</span> (user.password <span style=color:#04a5e5;font-weight:700>!==</span> userInfo.password) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>			<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>400</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>				message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码错误&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		<span style=color:#9ca0b0;font-style:italic>// 根据用户信息生成token
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.jwtSign({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> user._id,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> user.username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>		<span style=color:#9ca0b0;font-style:italic>// 将token传入model的实例方法中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> user.toUserJson(token)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>	<span style=color:#9ca0b0;font-style:italic>// 获取所有用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> getUsers() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>		<span style=color:#8839ef>const</span> users <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.find().sort({ _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5;font-weight:700>-</span><span style=color:#fe640b>1</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>		<span style=color:#8839ef>this</span>.ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> users.map(user =&gt; user.toUserJson())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">47</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">48</span><span>}
</span></span></code></pre></div><h3 id=日志>日志<a class=anchorjs-link href=#%e6%97%a5%e5%bf%97></a></h3><p>日志对于 <code>Web</code> 开发的重要性毋庸置疑，它对于监控应用的运行状态、问题排查等都有非常重要的意义。</p><p>框架内置了强大的企业级日志支持，由 <a href=https://github.com/eggjs/egg-logger target=_blank>egg-logger</a> 模块提供。</p><h4 id=日志路径>日志路径<a class=anchorjs-link href=#%e6%97%a5%e5%bf%97%e8%b7%af%e5%be%84></a></h4><p>默认情况下，日志保存在<code>根目录/logs/工程名</code>中。可以通过下面的配置自定义日志路径</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.${env}.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.logger <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  dir<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/path/to/your/custom/log/dir&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>};
</span></span></code></pre></div><blockquote><p>建议根据环境的不同配置不同的日志路径</p><p>开发环境可以保持不变</p><p>生产环境放到系统统一的日志目录中</p></blockquote><h4 id=日志分类>日志分类<a class=anchorjs-link href=#%e6%97%a5%e5%bf%97%e5%88%86%e7%b1%bb></a></h4><p>框架内置了几种日志，分别在不同的场景下使用：</p><table><thead><tr><th style=text-align:left>类别</th><th style=text-align:left>输出目标</th><th style=text-align:left>含义</th><th style=text-align:left>api</th></tr></thead><tbody><tr><td style=text-align:left><code>appLogger</code></td><td style=text-align:left><code>项目名-web.log</code></td><td style=text-align:left>应用相关日志，供应用开发者使用的日志。在绝大数情况下都在使用它</td><td style=text-align:left><code>ctx.logger</code>、<code>app.logger</code></td></tr><tr><td style=text-align:left><code>coreLogger</code></td><td style=text-align:left><code>egg-web.log</code></td><td style=text-align:left>框架内核、插件日志</td><td style=text-align:left><code>ctx.coreLogger</code>、<code>app.coreLogger</code></td></tr><tr><td style=text-align:left><code>errorLogger</code></td><td style=text-align:left><code>common-error.log</code></td><td style=text-align:left>实际一般不会直接使用它，任何 <code>logger</code> 的 <code>.error()</code> 调用输出的日志都会重定向到这里，重点通过查看此日志定位异常。</td><td style=text-align:left>详见日志级别</td></tr><tr><td style=text-align:left><code>agentLogger</code></td><td style=text-align:left><code>egg-agent.log</code></td><td style=text-align:left>进程日志，框架和使用到 <code>agent</code> 进程执行任务的插件会打印一些日志到这里</td><td style=text-align:left><code>agent.logger</code></td></tr></tbody></table><p>无论使用哪个<code>api</code>记录日志，都会有对应的<strong>日志级别</strong>，分别是：</p><ul><li><code>日志对象.debug("some info")</code> ：记录调试信息</li><li><code>日志对象.info("some info")</code>：记录普通信息</li><li><code>日志对象.warn("some info")</code>： 记录警告信息</li><li><code>日志对象.error(new Error("some info"))</code>：记录错误信息，应该使用错误对象，否则无法得到堆栈信息</li></ul><h4 id=日志配置>日志配置<a class=anchorjs-link href=#%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae></a></h4><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.${env}.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic>// 配置文件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.logger <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#9ca0b0;font-style:italic>// 配置日志文件的目录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>  dir<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/var/logs/egg-logs&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#9ca0b0;font-style:italic>// 配置不同类别的日志对应的文件名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>  appLogName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;duyi-app-web.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  coreLogName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg-web.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  agentLogName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;egg-agent.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  errorLogName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;common-error.log&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  <span style=color:#9ca0b0;font-style:italic>// 配置哪些级别及其以上的日志要被记录到日志文件，设置为NONE则会关闭日志记录，默认为 INFO
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>  level<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;DEBUG&#39;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>  <span style=color:#9ca0b0;font-style:italic>// 配置哪些级别及其以上的日志要被打印到控制台，设置为NONE则会关闭日志记录，默认为 INFO
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>  consoleLevel<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;DEBUG&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>  <span style=color:#9ca0b0;font-style:italic>// 配置日志文件的编码，默认为 utf-8
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#9ca0b0;font-style:italic></span>  encoding<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;gbk&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>  <span style=color:#9ca0b0;font-style:italic>// 是否使用json格式记录日志，默认为false
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span><span style=color:#9ca0b0;font-style:italic></span>  outputJSON<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>};
</span></span></code></pre></div><h4 id=自定义日志>自定义日志<a class=anchorjs-link href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%97%a5%e5%bf%97></a></h4><p>使用自定义日志可以增加日志的类别</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.${env}.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic>// 配置文件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic>// 配置自定义日志类别
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.customLogger <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    myLogger<span style=color:#04a5e5;font-weight:700>:</span> { <span style=color:#9ca0b0;font-style:italic>// 属性名为类别名称
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>      file<span style=color:#04a5e5;font-weight:700>:</span> path.resolve(__dirname, <span style=color:#40a02b>&#34;../logs/my-logger.log&#34;</span>), <span style=color:#9ca0b0;font-style:italic>// 配置日志文件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>      <span style=color:#9ca0b0;font-style:italic>// 配置哪些级别及其以上的日志要被记录到日志文件，设置为NONE则会关闭日志记录，默认为 INFO
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>      level<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;DEBUG&#39;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>      <span style=color:#9ca0b0;font-style:italic>// 配置哪些级别及其以上的日志要被打印到控制台，设置为NONE则会关闭日志记录，默认为 INFO
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>      consoleLevel<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;DEBUG&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>      <span style=color:#9ca0b0;font-style:italic>// 配置日志文件的编码，默认为 utf-8
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>      encoding<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;gbk&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>      <span style=color:#9ca0b0;font-style:italic>// 是否使用json格式记录日志，默认为false
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>      outputJSON<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>      <span style=color:#9ca0b0;font-style:italic>// app logger
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#9ca0b0;font-style:italic></span>      formatter(meta) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>          <span style=color:#8839ef>return</span> <span style=color:#40a02b>`[</span><span style=color:#40a02b>${</span>meta.date<span style=color:#40a02b>}</span><span style=color:#40a02b>] </span><span style=color:#40a02b>${</span>meta.message<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>      <span style=color:#9ca0b0;font-style:italic>// ctx logger
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span><span style=color:#9ca0b0;font-style:italic></span>      contextFormatter(meta) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>          <span style=color:#8839ef>return</span> <span style=color:#40a02b>`[</span><span style=color:#40a02b>${</span>meta.date<span style=color:#40a02b>}</span><span style=color:#40a02b>] [</span><span style=color:#40a02b>${</span>meta.ctx.method<span style=color:#40a02b>}</span><span style=color:#40a02b> </span><span style=color:#40a02b>${</span>meta.ctx.url<span style=color:#40a02b>}</span><span style=color:#40a02b>] </span><span style=color:#40a02b>${</span>meta.message<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>}
</span></span></code></pre></div><p>记录自定义日志：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>app.getLogger(<span style=color:#40a02b>&#39;myLogger&#39;</span>) <span style=color:#9ca0b0;font-style:italic>// 获取全局应用日志对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>ctx.getLogger(<span style=color:#40a02b>&#39;myLogger&#39;</span>) <span style=color:#9ca0b0;font-style:italic>// 获取上下文日志对象
</span></span></span></code></pre></div><blockquote><p>schedule的日志就是一个自定义日志，日志类别名为<code>scheduleLogger</code></p></blockquote><blockquote><p>更多日志的功能参考：https://www.eggjs.org/zh-CN/core/logger</p></blockquote><h3 id=session>Session<a class=anchorjs-link href=#session></a></h3><p><code>Cookie</code> 在 <code>Web</code> 应用中经常承担标识请求方身份的功能，所以 <code>Web</code> 应用在 <code>Cookie</code> 的基础上封装了 <code>Session</code> 的概念，专门用做用户身份识别。</p><p><code>egg</code>框架内置了 <a href=https://github.com/eggjs/egg-session target=_blank>Session</a> 插件，提供了 <code>ctx.session</code> 来访问或者修改当前用户 <code>Session</code> 。<code>egg-session</code>插件在内部使用<code>koa-session</code>完成<code>session</code>功能。</p><h4 id=使用session>使用Session<a class=anchorjs-link href=#%e4%bd%bf%e7%94%a8session></a></h4><p><code>Session</code> 的使用方法非常直观，直接读取它或者修改它就可以了，如果要删除它，直接将它赋值为 <code>null</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 设置session
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>ctx.session.key <span style=color:#04a5e5;font-weight:700>=</span> value
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic>// 获取session
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> foo <span style=color:#04a5e5;font-weight:700>=</span> ctx.session.bar
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic>// 修改session
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>ctx.session.foo <span style=color:#04a5e5;font-weight:700>=</span> bar
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic>// 删除session
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>ctx.session.foo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>null</span>
</span></span></code></pre></div><p>需要 <strong>特别注意</strong> 的是：设置 <code>session</code> 属性时需要避免以下几种情况（会造成字段丢失，详见 <a href=https://github.com/koajs/session/blob/master/lib/session.js#L37-L47 target=_blank>koa-session</a> 源码）</p><ul><li>不要以 <code>_</code> 开头</li><li>不能为 <code>isNew</code></li></ul><h4 id=原理>原理<a class=anchorjs-link href=#%e5%8e%9f%e7%90%86></a></h4><p><code>koa-session</code>和普通<code>session</code>不同，它在默认情况下，是将<code>session</code>中保存的数据序列化后加密保存到客户端的<code>cookie</code>中</p><h5 id=传统的session处理模式>传统的<code>session</code>处理模式<a class=anchorjs-link href=#%e4%bc%a0%e7%bb%9f%e7%9a%84session%e5%a4%84%e7%90%86%e6%a8%a1%e5%bc%8f></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>sequenceDiagram
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>浏览器-&gt;&gt;服务器: 请求
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>activate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>Note right of 服务器: ctx.session.a = 1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>Note right of 服务器: 生成sid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>Note right of 服务器: 将数据保存到服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>deactivate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>服务器-&gt;&gt;浏览器: set-cookie:sid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>浏览器-&gt;&gt;服务器: 请求，附带cookie
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>activate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>Note right of 服务器: 通过sid获取到数据
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>Note right of 服务器: 获取到 ctx.session.a
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>deactivate 服务器
</span></span></code></pre></div><h5 id=egg-session的处理模式><code>egg-session</code>的处理模式<a class=anchorjs-link href=#egg-session%e7%9a%84%e5%a4%84%e7%90%86%e6%a8%a1%e5%bc%8f></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>sequenceDiagram
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>浏览器-&gt;&gt;服务器: 请求
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>activate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>Note right of 服务器: ctx.session.a = 1
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>Note right of 服务器: 序列化加密：xxxxxx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>deactivate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>服务器-&gt;&gt;浏览器: set-cookie:xxxxx
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>浏览器-&gt;&gt;服务器: 请求，附带cookie
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>activate 服务器
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>Note right of 服务器: 解密反序列化: {a:1}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>Note right of 服务器: 获取到 ctx.session.a
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>deactivate 服务器
</span></span></code></pre></div><h4 id=配置-4>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae-4></a></h4><p><code>Session</code> 的实现是基于 <code>Cookie</code> 的，默认配置下，用户 <code>Session</code> 的内容加密后直接存储在 <code>Cookie</code> 中的一个字段中，用户每次请求我们网站的时候都会带上这个 <code>Cookie</code>，我们在服务端解密后使用。<code>Session</code> 的默认配置如下：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.session <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  key<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;EGG_SESS&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// cookie的键
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span>  maxAge<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>24</span> <span style=color:#04a5e5;font-weight:700>*</span> <span style=color:#fe640b>3600</span> <span style=color:#04a5e5;font-weight:700>*</span> <span style=color:#fe640b>1000</span>, <span style=color:#9ca0b0;font-style:italic>// cookie的过期时间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>  httpOnly<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 该cookie是否仅允许http传输，不允许js获取
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>  encrypt<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 该cookie的内容是否要加密
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>  renew<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>, <span style=color:#9ca0b0;font-style:italic>// 是否每次请求后进一步延长cookie的过期时间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic></span>};
</span></span></code></pre></div><p>可以看到这些参数除了 <code>key</code> 都是 <code>Cookie</code> 的参数，<code>key</code> 代表了存储 <code>Session</code> 的 <code>Cookie</code> 键值对的 <code>key</code> 是什么。在默认的配置下，存放 <code>Session</code> 的 <code>Cookie </code>将会加密存储、不可被前端<code> js</code> 访问，这样可以保证用户的 <code>Session</code> 是安全的。</p><h4 id=扩展存储>扩展存储<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95%e5%ad%98%e5%82%a8></a></h4><p><code>Session</code> 默认存放在 <code>Cookie</code> 中，但是如果我们的 <code>Session</code> 对象过于庞大，就会带来一些额外的问题：</p><ul><li>前面提到，浏览器通常都有限制最大的 <code>Cookie</code> 长度，当设置的 <code>Session</code> 过大时，浏览器可能拒绝保存。</li><li><code>Cookie</code> 在每次请求时都会带上，当 <code>Session</code> 过大时，每次请求都要额外带上庞大的 <code>Cookie</code> 信息。</li></ul><p>框架提供了将 <code>Session</code> 存储到除了 <code>Cookie</code> 之外的其他存储的扩展方案，我们只需要设置 <code>app.sessionStore</code> 即可将 <code>Session</code> 存储到指定的存储中。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  app.sessionStore <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>    <span style=color:#9ca0b0;font-style:italic>// support promise / async
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>    <span style=color:#8839ef>async</span> get(key) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>      <span style=color:#9ca0b0;font-style:italic>// return value;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    <span style=color:#8839ef>async</span> set(key, value, maxAge) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>      <span style=color:#9ca0b0;font-style:italic>// set key to store
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    <span style=color:#8839ef>async</span> destroy(key) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>      <span style=color:#9ca0b0;font-style:italic>// destroy key
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>};
</span></span></code></pre></div><p><code>sessionStore</code> 的实现我们也可以封装到插件中，例如 <a href=https://github.com/eggjs/egg-session-redis target=_blank>egg-session-redis</a> 就提供了将 <code>Session</code> 存储到 <code>redis</code> 中的能力，在应用层，我们只需要引入 <a href=https://github.com/eggjs/egg-redis target=_blank>egg-redis</a> 和 <a href=https://github.com/eggjs/egg-session-redis target=_blank>egg-session-redis</a> 插件即可。</p><p>不推荐使用扩展存储。</p><blockquote><p>**注意：**一旦选择了将 Session 存入到外部存储中，就意味着系统将强依赖于这个外部存储，当它挂了的时候，我们就完全无法使用 Session 相关的功能了。因此我们更推荐大家只将必要的信息存储在 Session 中，保持 Session 的精简并使用默认的 Cookie 存储，用户级别的缓存不要存储在 Session 中。</p></blockquote><h4 id=官网示例>官网示例<a class=anchorjs-link href=#%e5%ae%98%e7%bd%91%e7%a4%ba%e4%be%8b></a></h4><ul><li><a href=https://www.eggjs.org/zh-CN/core/cookie-and-session#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7-session-%E5%A4%B1%E6%95%88%E6%97%B6%E9%97%B4 target=_blank>修改用户 Session 失效时间</a></li><li><a href=https://www.eggjs.org/zh-CN/core/cookie-and-session#%E5%BB%B6%E9%95%BF%E7%94%A8%E6%88%B7-session-%E6%9C%89%E6%95%88%E6%9C%9F target=_blank>延长用户 Session 有效期</a></li></ul><h3 id=异常处理>异常处理<a class=anchorjs-link href=#%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86></a></h3><p><code>egg</code>框架中保留了<code>koa</code>处理异常的方式，使用<code>app.on</code>的方式抛出错误<code>error</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (app) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  app.on(<span style=color:#40a02b>&#34;error&#34;</span>, (err, ctx) =&gt; { <span style=color:#9ca0b0;font-style:italic>// 和 koa 的异常处理类似
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>    console.log(err, ctx);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>  });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>};
</span></span></code></pre></div><h4 id=egg统一异常处理>egg统一异常处理<a class=anchorjs-link href=#egg%e7%bb%9f%e4%b8%80%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86></a></h4><p>框架通过 <a href=https://github.com/eggjs/egg-onerror target=_blank>onerror</a> 插件提供了统一的错误处理机制。对一个请求的所有处理方法（<code>Middleware</code>、<code>Controller</code>、<code>Service</code>）中抛出的任何异常都会被它捕获，并自动根据请求想要获取的类型返回不同类型的错误（基于 <a href=https://tools.ietf.org/html/rfc7231#section-5.3.2 target=_blank>Content Negotiation</a>）。</p><table><thead><tr><th>请求需求的格式</th><th>环境</th><th>errorPageUrl 是否配置</th><th>返回内容</th></tr></thead><tbody><tr><td><code>HTML & TEXT</code></td><td><code>local & unittest</code></td><td>-</td><td><code>onerror</code> 自带的错误页面，展示详细的错误信息</td></tr><tr><td><code>HTML & TEXT</code></td><td>其他</td><td>是</td><td>重定向到 <code>errorPageUrl</code></td></tr><tr><td><code>HTML & TEXT</code></td><td>其他</td><td>否</td><td><code>onerror</code> 自带的没有错误信息的简单错误页（不推荐）</td></tr><tr><td><code>JSON & JSONP</code></td><td><code>local & unittest</code></td><td>-</td><td><code>JSON</code> 对象或对应的<code> JSONP</code> 格式响应，带详细的错误信息</td></tr><tr><td><code>JSON & JSONP</code></td><td>其他</td><td>-</td><td><code>JSON</code> 对象或对应的 <code>JSONP</code> 格式响应，不带详细的错误信息</td></tr></tbody></table><p>异常处理配置：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.onerror <span style=color:#04a5e5;font-weight:700>=</span> { <span style=color:#9ca0b0;font-style:italic>// 配置 egg-onerror 插件
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic></span>  errorPageUrl<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/error&#39;</span>,<span style=color:#9ca0b0;font-style:italic>// 线上页面发生异常时，重定向到这个地址
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>  all(err, ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    <span style=color:#9ca0b0;font-style:italic>// 在此处定义针对所有响应类型的错误处理方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>    <span style=color:#9ca0b0;font-style:italic>// 注意，定义了 config.all 之后，其他错误处理方法不会再生效
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>    ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;error&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    ctx.status <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>500</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  html(err, ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    <span style=color:#9ca0b0;font-style:italic>// html hander
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>    ctx.body <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;&lt;h3&gt;error&lt;/h3&gt;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    ctx.status <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>500</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>  json(err, ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>    <span style=color:#9ca0b0;font-style:italic>// json hander
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>    ctx.body <span style=color:#04a5e5;font-weight:700>=</span> { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;error&#39;</span> };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    ctx.status <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>500</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>};
</span></span></code></pre></div><h4 id=404>404<a class=anchorjs-link href=#404></a></h4><p><code>egg</code>框架并不会将服务端返回的 404 状态当做异常来处理，但是框架提供了当响应为 404 且没有返回 <code>body</code> 时的默认响应。</p><ul><li><p>当请求被框架判定为需要 <code>JSON</code> 格式的响应时，会返回一段 <code>JSON</code>：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>{ <span style=color:#8839ef>&#34;message&#34;</span>: <span style=color:#40a02b>&#34;Not Found&#34;</span> }
</span></span></code></pre></div></li><li><p>当请求被框架判定为需要 <code>HTM</code>L 格式的响应时，会返回一段 <code>HTML</code>：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>&lt;<span style=color:#8839ef>h1</span>&gt;404 Not Found&lt;/<span style=color:#8839ef>h1</span>&gt;
</span></span></code></pre></div></li></ul><p>框架支持通过配置，将默认的 <code>HTML</code> 请求的 404 响应重定向到指定的页面。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.notfound  <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  pageUrl<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/404&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>};
</span></span></code></pre></div><h4 id=示例-3>示例<a class=anchorjs-link href=#%e7%a4%ba%e4%be%8b-3></a></h4><ul><li>在访问首页时报404错误，跳转到指定的404错误页面，页面指向服务端定义的404页面。</li><li>在访问用户列表页面时，主动抛出错误，跳转到指定的错误页面，页面指向服务端定义的error页面。（开发环境不会跳转，会显示egg内置的错误页面，只能在生产环境运行时，显示该错误）</li><li>安装<code>egg-view-nunjucks</code>和配置模板引擎内容省略</li></ul><h5 id=配置-5>配置<a class=anchorjs-link href=#%e9%85%8d%e7%bd%ae-5></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#9ca0b0;font-style:italic>// 线上页面发生异常时，重定向到这个地址
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.onerror <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	errorPageUrl<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/error&#39;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic>// 指定未找到页面时，重定向到这个地址
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.notfound <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	pageUrl<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/404&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span></code></pre></div><h5 id=路由-3>路由<a class=anchorjs-link href=#%e8%b7%af%e7%94%b1-3></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/router.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>routesmapper.errormapper <span style=color:#04a5e5;font-weight:700>=</span> app =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>const</span> { router, controller } <span style=color:#04a5e5;font-weight:700>=</span> app
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	<span style=color:#9ca0b0;font-style:italic>// 给错误重定向的路由地址，设置控制器
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>	router.get(<span style=color:#40a02b>&#39;/error&#39;</span>, controller.error.index)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	router.get(<span style=color:#40a02b>&#39;/404&#39;</span>, controller.error.nofound)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>...
</span></span></code></pre></div><h5 id=控制器-5>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-5></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/error.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#9ca0b0;font-style:italic>// 指定错误时，渲染的模板
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> index() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;error.html&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	<span style=color:#9ca0b0;font-style:italic>// 指定404时，渲染的模板
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> nofound() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.render(<span style=color:#40a02b>&#39;404.html&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// app/controller/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>  <span style=color:#9ca0b0;font-style:italic>// 获取所有用户时，抛出错误
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> getUsers() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>		<span style=color:#8839ef>throw</span> <span style=color:#8839ef>new</span> <span style=color:#04a5e5>Error</span>(<span style=color:#40a02b>&#39;不要获取用户&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>}
</span></span></code></pre></div><h5 id=模板-1>模板<a class=anchorjs-link href=#%e6%a8%a1%e6%9d%bf-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!--app/view/error.html--&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>&lt;<span style=color:#8839ef>h1</span> <span style=color:#1e66f5>style</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;margin: 0 auto; padding: 24px; text-align: center&#34;</span>&gt;发生了错误&lt;/<span style=color:#8839ef>h1</span>&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic>&lt;!--app/view/404.html--&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>&lt;<span style=color:#8839ef>h1</span> <span style=color:#1e66f5>style</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;margin: 0 auto; padding: 24px; text-align: center&#34;</span>&gt;404 找不到页面&lt;/<span style=color:#8839ef>h1</span>&gt;
</span></span></code></pre></div><h3 id=参数校验>参数校验<a class=anchorjs-link href=#%e5%8f%82%e6%95%b0%e6%a0%a1%e9%aa%8c></a></h3><p><code>egg</code>框架的参数校验官方使用的是<code>egg-validate</code>，<code>egg-validate</code>的校验规则又是依赖<code>parameter</code>。主要问题有：</p><ul><li>不能自定义错误内容</li><li>类型校验兼容性较差</li><li>非必填校验兼容性较差</li></ul><p>直接借助<code>joi</code>这个node的验证库能更快的视线参数验证并自定义验证错误信息。目前问题，返回的多条错误，都是在一起的，不能单独对每项进行错误显示。</p><h4 id=示例-4>示例<a class=anchorjs-link href=#%e7%a4%ba%e4%be%8b-4></a></h4><ul><li>在context扩展中定义成功和错误返回的数据格式</li><li>使用joi定义注册和登录的校验规则</li><li>在user的controller中使用校验规则对数据进行校验后返回，如果出现错误，使用context中的错误格式，否则使用成功格式返回</li></ul><h5 id=安装-4>安装<a class=anchorjs-link href=#%e5%ae%89%e8%a3%85-4></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add joi
</span></span></code></pre></div><h5 id=扩展-1>扩展<a class=anchorjs-link href=#%e6%89%a9%e5%b1%95-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/extends/context.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 定义统一成功返回数据格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> sendSuccess({ code <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>200</span>, msg <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;ok&#39;</span>, data <span style=color:#04a5e5;font-weight:700>=</span> {} }) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>		<span style=color:#8839ef>this</span>.body <span style=color:#04a5e5;font-weight:700>=</span> { code, msg, data }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	<span style=color:#9ca0b0;font-style:italic>// 定义统一错误返回数据格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> sendFailed({ code <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>400</span>, msg <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;failed&#39;</span> }) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		<span style=color:#8839ef>this</span>.body <span style=color:#04a5e5;font-weight:700>=</span> { code, msg }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span></code></pre></div><h5 id=规则>规则<a class=anchorjs-link href=#%e8%a7%84%e5%88%99></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// app/rules/user.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> Joi <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;joi&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> registerValidator <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> params =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>const</span> registerSchema <span style=color:#04a5e5;font-weight:700>=</span> Joi.object({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		username<span style=color:#04a5e5;font-weight:700>:</span> Joi.string().min(<span style=color:#fe640b>3</span>).max(<span style=color:#fe640b>24</span>).required().messages({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>			<span style=color:#40a02b>&#39;string.min&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户名长度不能小于3&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#40a02b>&#39;string.max&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户名长度不能大于24&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			<span style=color:#40a02b>&#39;any.required&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户名不能为空&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		}),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		email<span style=color:#04a5e5;font-weight:700>:</span> Joi.string().email().required().messages({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			<span style=color:#40a02b>&#39;any.required&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;邮箱不能为空&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			<span style=color:#40a02b>&#39;string.email&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;邮箱格式不正确&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		}),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>		password<span style=color:#04a5e5;font-weight:700>:</span> Joi.string().min(<span style=color:#fe640b>6</span>).max(<span style=color:#fe640b>24</span>).required().messages({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			<span style=color:#40a02b>&#39;string.min&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码长度不能小于6&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>			<span style=color:#40a02b>&#39;string.max&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码长度不能大于24&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>			<span style=color:#40a02b>&#39;any.required&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码不能为空&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>	<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>    <span style=color:#9ca0b0;font-style:italic>// 设置abortEarly: false，每次返回所有的校验错误。默认为true，每次只返回一条校验错误
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> registerSchema.validateAsync(params, { abortEarly<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>	} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>    <span style=color:#9ca0b0;font-style:italic>// 将校验错误按照字段输出对应的错误内容
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>			error.details.map(e =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>				<span style=color:#8839ef>const</span> errorMsg <span style=color:#04a5e5;font-weight:700>=</span> {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>				errorMsg[e.context.key] <span style=color:#04a5e5;font-weight:700>=</span> e.message
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>				<span style=color:#8839ef>return</span> errorMsg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>			}) <span style=color:#04a5e5;font-weight:700>??</span> <span style=color:#40a02b>&#39;参数错误&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>		)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span><span style=color:#8839ef>const</span> loginValidator <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> params =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	<span style=color:#8839ef>const</span> loginSchema <span style=color:#04a5e5;font-weight:700>=</span> Joi.object({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>		email<span style=color:#04a5e5;font-weight:700>:</span> Joi.string().email().required().messages({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>			<span style=color:#40a02b>&#39;any.required&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;邮箱不能为空&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>			<span style=color:#40a02b>&#39;string.email&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;邮箱格式不正确&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>		}),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>		password<span style=color:#04a5e5;font-weight:700>:</span> Joi.string().min(<span style=color:#fe640b>6</span>).max(<span style=color:#fe640b>24</span>).required().messages({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>			<span style=color:#40a02b>&#39;string.min&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码长度不能小于6&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>			<span style=color:#40a02b>&#39;string.max&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码长度不能大于24&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>			<span style=color:#40a02b>&#39;any.required&#39;</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码不能为空&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">47</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">48</span><span>	})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">50</span><span>	<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">51</span><span>		<span style=color:#8839ef>await</span> loginSchema.validateAsync(params, { abortEarly<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">52</span><span>	} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">53</span><span>		<span style=color:#8839ef>return</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">54</span><span>			error.details.map(e =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">55</span><span>				<span style=color:#8839ef>const</span> errorMsg <span style=color:#04a5e5;font-weight:700>=</span> {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">56</span><span>				errorMsg[e.context.key] <span style=color:#04a5e5;font-weight:700>=</span> e.message
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">57</span><span>				<span style=color:#8839ef>return</span> errorMsg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">58</span><span>			}) <span style=color:#04a5e5;font-weight:700>??</span> <span style=color:#40a02b>&#39;参数错误&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">59</span><span>		)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">60</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">61</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">63</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">64</span><span>	registerValidator,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">65</span><span>	loginValidator
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">66</span><span>}
</span></span></code></pre></div><h5 id=控制器-6>控制器<a class=anchorjs-link href=#%e6%8e%a7%e5%88%b6%e5%99%a8-6></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Controller } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;egg&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> validator <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../rules/user&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>class</span> <span style=color:#8839ef>extends</span> Controller {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#9ca0b0;font-style:italic>// 注册
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> create() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#9ca0b0;font-style:italic>// 使用注册校验对数据进行校验
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> userValidator <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> validator.registerValidator(userInfo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		<span style=color:#9ca0b0;font-style:italic>// 如果有返回内容则发生校验错误，使用统一错误返回格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>if</span> (userValidator) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			<span style=color:#8839ef>this</span>.ctx.sendFailed({ msg<span style=color:#04a5e5;font-weight:700>:</span> userValidator })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		userInfo.password <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.helper.handleMd5(userInfo.password)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.create(userInfo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		<span style=color:#9ca0b0;font-style:italic>// 如没有错误，则使用统一成功返回格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.sendSuccess({ data<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>await</span> user.toUserJson() })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>	<span style=color:#9ca0b0;font-style:italic>// 登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> login() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>this</span>.ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.model.User.findOne({ email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		<span style=color:#9ca0b0;font-style:italic>// 使用登录校验对数据进行校验，如果校验错误，则使用统一错误返回格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> loginValidator <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> validator.loginValidator(userInfo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>		<span style=color:#8839ef>if</span> (loginValidator) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>			<span style=color:#8839ef>this</span>.ctx.sendFailed({ msg<span style=color:#04a5e5;font-weight:700>:</span> loginValidator })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			<span style=color:#8839ef>this</span>.ctx.sendFailed({ msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>		<span style=color:#8839ef>if</span> (user.password <span style=color:#04a5e5;font-weight:700>!==</span> userInfo.password) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>			<span style=color:#8839ef>this</span>.ctx.sendFailed({ msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;密码错误&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>			<span style=color:#8839ef>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.jwtSign({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> user._id,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> user.username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">47</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">48</span><span>		<span style=color:#9ca0b0;font-style:italic>// 如没有错误，则使用统一成功返回格式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">49</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.ctx.sendSuccess({ data<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>await</span> user.toUserJson(token) })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">50</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">51</span><span>}
</span></span></code></pre></div><h3 id=安全>安全<a class=anchorjs-link href=#%e5%ae%89%e5%85%a8></a></h3><p>Web 应用中存在很多安全风险，这些风险会被黑客利用，轻则篡改网页内容，重则窃取网站内部数据，更为严重的则是在网页中植入恶意代码，使得用户受到侵害。常见的安全漏洞如下：</p><ul><li><code>XSS</code> 攻击：对 <code>Web</code> 页面注入脚本，使用 <code>JavaScript</code> 窃取用户信息，诱导用户操作。</li><li><code>CSRF</code> 攻击：伪造用户请求向网站发起恶意请求。</li><li>钓鱼攻击：利用网站的跳转链接或者图片制造钓鱼陷阱。</li><li><code>HTTP</code> 参数污染：利用对参数格式验证的不完善，对服务器进行参数注入攻击。</li><li>远程代码执行：用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令。</li></ul><p>而框架本身针对 <code>Web</code> 端常见的安全风险内置了丰富的解决方案：</p><ul><li>利用 <a href=https://github.com/eggjs/egg/blob/master/docs/source/zh-cn/basics/extend.md target=_blank>extend</a> 机制扩展了 <code>Helper API</code>, 提供了各种模板过滤函数，防止钓鱼或 <code>XSS</code> 攻击。</li><li>常见 <code>Web</code> 安全头的支持。</li><li><code>CSRF</code> 的防御方案。</li><li>灵活的安全配置，可以匹配不同的请求 <code>url</code> 。</li><li>可定制的白名单，用于安全跳转和 <code>url</code> 过滤。</li><li>各种模板相关的工具函数做预处理。</li></ul><p>在框架中内置了安全插件 <a href=https://github.com/eggjs/egg-security target=_blank>egg-security</a>， 提供了默认的安全实践。</p><h4 id=开启与关闭配置>开启与关闭配置<a class=anchorjs-link href=#%e5%bc%80%e5%90%af%e4%b8%8e%e5%85%b3%e9%97%ad%e9%85%8d%e7%bd%ae></a></h4><p>注意：除非清楚地确认后果，否则不建议擅自关闭安全插件提供的功能。</p><p>框架的安全插件是默认开启的，如果我们想关闭其中一些安全防范，直接设置该项的 <code>enable</code> 属性为 <code>false</code> 即可。例如关闭 <code>xframe</code> 防范：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  xframe<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    enable<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>};
</span></span></code></pre></div><h5 id=match-和-ignore>match 和 ignore<a class=anchorjs-link href=#match-%e5%92%8c-ignore></a></h5><p><code>match</code> 和 <code>ignore</code> 使用方法和格式与<a href=https://www.eggjs.org/zh-CN/basics/middleware#match%e5%92%8cignore target=_blank>中间件通用配置</a>一致。</p><p>如果只想开启针对某一路径，则配置 <code>match</code> 选项，例如只针对 <code>/example</code> 开启 <code>CSP</code>：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  csp<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    match<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/example&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    policy<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>      <span style=color:#9ca0b0;font-style:italic>//...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>};
</span></span></code></pre></div><p>如果需要针对某一路径忽略某安全选项，则配置 ignore 选项，例如针对 <code>/example</code> 关闭 xframe，以便合作商户能够嵌入我们的页面：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  csp<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    ignore<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;/example&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    xframe<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>      <span style=color:#9ca0b0;font-style:italic>//...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>};
</span></span></code></pre></div><p>如果要针对内部 ip 关闭部分安全防范：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  csrf<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>    <span style=color:#9ca0b0;font-style:italic>// 判断是否需要 ignore 的方法，请求上下文 context 作为第一个参数
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>    ignore<span style=color:#04a5e5;font-weight:700>:</span> (ctx) =&gt; isInnerIp(ctx.ip),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>};
</span></span></code></pre></div><h4 id=xxs防范>XXS防范<a class=anchorjs-link href=#xxs%e9%98%b2%e8%8c%83></a></h4><p><code>XSS</code>（<code>cross-site scripting</code> 跨域脚本攻击）攻击是最常见的 <code>Web</code> 攻击，其重点是『跨域』和『客户端执行』。</p><p><code>XSS</code> 攻击一般分为两类：</p><ul><li><code>Reflected XSS</code>（反射型的 <code>XSS</code> 攻击）</li><li><code>Stored XSS</code>（存储型的 <code>XSS</code> 攻击）</li></ul><p><code>egg-security</code>在<code>helper</code>中扩展了一些方法，用于<code>xss</code>防护</p><ol><li><p><code>helper.escape</code>，该方法会对整个字符串进行<code>XSS</code>过滤，转换目标字符串中的危险字符</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#8839ef>const</span> str <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;&lt;a href=&#34;/&#34;&gt;XSS&lt;/a&gt;&lt;script&gt;alert(&#34;abc&#34;) &lt;/script&gt;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>console.log(ctx.helper.escape(str)); <span style=color:#9ca0b0;font-style:italic>// =&gt; &lt;a href=&#34;/&#34;&gt;XSS&lt;/a&gt;&lt;script&gt;alert(&#34;abc&#34;) &lt;/script&gt;
</span></span></span></code></pre></div><p>这对在页面中显示用户字符很有用</p></li><li><p><code>helper.sjs</code>，该方法会将字符串中进行<code>JS Encode</code>，将某些特殊字符，转换为十六进制的编码形式<code>\x编码</code></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#8839ef>const</span> foo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;&#34;hello&#34;&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic>// 未使用 sjs
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic></span>console.log(<span style=color:#40a02b>`var foo = &#34;</span><span style=color:#40a02b>${</span>foo<span style=color:#40a02b>}</span><span style=color:#40a02b>&#34;;`</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic>// =&gt; var foo = &#34;&#34;hello&#34;&#34;;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span><span style=color:#9ca0b0;font-style:italic>// 使用 sjs
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span><span style=color:#9ca0b0;font-style:italic></span>console.log(<span style=color:#40a02b>`var foo = &#34;</span><span style=color:#40a02b>${</span>ctx.helper.sjs(foo)<span style=color:#40a02b>}</span><span style=color:#40a02b>&#34;;`</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span><span style=color:#9ca0b0;font-style:italic>// =&gt; var foo = &#34;\\x22hello\\x22&#34;;
</span></span></span></code></pre></div><p>这对在JS中动态加入用户字符很有用</p></li><li><p><code>helper.shtml</code>，过滤一段<code>html</code>字符串</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#8839ef>const</span> value <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`&lt;a t=1 title=&#34;a&#34; href=&#34;http://www.domain.com&#34;&gt;google&lt;/a&gt;&lt;script&gt;evilcode…&lt;/script&gt;`</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>console.log(ctx.helper.shtml(value));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic>// =&gt; &lt;a title=&#34;a&#34;&gt;google&lt;/a&gt;&lt;script&gt;evilcode…&lt;/script&gt;
</span></span></span></code></pre></div><p>可见，对于某些标签和属性，是可以保留的，这取决于白名单的设置，而对于白名单之外的标签和属性，不会保留或者进行编码处理</p><p>另外，针对某些元素的链接，可以配置域名白名单</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.helper <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>shtml<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>whiteList<span style=color:#04a5e5;font-weight:700>:</span> { a<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#40a02b>&#34;title&#34;</span>, <span style=color:#40a02b>&#34;href&#34;</span>] }, <span style=color:#9ca0b0;font-style:italic>// 配置shtml的白名单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>domainWhiteList<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#40a02b>&#34;www.domain.com&#34;</span>], <span style=color:#9ca0b0;font-style:italic>// 配置shtml的域名白名单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#9ca0b0;font-style:italic></span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>};
</span></span></code></pre></div></li></ol><p>注意 <code>shtml</code> 的适用场景，一般是针对来自用户的富文本输入，切忌滥用。 此类场景一般是论坛、评论系统等，即便是论坛等如果不支持 <code>HTML</code> 内容输入，也不要使用此 <code>Helper</code>，直接使用 <code>escape</code> 即可。</p><h4 id=csrf防范>CSRF防范<a class=anchorjs-link href=#csrf%e9%98%b2%e8%8c%83></a></h4><p><code>egg-security</code>选择的是使用<code>csrf token</code>进行 <code>csrf</code> 防护</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>sequenceDiagram
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>浏览器 -&gt;&gt; 我方服务器: get 请求
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>Note right of 我方服务器: 生成token
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>Note right of 我方服务器: token加到cookie中
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>Note right of 我方服务器: token加到表单中
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>我方服务器 -&gt;&gt; 浏览器: 表单页面
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>浏览器 -&gt;&gt; 我方服务器: post 请求 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>Note right of 我方服务器: 对比token验证
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>我方服务器 -&gt;&gt; 浏览器: 成功
</span></span></code></pre></div><p>如何防护：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>sequenceDiagram
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>浏览器 -&gt;&gt; 敌方服务器: get 请求
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>敌方服务器 -&gt;&gt; 浏览器: 表单页面
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>浏览器 -&gt;&gt; 我方服务器: post 请求 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>Note right of 我方服务器: 对比token验证
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>我方服务器 -&gt;&gt; 浏览器: 失败
</span></span></code></pre></div><p>egg提供了<code>ctx.csrf</code>来获取可以与<code>cookie</code>匹配的token</p><p>在下次请求时，仅需将该token放置到<code>query</code>或<code>body</code>中的<code>_csrf</code>字段即可，例如</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>&lt;!-- 放置到 query 中 --&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>&lt;form action=&#34;?_csrf=&lt;%=ctx.csrf %&gt;&#34; method=&#34;POST&#34;&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>&lt;/form&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>&lt;!-- 放置到 body 中 --&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>&lt;form action=&#34;&#34; method=&#34;POST&#34;&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  &lt;input type=&#34;hidden&#34; name=&#34;_csrf&#34; value=&#34;&lt;%=ctx.csrf %&gt;&#34;&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>&lt;/form&gt;
</span></span></code></pre></div><p>对于<code>ajax</code>请求，可以直接在js中获取到<code>cookie</code>中的<code>token</code>，放置到<code>body</code>或<code>query</code>即可</p><p>也可以针对字段名进行配置</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// config/config.default.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>exports.security <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  csrf<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>    cookieName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;csrfToken&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// Cookie 中的字段名，默认为 csrfToken
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span>    bodyName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;_csrf&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>    queryName<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;_csrf&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>};
</span></span></code></pre></div><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/posts/node-mongoose/ data-toggle=tooltip data-placement=top title="Node 15 Mongoose">Previous<br><span>Node 15 Mongoose</span></a></li><li class=next><a href=/posts/react-hook-form/ data-toggle=tooltip data-placement=top title="React Hook Form">Next<br><span>React Hook Form</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/api/>Api</a>
<a href=/tags/auth0/>Auth0</a>
<a href=/tags/chakraui/>Chakraui</a>
<a href=/tags/css/>Css</a>
<a href=/tags/egg/>Egg</a>
<a href=/tags/electron/>Electron</a>
<a href=/tags/elementplus/>ElementPlus</a>
<a href=/tags/elementui/>Elementui</a>
<a href=/tags/elint/>Elint</a>
<a href=/tags/eslint/>Eslint</a>
<a href=/tags/express/>Express</a>
<a href=/tags/firebase/>Firebase</a>
<a href=/tags/formik/>Formik</a>
<a href=/tags/git/>Git</a>
<a href=/tags/graphql/>GraphQL</a>
<a href=/tags/hexo/>Hexo</a>
<a href=/tags/hooks/>Hooks</a>
<a href=/tags/icon/>Icon</a>
<a href=/tags/javascript/>Javascript</a>
<a href=/tags/koa/>Koa</a>
<a href=/tags/mongoddb/>Mongoddb</a>
<a href=/tags/nextjs/>Nextjs</a>
<a href=/tags/node/>Node</a>
<a href=/tags/pinia/>Pinia</a>
<a href=/tags/prettier/>Prettier</a>
<a href=/tags/prisma/>Prisma</a>
<a href=/tags/react/>React</a>
<a href=/tags/react-query/>React-Query</a>
<a href=/tags/react-router/>React-Router</a>
<a href=/tags/redux-toolkit/>Redux-Toolkit</a>
<a href=/tags/sequelize/>Sequelize</a>
<a href=/tags/strapi/>Strapi</a>
<a href=/tags/styled-components/>Styled-Components</a>
<a href=/tags/typescript/>Typescript</a>
<a href=/tags/valtio/>Valtio</a>
<a href=/tags/vite/>Vite</a>
<a href=/tags/vscode/>Vscode</a>
<a href=/tags/vue/>Vue</a>
<a href=/tags/vuex/>Vuex</a>
<a href=/tags/zustand/>Zustand</a>
<a href=/tags/%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/>避坑指南</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; SimFantasy 2024<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js crossorigin=anonymous></script><script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script><script src=/js/simple-jekyll-search.min.js></script><script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")})</script><script type=text/javascript src=/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js></script><script>$(document).ready(function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script src=/zoomjs/zoom.min.js></script></body></html>