<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Node 15 Mongoose | SimFantasy</title>
<meta name=author content="Simz"><meta name=description content="Mongoose 是一款使用 Javascript 操作 MongoDB 的 ORM 框架。"><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Node 15 Mongoose"><meta name=twitter:description content="Mongoose 是一款使用 Javascript 操作 MongoDB 的 ORM 框架。"><meta property="og:title" content="Node 15 Mongoose"><meta property="og:description" content="Mongoose 是一款使用 Javascript 操作 MongoDB 的 ORM 框架。"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost/posts/node-mongoose/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-08T23:37:56+08:00"><meta property="article:modified_time" content="2023-10-08T23:37:56+08:00"><meta property="og:see_also" content="http://localhost/posts/node-egg/"><meta property="og:see_also" content="http://localhost/posts/node-mongodb/"><meta property="og:see_also" content="http://localhost/posts/node-log/"><meta property="og:see_also" content="http://localhost/posts/node-validator/"><meta property="og:see_also" content="http://localhost/posts/node-prisma/"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=123"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=123"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=123"><link rel=manifest href=/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=http://localhost/>SimFantasy</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/archive/ title=Archive>Archive</a></li><li><a href=/series/ title=Note>Note</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Node 15 Mongoose</h1><h2 class=subheading></h2><span class=meta><div class=meta-item><i class="far fa-user-circle"></i> Simz</div><div class=meta-item><i class="far fa-calendar"></i> 2023-10-08</div><div class=meta-item><i class="fa fa-tag"></i>
<a href=/tags/node/ title=Node>Node</a>
<a href=/tags/mongoddb/ title=Mongoddb>Mongoddb</a></div></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><code>Mongoose</code> 是一款使用 <code>Javascript</code> 操作 <code>MongoDB</code> 的 <code>ORM</code> 框架。</p><p>安装</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>pnpm add mongoose
</span></span></code></pre></div><h3 id=连接mongodb>连接MongoDB<a class=anchorjs-link href=#%e8%bf%9e%e6%8e%a5mongodb></a></h3><p>使用 <code>mongoose.connect()</code> 连接到 <code>MongoDB</code>。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span>mongoose.connect(<span style=color:#40a02b>&#39;mongodb://localhost:27017/myapp&#39;</span>); <span style=color:#9ca0b0;font-style:italic>// 最小连接配置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span>mongoose.connect(<span style=color:#40a02b>&#39;mongodb://username:password@host:port/database?options...&#39;</span>); <span style=color:#9ca0b0;font-style:italic>// 更多参数配置
</span></span></span></code></pre></div><p>如果使用<code>localhost</code>连接失败，可以使用<code>127.0.0.1</code>来进行连接。</p><h4 id=连接错误>连接错误<a class=anchorjs-link href=#%e8%bf%9e%e6%8e%a5%e9%94%99%e8%af%af></a></h4><p>Mongoose 连接可能会出现两类错误。</p><ul><li>初始连接的错误。如果初始连接失败了，<code>Mongoose</code> 会抛出一个 <code>error</code> 事件，<code>mongoose.connect()</code> 返回的 <code>promise</code> 会变成 <code>reject</code> 状态。 但是，<code>Mongoose</code> 不会自动重连。</li><li>初始连接建立之后的错误。<code>Mongoose</code> 会尝试重连，并且会抛出一个 <code>error</code> 事件。</li></ul><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/app/db.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	mongoose.connect(<span style=color:#40a02b>&#39;mongodb://localhost:27017/koa_mongoose_demo&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	console.log(<span style=color:#40a02b>&#39;MongoDB connected successfully&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	console.log(<span style=color:#40a02b>&#39;MongoDB connected failed:&#39;</span>, error)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic>// mongoose.connection.on(&#39;error&#39;, err =&gt; {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic>// 	console.log(&#39;Mongoose connection failed:&#39;, err)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic>// })
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span></code></pre></div><h3 id=定义schema>定义Schema<a class=anchorjs-link href=#%e5%ae%9a%e4%b9%89schema></a></h3><p><code>Moongoose</code> 的一切从 <code>Schema</code> 开始，每个 <code>schema</code> 映射到一个 <code>MongoDB</code> 的集合（表）并定义表中文档的形状。<code>schema</code> 中每个 <code>key</code> 都代表文档中的一个属性，并会转化为其定义的类型。</p><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/User.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	email<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 唯一索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>		trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span> <span style=color:#9ca0b0;font-style:italic>// 去除前后空格
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	username<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		trem<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		minlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>2</span>, <span style=color:#9ca0b0;font-style:italic>// 字符最短长度
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>		maxlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>24</span> <span style=color:#9ca0b0;font-style:italic>// 字符最长最长
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>	password<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span> <span style=color:#9ca0b0;font-style:italic>// 默认不查询
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>	age<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>		<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>18</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>	hobby<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#04a5e5>String</span>], <span style=color:#9ca0b0;font-style:italic>// 类型为数组，数组里面是字符串类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> [] <span style=color:#9ca0b0;font-style:italic>// 默认值为空数组
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>	address<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> addressSchema,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/Operation.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>const</span> operationSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	operation<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		<span style=color:#8839ef>enum</span><span style=color:#04a5e5;font-weight:700>:</span> [<span style=color:#40a02b>&#39;登录&#39;</span>, <span style=color:#40a02b>&#39;注销&#39;</span>, <span style=color:#40a02b>&#39;浏览&#39;</span>] <span style=color:#9ca0b0;font-style:italic>// 枚举，限制字段值
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	time<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Date</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Date</span>.now <span style=color:#9ca0b0;font-style:italic>// 默认值为当前时间
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	userId<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> mongoose.Schema.Types.ObjectId, <span style=color:#9ca0b0;font-style:italic>// 指定类型为 ObjectId
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	extraInfo<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> mongoose.Schema.Types.Mixed <span style=color:#9ca0b0;font-style:italic>// 混合类型，可以是任意类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span><span style=color:#9ca0b0;font-style:italic></span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>	address<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> addressSchema,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span><span style=color:#8839ef>const</span> Operation <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;Operation&#39;</span>, operationSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> Operation
</span></span></code></pre></div><h4 id=字段类型>字段类型<a class=anchorjs-link href=#%e5%ad%97%e6%ae%b5%e7%b1%bb%e5%9e%8b></a></h4><table><thead><tr><th>类型</th><th>说明</th><th>验证器</th></tr></thead><tbody><tr><td><code>String</code></td><td>字符串</td><td><code>enum</code>、<code>lowercase</code>、<code>uppercase</code>、<code>match</code>、<code>maxlength</code>、<code>minlength</code>、<code>trim</code>、<code>checkRequired</code></td></tr><tr><td><code>Number</code></td><td>数值</td><td><code>enum</code>、<code>max</code>、<code>min</code>、<code>checkRequired</code></td></tr><tr><td><code>Boolean</code></td><td>布尔</td><td><code>checkRequired</code></td></tr><tr><td><code>Array</code></td><td>数组，也可以使用<code>[]</code>来标识</td><td><code>enum</code>、<code>checkRequired</code></td></tr><tr><td><code>Date</code></td><td>日期</td><td><code>max</code>、<code>min</code></td></tr><tr><td><code>Buffer</code></td><td>Buffer对象</td><td><code>subtype</code>、<code>checkRequired</code></td></tr><tr><td><code>Mixed</code></td><td>任意类型，需使用<code>mongoose.Schema.Types.Mixed</code>指定</td><td></td></tr><tr><td><code>ObjectId</code></td><td>对象Id，需要使用<code>mongoose.Schema.Types.ObjectId</code>指定</td><td><code>auto</code>、<code>checkRequired</code></td></tr><tr><td><code>Decimal128</code></td><td>高精度数字，需要使用<code>mongoose.Schema.Types.Decimal128</code>指定</td><td></td></tr></tbody></table><h4 id=验证器>验证器<a class=anchorjs-link href=#%e9%aa%8c%e8%af%81%e5%99%a8></a></h4><p>验证器可以根据传入的数据类型，进行验证，如通过验证则会将数据存入数据库，否则将报错。上面表格中已经列出诸多类型可以使用的验证器。</p><ul><li>验证定义于 <code>SchemaType</code></li><li>验证是一个中间件。它默认作为 <code>pre('save')</code> 钩子注册在 <code>schema</code> 上</li><li>可以使用 <code>doc.validate(callback)</code> 或 <code>doc.validateSync()</code> 手动验证</li><li>验证器不对未定义的值进行验证，唯一例外是 <code>required</code> 验证器</li><li>验证是异步递归的。当你调用 <code>Model#save</code>，子文档验证也会执行，出错的话 <code>Model#save</code> 回调会接收错误</li><li>验证是可定制的</li></ul><h5 id=自定义验证器>自定义验证器<a class=anchorjs-link href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%aa%8c%e8%af%81%e5%99%a8></a></h5><p>示例：</p><p>给年龄定义一个自定义验证器，传入的值必须大于18，否则报错</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> handleMd5 <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../utils/handleMd5&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		<span style=color:#9ca0b0;font-style:italic>// ... 其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		age<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			<span style=color:#8839ef>default</span><span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>18</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			validate<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>				validator<span style=color:#04a5e5;font-weight:700>:</span> v =&gt; v <span style=color:#04a5e5;font-weight:700>&gt;</span> <span style=color:#fe640b>18</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>    <span style=color:#9ca0b0;font-style:italic>// ... 其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span><span style=color:#9ca0b0;font-style:italic></span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><h4 id=公共schema>公共Schema<a class=anchorjs-link href=#%e5%85%ac%e5%85%b1schema></a></h4><p>上面的示例中，<code>address</code>在多个<code>Schema</code>中使用到，所以将其抽离成一个单独的<code>Schema</code>。然后在需要的<code>Schema</code>中作为类型导入即可。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/addressSchema.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	province<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>	city<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> addressSchema
</span></span></code></pre></div><h4 id=schema选项>Schema选项<a class=anchorjs-link href=#schema%e9%80%89%e9%a1%b9></a></h4><p>在Schema的第二个对象中可以对Schema进行一些配置。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  address<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>    province<span style=color:#04a5e5;font-weight:700>:</span><span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    city<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span> <span style=color:#9ca0b0;font-style:italic>// 设置对象字段不添加_id唯一键
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>}, {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  versionKey<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>, <span style=color:#9ca0b0;font-style:italic>// 创建文档时，不添加_v文档版本
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>  validateBeforeSave<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>, <span style=color:#9ca0b0;font-style:italic>// 不触发验证
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>})
</span></span></code></pre></div><ul><li><p><code>mongoose</code>会为每个对象（包括子对象）添加唯一键<code>_id</code>，这是一种极好的的做法，特别是在对象数组中，可以有效的维护数据的唯一标识</p><ul><li>如果希望禁用这种做法，只需要在相应的<code>Schema</code>中配置<code>_id: false</code></li></ul></li><li><p><code>mongoose</code>在创建文档时，会自动生成一个字段<code>__v</code>，该字段用于方式并发冲突</p><ul><li>如果希望禁用这种做法，只需要在<code>Schema</code>的第二个参数中配置<code>versionKey: false</code></li></ul></li><li><p><code>mongoose</code>总是会在保存文档时触发验证，如果希望禁用这种行为，可以有两种做法：</p><ul><li><p>在<code>Schema</code>的第二个参数中配置<code>validateBeforeSave:false</code>，这将导致使用该<code>Schema</code>的<code>Model</code>在保存时均不会触发验证</p></li><li><p>在调用<code>save</code>方法或<code>create</code>方法时，传入一个配置对象，配置<code>validateBeforeSave:false</code>，这样一来，仅针对这一次调用不进行验证。当给<code>create</code>方法传入配置时，为了避免歧义，需要将第一个参数设置为数组。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> create <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>	<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.create([user], { <span style=color:#9ca0b0;font-style:italic>// 此处传入的数据必须使用数组方式，否则会认为第二个对象也是传入的数据， 而不是配置项
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>    validateBeforeSave<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span> <span style=color:#9ca0b0;font-style:italic>// 关闭数据校验
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>  })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户创建成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>}
</span></span></code></pre></div><blockquote><p><code>mongoose</code>支持<code>.validate(doc, [context])</code>直接对文档进行验证，该验证是异步的。</p><p>当验证失败时，抛出的错误类型是<code>ValidationError</code></p><p>注意：<code>unique</code>在数据库中表现为唯一索引（unique index），并不属于验证的范畴，因此尽管<code>unique</code>约束不满足，也不会导致验证失败，最终在添加时会抛出<code>MongoError</code>，而不是<code>ValidationError</code></p></blockquote></li></ul></li></ul><h3 id=文档操作crud>文档操作CRUD<a class=anchorjs-link href=#%e6%96%87%e6%a1%a3%e6%93%8d%e4%bd%9ccrud></a></h3><h4 id=新增>新增<a class=anchorjs-link href=#%e6%96%b0%e5%a2%9e></a></h4><p>创建文档有两种方式：</p><ul><li><p>创建模型对象然后保存</p><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#d20f39>var</span> obj <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> <span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>(doc); 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#d20f39>var</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> obj.save(); <span style=color:#9ca0b0;font-style:italic>// 保存文档到数据库，会触发验证，也可以使用回调模式
</span></span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> create <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>	<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 直接链式保存
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#9ca0b0;font-style:italic>// const result = await new User(user).save()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#9ca0b0;font-style:italic>// 也可以分开写，中间做一些操作
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>new</span> User(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  <span style=color:#9ca0b0;font-style:italic>// 数据操作...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> userInfo.save()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户创建成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>}
</span></span></code></pre></div></li><li><p>直接使用函数创建对象</p><p>格式：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// 创建一个或多个文档
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic>// 也可以使用回调模式
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic>// 若传入单个对象，返回单个对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span><span style=color:#9ca0b0;font-style:italic>// 若传入多个对象，返回一个数组
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.create(...doc); 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.findByIdAndCreate(id, doc) <span style=color:#9ca0b0;font-style:italic>// 如果没有找到id就创建
</span></span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> create <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>	<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 传入多个对象
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#9ca0b0;font-style:italic>// const result = await User.create(user1, user2)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#9ca0b0;font-style:italic>// 传入一个数组
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#9ca0b0;font-style:italic>// const result = await User.create([user1, user2])
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  <span style=color:#9ca0b0;font-style:italic>// 传入一个对象 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span> 	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.create(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户创建成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span></code></pre></div></li></ul><h5 id=注意事项>注意事项<a class=anchorjs-link href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9></a></h5><ul><li><p><code>&lt;Model>.create(doc, option)</code>等效于<code>new (doc).save(option)</code></p><ul><li>如果你给<code>create</code>传入的是多个文档，则其在内部会创建多个模型，然后循环调用它们的<code>save</code>方法</li></ul></li><li><p>无论用哪一种方式，都会得到<strong>模型实例</strong>，该实例会被<code>mongoose</code>持续跟踪，只要对模型实例的修改都会被记录，一旦重新调用模型实例的<code>save</code>方法，就会把之前对模型的所有更改持久化到数据库。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> create <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>	<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#9ca0b0;font-style:italic>// 创建模型实例
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span> 	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.create(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#9ca0b0;font-style:italic>// 修改
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>  result.age <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>20</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>  <span style=color:#9ca0b0;font-style:italic>// 调用save方法保存
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>await</span> result.save()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户创建成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>}
</span></span></code></pre></div></li><li><p>新增对象时，如果遇到<code>Schema</code>中没有定义的字段，则会被忽略。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>&#34;email&#34;</span>: <span style=color:#40a02b>&#34;tom@sim.com&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>&#34;username&#34;</span>: <span style=color:#40a02b>&#34;tom&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#8839ef>&#34;password&#34;</span>: <span style=color:#40a02b>&#34;123456&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#8839ef>&#34;age&#34;</span>: <span style=color:#fe640b>19</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#8839ef>&#34;hobby&#34;</span>: [<span style=color:#40a02b>&#34;sing&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>  <span style=color:#8839ef>&#34;address&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    <span style=color:#8839ef>&#34;province&#34;</span>: <span style=color:#40a02b>&#34;湖北省&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    <span style=color:#8839ef>&#34;city&#34;</span>: <span style=color:#40a02b>&#34;武汉市&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  <span style=color:#8839ef>&#34;foo&#34;</span>:<span style=color:#40a02b>&#34;bar&#34;</span> <span style=color:#9ca0b0;font-style:italic>// 在Schema中不存在的字段，不会被保存到数据库中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>}
</span></span></code></pre></div></li></ul><h4 id=查询>查询<a class=anchorjs-link href=#%e6%9f%a5%e8%af%a2></a></h4><p>语法</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.findById(id); <span style=color:#9ca0b0;font-style:italic>// 按照id查询单条数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.findOne(filter, projection); <span style=color:#9ca0b0;font-style:italic>// 根据条件和投影查询单条数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.find(filter, projection); <span style=color:#9ca0b0;font-style:italic>// 根据条件和投影查询多条数据
</span></span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 按id查询单条数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> detail <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id, { email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span>, username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span>, age<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询单个用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic>// 按条件查询单条数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> isExist <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>	<span style=color:#8839ef>const</span> { username } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findOne({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>    username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>  })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询用户是否存在成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5;font-weight:700>!!</span>result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span><span style=color:#9ca0b0;font-style:italic>// 按条件查询多条数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> findAll <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>  <span style=color:#8839ef>const</span> { page <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>1</span>, pageSize <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>10</span> } <span style=color:#04a5e5;font-weight:700>=</span> ctx.query
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.find({},<span style=color:#40a02b>&#34;email username age&#34;</span>) <span style=color:#9ca0b0;font-style:italic>// 投影的字符串写法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span><span style=color:#9ca0b0;font-style:italic></span>    .skip((page <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>1</span>) <span style=color:#04a5e5;font-weight:700>*</span> pageSize)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>    .limit(<span style=color:#04a5e5>Number</span>(pageSize))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>    .sort({ age<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5;font-weight:700>-</span><span style=color:#fe640b>1</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询所有用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>}
</span></span></code></pre></div><h5 id=注意事项-1>注意事项<a class=anchorjs-link href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-1></a></h5><ul><li><p>在链式调用中<code>count</code>得到的是当前结果的数量</p></li><li><p>查询<code>id</code>时，使用字符串即可</p></li><li><p>投影<code>projection</code>支持字符串写法</p></li><li><p>排序<code>sort</code>支持字符串写法，正序<code>sort("age")</code>或者倒序<code>sort("-age")</code></p></li><li><p>在<code>Schema</code>中设置了字段为<code>select:false</code>的字段，在查询时可以使用<code>.select('+password +_id')</code>的形式让隐藏的字段加入到查询结果中。</p></li><li><p><code>populate</code>支持关联查询，后面有详述 <strong>填充 populate</strong></p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 在model中需要设置ref
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span>userId<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  type<span style=color:#04a5e5;font-weight:700>:</span> mongoose.Schema.Types.ObjectId, <span style=color:#9ca0b0;font-style:italic>// 指定类型为 ObjectId
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#9ca0b0;font-style:italic></span>  required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 指定关联的模型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span><span style=color:#9ca0b0;font-style:italic>// 在查询时使用populate来进行关联查询，第一个参数为model中的字段名称，第二个参数为投影
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> findAll <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Operation.find().populate(<span style=color:#40a02b>&#39;userId&#39;</span>, <span style=color:#40a02b>&#39;username email age -_id&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;操作记录查询成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>}
</span></span></code></pre></div></li><li><p>在查询时可以使用<code>distinct(字段名)</code>的方式来进行字段值去重。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#9ca0b0;font-style:italic>// 表示查询Post中的tags字段并去重
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> tags <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.find().distinct(<span style=color:#40a02b>&#39;tags&#39;</span>).exec()
</span></span></code></pre></div></li></ul><h4 id=更新>更新<a class=anchorjs-link href=#%e6%9b%b4%e6%96%b0></a></h4><p><code>Mongoose</code>更新可以使用<code>findById</code>在查询后，在模型示例中更新然后再保存</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> update <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  result.username <span style=color:#04a5e5;font-weight:700>=</span> user.username
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>  result.email <span style=color:#04a5e5;font-weight:700>=</span> user.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  result.age <span style=color:#04a5e5;font-weight:700>=</span> user.age
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  result.hobby.push(user.hobby.toString())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  result.address.province <span style=color:#04a5e5;font-weight:700>=</span> user.address.province
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  <span style=color:#8839ef>await</span> result.save()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;更新用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>}
</span></span></code></pre></div><h5 id=注意>注意：<a class=anchorjs-link href=#%e6%b3%a8%e6%84%8f></a></h5><ul><li>如果是修改内容传递过来的数组需要使用<code>push</code>方法更新，<code>push</code>方法接收对应的字符串，如果更新时是使用的数组，需要使用<code>toString()</code>方法转成字符串。</li><li>如果是需要修改对象，则需要注意对象的层级结构</li></ul><p><code>Mongoose</code>可以使用更新函数进行更新</p><p>语法：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.updateOne(filter, doc, [options]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.updateMany(filter, doc, [options]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.findByIdAndUpdate(id, doc, [options]) <span style=color:#9ca0b0;font-style:italic>// 常用
</span></span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> update <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> (ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.updateOne(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>      _id<span style=color:#04a5e5;font-weight:700>:</span> id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>      username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>      email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>      age<span style=color:#04a5e5;font-weight:700>:</span> user.age
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;更新用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>}
</span></span></code></pre></div><p>注意：使用更新函数更新后返回的是修改信息，匹配查询规则到了几条数据，修改了几条数据，并不会返回修改后的内容。</p><h5 id=注意事项-2>注意事项<a class=anchorjs-link href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9-2></a></h5><ul><li><p><code>_id</code>可以直接使用字符串进行匹配，不需要使用<code>ObjectId</code>进行包裹。</p></li><li><p><code>doc</code>中可以省略<code>$set</code>，直接更改即可。</p></li><li><p><code>mongoose</code><strong>更新默认返回的是更新之前的数据</strong>，如果需要返回更新之后的数据需要在更新函数的<code>[options]</code>参数中设置<code>{ returnDocument: 'after'}</code>或者使用<code>{new: true}</code></p></li><li><p>默认情况下，不会触发验证，需要在<code>options</code>设置<code>runValidators: true</code>开启验证。开启验证后，如果未通过验证则会报错。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.updateOne(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>      _id<span style=color:#04a5e5;font-weight:700>:</span> id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>      username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>      email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>      age<span style=color:#04a5e5;font-weight:700>:</span> user.age
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>  	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>      renValidators<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span> <span style=color:#9ca0b0;font-style:italic>// 开启验证
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>  )
</span></span></code></pre></div></li></ul><h4 id=删除>删除<a class=anchorjs-link href=#%e5%88%a0%e9%99%a4></a></h4><p>语法：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.deleteOne(filter);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span><span style=color:#04a5e5;font-weight:700>&lt;</span>Model<span style=color:#04a5e5;font-weight:700>&gt;</span>.deleteMany(filter);
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">1</span><span><span style=color:#8839ef>const</span> remove <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> (ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">2</span><span>  <span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">3</span><span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.deleteOne({ _id<span style=color:#04a5e5;font-weight:700>:</span> id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">4</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">5</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">6</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;删除用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">7</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">8</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">9</span><span>}
</span></span></code></pre></div><h3 id=虚拟属性--get--set>虚拟属性 & Get & Set<a class=anchorjs-link href=#%e8%99%9a%e6%8b%9f%e5%b1%9e%e6%80%a7--get--set></a></h3><p>虚拟属性是可以理解为对模型中的字段数据进行加工处理，并不保存在数据库中。</p><p>示例：</p><p>在<code>User</code>的模型中添加<code>userInfo</code>的虚拟属性字段，输出<code>username+age</code>。在mongoose中有两种方式来实现</p><ol><li>在Schema的字段定义中：</li></ol><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#9ca0b0;font-style:italic>// ... 定义的其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>		userInfo<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> Schema.Types.Mixed, <span style=color:#9ca0b0;font-style:italic>// 混合类型
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span><span style=color:#9ca0b0;font-style:italic></span>			virtual<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 虚拟字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>			get() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>				<span style=color:#8839ef>return</span> <span style=color:#40a02b>`username: </span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.username<span style=color:#40a02b>}</span><span style=color:#40a02b>, age: </span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.age<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			toJSON<span style=color:#04a5e5;font-weight:700>:</span> { virtuals<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span> } <span style=color:#9ca0b0;font-style:italic>// 虚拟字段也转换为JSON
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span><span style=color:#9ca0b0;font-style:italic></span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><p>注意：在默认情况下，虚拟属性的字段，不会输出到查询中结果中，需要设置<code>toJSON: { virtuals: true }</code>属性。</p><ol start=2><li>在Schema的配置项中定义：</li></ol><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		email<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>, <span style=color:#9ca0b0;font-style:italic>// 唯一索引
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span> <span style=color:#9ca0b0;font-style:italic>// 去除前后空格
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>	},{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>	 	toJSON<span style=color:#04a5e5;font-weight:700>:</span> { virtuals<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span> },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>	 	virtuals<span style=color:#04a5e5;font-weight:700>:</span> { <span style=color:#9ca0b0;font-style:italic>// 虚拟字段，不会存储到数据库中
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span><span style=color:#9ca0b0;font-style:italic></span>	 		userInfo<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	 			get() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	 				<span style=color:#8839ef>return</span> <span style=color:#40a02b>`username: </span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.username<span style=color:#40a02b>}</span><span style=color:#40a02b>, age: </span><span style=color:#40a02b>${</span><span style=color:#8839ef>this</span>.age<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>	 			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>	 		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>	 	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><p>注意：在Schema的配置项中定义了也需要设置<code>toJSON: { virtuals: true }</code>属性，否则改虚拟属性字段也不会出现在查询中。但是，在配置项中如果设置了<code>toJSON: { virtuals: true }</code>则会将之前定义的别名<code>alias</code>、<code>_id</code>，都转为<code>JSON</code>形式一并输出，例如：<code>username</code>设置了别名<code>name</code>，<code>_id</code>默认别名为<code>id</code>在设置了toJSON的属性后，同时都会输出。输出内容中则会出现<code>username</code>和<code>name</code>，<code>_id</code>和<code>id</code>并存的情况。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>&#34;code&#34;</span>: <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>&#34;msg&#34;</span>: <span style=color:#40a02b>&#34;查询单个用户成功&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#8839ef>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    <span style=color:#8839ef>&#34;operations&#34;</span>: [],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>    <span style=color:#8839ef>&#34;_id&#34;</span>: <span style=color:#40a02b>&#34;64db3272c8117fb8386b82b2&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    <span style=color:#8839ef>&#34;email&#34;</span>: <span style=color:#40a02b>&#34;tommy@sim.com&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    <span style=color:#8839ef>&#34;username&#34;</span>: <span style=color:#40a02b>&#34;tommy&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    <span style=color:#8839ef>&#34;age&#34;</span>: <span style=color:#fe640b>23</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>    <span style=color:#8839ef>&#34;name&#34;</span>: <span style=color:#40a02b>&#34;tommy&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    <span style=color:#8839ef>&#34;userInfo&#34;</span>: <span style=color:#40a02b>&#34;username: tommy, age: 23&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>    <span style=color:#8839ef>&#34;id&#34;</span>: <span style=color:#40a02b>&#34;64db3272c8117fb8386b82b2&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>  },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>  <span style=color:#8839ef>&#34;userInfo&#34;</span>: <span style=color:#40a02b>&#34;username: tommy, age: 23&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>}
</span></span></code></pre></div><h4 id=set>Set<a class=anchorjs-link href=#set></a></h4><p>上的示例中使用了虚拟属性和Get方法来获取Schema中字段的值进行处理，Get只是对已经存在数据库中的的Schema字段数据进行加工处理，通常情况下，还需要对数据进入到数据库之前进行一些处理，比如：对密码进行加密处理，对一些字段内容进行格式化处理等。</p><p>示例：</p><p>通过<code>handleMd5</code>函数，对密码数据进行加密，并保存到数据库。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> handleMd5 <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../utils/handleMd5&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		<span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		password<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>, <span style=color:#9ca0b0;font-style:italic>// 默认不查询
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span><span style=color:#9ca0b0;font-style:italic></span>			set(val) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>				<span style=color:#8839ef>return</span> handleMd5(val)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span><span style=color:#9ca0b0;font-style:italic></span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><h3 id=静态方法和实例方法>静态方法和实例方法<a class=anchorjs-link href=#%e9%9d%99%e6%80%81%e6%96%b9%e6%b3%95%e5%92%8c%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%95></a></h3><h4 id=静态方法>静态方法<a class=anchorjs-link href=#%e9%9d%99%e6%80%81%e6%96%b9%e6%b3%95></a></h4><p>可以给 <code>model</code> 添加静态方法，通过 <code>schema.statics</code> 或者 <code>Schema#static</code> 函数。注意不能使用箭头函数因为无法使用 <code>this</code> 访问当前的 <code>document</code>。</p><p>示例：</p><p>给UserSchema添加一个静态方法，通过username来获取用户信息。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 给UserSchema设置静态方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		username<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			trem<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			minlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>2</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			maxlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>24</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			alias<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;name&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 别名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span><span style=color:#9ca0b0;font-style:italic>// 静态方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#9ca0b0;font-style:italic></span>userSchema.statics.findByName <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span> (username) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>	<span style=color:#8839ef>return</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.find({ username<span style=color:#04a5e5;font-weight:700>:</span> username })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><p>设置好静态方法后，可以在查询时直接使用。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 按用户名查询用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> search <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> { username } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findByName(username)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户查询成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>}
</span></span></code></pre></div><h4 id=实例方法>实例方法<a class=anchorjs-link href=#%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%95></a></h4><p>实例方法指的是 <code>document</code> 的方法，<code>document</code> 是 <code>Model</code> 类的实例。<code>document</code> 有很多内置的方法，你也可以定义自己方法。</p><p>自定义方法有 2 点需要注意：</p><ul><li>重写内置方法可能会导致未知错误，需要慎重</li><li>不能使用箭头函数，因为无法使用 <code>this</code> 访问当前的 <code>document</code></li></ul><p>实例方法使用频率会很高，</p><p>示例：</p><p>查询年龄相同的用户</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 给UserSchema设置静态方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> { Schema } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>const</span> addressSchema <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;./addressSchema&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Schema
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		username<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			trem<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			minlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>2</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			maxlength<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>24</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			alias<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;name&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 别名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span><span style=color:#9ca0b0;font-style:italic></span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>    <span style=color:#9ca0b0;font-style:italic>// ...其他字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span><span style=color:#9ca0b0;font-style:italic>// 实例方法
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#9ca0b0;font-style:italic></span>userSchema.methods.findSameAge <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>async</span> <span style=color:#d20f39>function</span> () {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>	<span style=color:#8839ef>return</span> <span style=color:#8839ef>await</span> <span style=color:#8839ef>this</span>.model(<span style=color:#40a02b>&#39;User&#39;</span>).find({ age<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>this</span>.age })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic>// 定义User Model
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> User <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> User
</span></span></code></pre></div><p>在查询时因为是实例，所以需要先将Model实例化。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// 查询年龄相同的用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> findSameAge <span style=color:#04a5e5;font-weight:700>=</span>	<span style=color:#8839ef>async</span>(ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>  <span style=color:#8839ef>const</span> { age } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>  <span style=color:#9ca0b0;font-style:italic>// 示例化User，将age传入
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> User({ age })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>  <span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> user.findSameAge()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询年龄相同的用户成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>}
</span></span></code></pre></div><h3 id=聚合管道>聚合管道<a class=anchorjs-link href=#%e8%81%9a%e5%90%88%e7%ae%a1%e9%81%93></a></h3><p><code>Mongoose</code>中的聚合管道和<code>MongoDB</code>中的聚合管道类似。</p><p>示例：</p><p>将<code>order</code>集合通过<code>orderId</code>关联到<code>orderitems</code>集合中的<code>orderId</code>商品。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Order, OrderItem } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../model&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>class</span> OrderController {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询所有订单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findAll(ctx, next) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#9ca0b0;font-style:italic>// 通过聚合管道查询订单，关联查询订单项
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Order.aggregate([
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>				$project<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>					items<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>						_id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>						userId<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>					}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>				$lookup<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>					from<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orderitems&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 关联查询的表，是表名，不是模型名，复数小写
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span><span style=color:#9ca0b0;font-style:italic></span>					localField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orderId&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 本表的字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span><span style=color:#9ca0b0;font-style:italic></span>					foreignField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orderId&#39;</span>, <span style=color:#9ca0b0;font-style:italic>// 关联表的字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span><span style=color:#9ca0b0;font-style:italic></span>					pipeline<span style=color:#04a5e5;font-weight:700>:</span> [ <span style=color:#9ca0b0;font-style:italic>// 对关联表中的字段进行聚合管道设置
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span><span style=color:#9ca0b0;font-style:italic></span>						{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>							$project<span style=color:#04a5e5;font-weight:700>:</span> { _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span>, orderId<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span> } <span style=color:#9ca0b0;font-style:italic>// 通过project过滤掉不需要的字段
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span><span style=color:#9ca0b0;font-style:italic></span>						}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>					],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>					as<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;items&#39;</span> <span style=color:#9ca0b0;font-style:italic>// 查询结果的别名
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span><span style=color:#9ca0b0;font-style:italic></span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>		])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>			code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询所有订单成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> OrderController()
</span></span></code></pre></div><p>示例二</p><p>使用聚合通道，通过订单商品<code>orderitems</code>中商品的<code>_id</code>来查询该商品关联的订单数据。</p><p>实现有两种方式，通过两次查询的数据来进行拼接和使用聚合通道的方式来实现，先使用拼接的方式来实现</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Order, OrderItem } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../model&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>class</span> OrderController {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询订单项关联的订单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findOrder(ctx, next) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#9ca0b0;font-style:italic>// 使用拼接的方式查询订单项，关联查询订单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>      <span style=color:#9ca0b0;font-style:italic>// 首先查询出 订单商品的数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> orderItemResult <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> OrderItem.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>      <span style=color:#9ca0b0;font-style:italic>// 通过订单商品中的orderId，来查询关联的订单数据
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Order.find({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>				orderId<span style=color:#04a5e5;font-weight:700>:</span> orderItemResult.orderId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>				msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询订单项关联的订单成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>				data<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>					...orderItemResult.toJSON(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>					orders<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>500</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>				msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询订单项关联的订单失败&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>				data<span style=color:#04a5e5;font-weight:700>:</span> error
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> OrderController()
</span></span></code></pre></div><p>通过聚合管道来实现</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { Order, OrderItem } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../model&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span><span style=color:#8839ef>class</span> OrderController {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询订单项关联的订单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findOrder(ctx, next) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		<span style=color:#9ca0b0;font-style:italic>// ObjectId是mongoose的数据类型，需要通过mongoose.Types.ObjectId来创建
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#9ca0b0;font-style:italic>// 在使用时需要new一下，使用ObjectId实例来创建
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> ObjectId <span style=color:#04a5e5;font-weight:700>=</span> mongoose.Types.ObjectId
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			<span style=color:#9ca0b0;font-style:italic>// 通过聚合管道查询订单项，关联查询订单
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> result <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> OrderItem.aggregate([
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>				{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>					$match<span style=color:#04a5e5;font-weight:700>:</span> { _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>new</span> ObjectId(id) } 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>				},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>				{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>					$lookup<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>						from<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orders&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>						localField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orderId&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>						foreignField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orderId&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>						as<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;orders&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>					}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>				}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>			])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>      
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>      ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>				msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询订单项关联的订单成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>				data<span style=color:#04a5e5;font-weight:700>:</span> result
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		} <span style=color:#8839ef>catch</span> (error) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>				code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>500</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>				msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询订单项关联的订单失败&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>				data<span style=color:#04a5e5;font-weight:700>:</span> error
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> OrderController()
</span></span></code></pre></div><p>注意：使用聚合管道来查询<code>_id</code>是需要使用<code>ObjectId</code>来处理<code>id</code>，但引入时，<code>ObjectId</code>需要通过实例化来使用。</p><h4 id=多个集合聚合管道>多个集合聚合管道<a class=anchorjs-link href=#%e5%a4%9a%e4%b8%aa%e9%9b%86%e5%90%88%e8%81%9a%e5%90%88%e7%ae%a1%e9%81%93></a></h4><p>上面的示例仅通过orderId对集合进行了关联。聚合管道可以通过多次使用<code>$lookup</code>对多个集合的数据进行关联。</p><p>示例：</p><p>文章列表通过<code>categoryId</code>和<code>authorId</code>对文章分类和文章作者集合进行关联。并通过<code>pipeline</code>的<code>$project</code>来控制关联内容字段显示。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>async</span> findAll(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>const</span> articles <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Article.aggregate([
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>      $lookup<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>        from<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;articlecategories&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>        localField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;categoryId&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>        foreignField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;_id&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>        as<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;category&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>        pipeline<span style=color:#04a5e5;font-weight:700>:</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>          {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>            $project<span style=color:#04a5e5;font-weight:700>:</span> { _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span>, name<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>        ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>      $lookup<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>        from<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;users&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>        localField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;authorId&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>        foreignField<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;_id&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>        as<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;author&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>        pipeline<span style=color:#04a5e5;font-weight:700>:</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>          {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>            $project<span style=color:#04a5e5;font-weight:700>:</span> { _id<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>0</span>, username<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span>, email<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>1</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>        ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>  ])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询所有文章成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> articles
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>}
</span></span></code></pre></div><blockquote><p>注意：因为是通过<code>_id</code>对集合进行关联，所以在model定义时，关联的<code>categoryId</code>和<code>authorId</code>的类型需要为<code>type：mongoose.Schema.Types.ObjectId</code>。</p></blockquote><h3 id=填充populate>填充Populate<a class=anchorjs-link href=#%e5%a1%ab%e5%85%85populate></a></h3><p><code>populate</code>和聚合管道类似，都能关联到对应的文档，聚合管道是<code>mongodb</code>的原生方法，而<code>populate</code>是<code>mongoose</code>的方法。从使用上来说，聚合管道的代码量是远大于<code>populate</code>。</p><p><code>Population</code> 可以自动替换 <code>document</code> 中的指定字段，替换内容从其他 <code>collection</code> 获取。 我们可以填充（<code>populate</code>）单个或多个 <code>document</code>、单个或多个纯对象，甚至是 <code>query</code> 返回的一切对象。</p><p>示例：</p><p>和上面的聚合管道示例来对比下，我们使用<code>populate</code>来实现相同的业务。使用<code>populate</code>需要先在model中关联下对应的集合。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;../app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> ArticleSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> mongoose.Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	title<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>	content<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	categoryId<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> mongoose.Schema.Types.ObjectId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;ArticleCategory&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>	authorId<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> mongoose.Schema.Types.ObjectId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>		ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span><span style=color:#8839ef>const</span> Article <span style=color:#04a5e5;font-weight:700>=</span> mongoose.model(<span style=color:#40a02b>&#39;Article&#39;</span>, ArticleSchema)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> Article
</span></span></code></pre></div><ul><li>在<code>categoryId</code>中添加<code>ref: 'ArticleCategory'</code>使之与<code>ArticleCategory</code>模型进行关联</li><li>在<code>authorId</code>中添加<code>ref: 'User'</code>使之与<code>User</code>模型关联</li></ul><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>async</span> detail(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>  <span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>	<span style=color:#8839ef>const</span> article <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Article.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>    .populate(<span style=color:#40a02b>&#39;categoryId&#39;</span>, <span style=color:#40a02b>&#39;-_id name&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>    .populate(<span style=color:#40a02b>&#39;authorId&#39;</span>, <span style=color:#40a02b>&#39;-_id username email&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>  ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>    code<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>200</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>    msg<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;查询文章详情成功&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>    data<span style=color:#04a5e5;font-weight:700>:</span> article
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>}
</span></span></code></pre></div><p>上述代码肉眼可见的比聚合管道的少了二十几行，实现了相同的业务查询。</p><h3 id=关联>关联<a class=anchorjs-link href=#%e5%85%b3%e8%81%94></a></h3><p><code>mongoose</code>中处理关联的方式与关系型数据库<code>mysql</code>有诸多不一样。可能是因为<code>mongodb</code>对查询单一关系的数据会比较大的优势，所以很多在关系型数据库中觉得不可思议的这里却也觉得似乎也算合理。当然<code>mongoose</code>也可以通过关联集合来处理多对多的关联，并且基于<code>mongoose</code>可以对关联数据进行展开，感觉比<code>mysql</code>这块简单太多了。</p><p>示例内容已放到github： <a href=https://github.com/SimFantasy/koa-mongoos-demo target=_blank>koa-mongoose-demo</a></p><p>下面以一个完整的示例来说明一对多，多对多的关联关系。示例关联说明：</p><ul><li>用户与用户，用户之间可以关注，一个用户可以关注多个用户，一个用户也可以被多个用户关注，是多对多的关系</li><li>用户与文章，一个用户可以有多篇文章，一篇文章属于一个用户，是一对多的关系</li><li>用户与文章，一个用户可以收藏多篇文章，一篇文章也可以被多个用户收藏，是多对多的关系</li><li>文章与标签，一篇文章可以有多个标签，一个标签也可以有多个文章，是多对多的关系（此处在示例中完全不用通过关联来处理，仅通过查询去重实现标签 查询和标签对应的文章查询）</li></ul><h4 id=model>Model<a class=anchorjs-link href=#model></a></h4><h5 id=user>User<a class=anchorjs-link href=#user></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/User.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> { Schema, model } <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>const</span> userSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		username<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>			lowercase<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		email<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>			unique<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>			lowercase<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>		password<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		bio<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>		image<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>		following<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> [{ type<span style=color:#04a5e5;font-weight:700>:</span> Schema.Types.ObjectId, ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User&#39;</span> }],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>			select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>		__v<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>			select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">42</span><span>		timestamps<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">43</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">44</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">46</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> model(<span style=color:#40a02b>&#39;User&#39;</span>, userSchema)
</span></span></code></pre></div><p>模型上对应基本就可以体现关系的处理。</p><p>用户关注：用户关注通过<code>User</code>中的<code>following</code>来进行自关联。用户A关注用户B后，将用户B的<code>_id</code>存入<code>following</code>字段。如果存入了该字段的用户<code>_id</code>则表示该用户关注的，如果用户A的<code>_id</code>在其他用户的<code>following</code>的字段中，则表示其他人对用户A的关注。</p><h5 id=post>Post<a class=anchorjs-link href=#post></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/Post.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> { Schema, model } <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>const</span> postSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Schema(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		title<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		description<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>			trim<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		body<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>		tags<span style=color:#04a5e5;font-weight:700>:</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>			{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>				type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>String</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>		],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>		author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">27</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> Schema.Types.ObjectId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">28</span><span>			ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">29</span><span>			required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">30</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">31</span><span>		__v<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">32</span><span>			type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">33</span><span>			select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">34</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">35</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">36</span><span>	{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">37</span><span>		timestamps<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">38</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">39</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">41</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> model(<span style=color:#40a02b>&#39;Post&#39;</span>, postSchema)
</span></span></code></pre></div><p>文章作者：<code>Post</code>中通过<code>author</code>将用户与文章进行一对多的关联，如果需要查询<code>post</code>中<code>author</code>的详细信息，则只需要通过<code>author</code>中保存的<code>User._id</code>进行展开就可以获得。</p><p>文章和标签：直接将标签以字符串数组的方式存入到文章中即可。</p><h5 id=favorite>Favorite<a class=anchorjs-link href=#favorite></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#9ca0b0;font-style:italic>// src/model/favorite.js
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> mongoose <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@app/db&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span><span style=color:#8839ef>const</span> { Schema, model } <span style=color:#04a5e5;font-weight:700>=</span> mongoose
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span><span style=color:#8839ef>const</span> favoriteSchema <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Schema({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>	user<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> Schema.Types.ObjectId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>		ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;User&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>	post<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> Schema.Types.ObjectId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		ref<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;Post&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>		required<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>	},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>	__v<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>		type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5>Number</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>		select<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> model(<span style=color:#40a02b>&#39;Favorite&#39;</span>, favoriteSchema)
</span></span></code></pre></div><p>文章收藏：特意使用了关系数据库中的中间表的方式来处理，<code>Favorite</code>中间表不需要<code>User</code>和<code>Post</code>对其进行外键关联。只需要在<code>Favorite</code>表中进行关联处理即可。比关系型数据库的处理简单到不知道哪里去了。</p><p>如果需要查询用户收藏了哪些文章，只需要传入用户<code>id</code>，查询用户收藏的<code>post</code>，再通过<code>post</code>展开，即可获得<code>post</code>对应的内容。</p><p>相反，如果需要查看文章被哪些用户收藏了，则只需要传入文章<code>id</code>，查询文章被哪些用户收藏了，在通过<code>user</code>将用户信息展开即可。</p><h4 id=controller>Controller<a class=anchorjs-link href=#controller></a></h4><h5 id=user-1>user<a class=anchorjs-link href=#user-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  1</span><span><span style=color:#8839ef>const</span> { User, Favorite } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@model&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  2</span><span><span style=color:#8839ef>const</span> { jwtSign } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@utils/handleJwt&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  4</span><span><span style=color:#8839ef>class</span> UserController {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  5</span><span>	<span style=color:#9ca0b0;font-style:italic>// 注册
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  6</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> create(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  7</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  9</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.create(user)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 11</span><span>		ctx.user <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 12</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userInfo._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 13</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userInfo.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 14</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 15</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 17</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 18</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userInfo._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 19</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userInfo.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 20</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 21</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>null</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 22</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 23</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 24</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 26</span><span>	<span style=color:#9ca0b0;font-style:italic>// 登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 27</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> login(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 28</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 30</span><span>		<span style=color:#8839ef>const</span> userInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findOne({ email<span style=color:#04a5e5;font-weight:700>:</span> user.email })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 32</span><span>		<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> jwtSign({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 33</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userInfo._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 34</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userInfo.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 35</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 36</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 38</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 39</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userInfo._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 40</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userInfo.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 41</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userInfo.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 42</span><span>			token
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 43</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 44</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 46</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询所有用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 47</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findAllUsers(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 48</span><span>		<span style=color:#8839ef>const</span> users <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.find()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 50</span><span>		<span style=color:#9ca0b0;font-style:italic>// 是否登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 51</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>ctx.user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 52</span><span>			<span style=color:#8839ef>const</span> userList <span style=color:#04a5e5;font-weight:700>=</span> users.map(user =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 53</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 54</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 55</span><span>				email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 56</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 57</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 58</span><span>				isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 59</span><span>			}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 60</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 61</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> userList
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 62</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 63</span><span>			<span style=color:#9ca0b0;font-style:italic>// 是否关注
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 64</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(ctx.user.id).select(<span style=color:#40a02b>&#39;+following&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 65</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 66</span><span>			<span style=color:#8839ef>for</span> (<span style=color:#d20f39>let</span> user <span style=color:#8839ef>of</span> users) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 67</span><span>				<span style=color:#8839ef>const</span> isFollowed <span style=color:#04a5e5;font-weight:700>=</span> loginUser.following.some(item =&gt; item.toString() <span style=color:#04a5e5;font-weight:700>===</span> user._id.toString())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 68</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 69</span><span>				user.isFollowed <span style=color:#04a5e5;font-weight:700>=</span> isFollowed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 70</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 71</span><span>				user.save()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 72</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 73</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 74</span><span>			<span style=color:#8839ef>const</span> userList <span style=color:#04a5e5;font-weight:700>=</span> users.map(user =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 75</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 76</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 77</span><span>				email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 78</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 79</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 80</span><span>				isFollowed<span style=color:#04a5e5;font-weight:700>:</span> user.isFollowed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 81</span><span>			}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 82</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 83</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> userList
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 84</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 85</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 86</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 87</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 88</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findUser(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 89</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 90</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 91</span><span>		<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 92</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 93</span><span>		<span style=color:#9ca0b0;font-style:italic>// 是否登录
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 94</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>ctx.user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 95</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 96</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 97</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 98</span><span>				email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 99</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">100</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">101</span><span>				isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">102</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">103</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">104</span><span>			<span style=color:#9ca0b0;font-style:italic>// 是否关注
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">105</span><span><span style=color:#9ca0b0;font-style:italic></span>			<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(ctx.user.id).select(<span style=color:#40a02b>&#39;+following&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">106</span><span>			<span style=color:#8839ef>const</span> isFollowed <span style=color:#04a5e5;font-weight:700>=</span> loginUser.following.some(item =&gt; item.toString() <span style=color:#04a5e5;font-weight:700>===</span> id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">107</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">108</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">109</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">110</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">111</span><span>				email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">112</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">113</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">114</span><span>				isFollowed
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">115</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">116</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">117</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">118</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">119</span><span>	<span style=color:#9ca0b0;font-style:italic>// 关注用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">120</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> follow(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">121</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">122</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">123</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询用户是否存在
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">124</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> userIsExist <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">125</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">126</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>userIsExist) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">127</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>404</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">128</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">129</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">130</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询是否已经关注
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">131</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(ctx.user.id).select(<span style=color:#40a02b>&#39;+following&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">132</span><span>		<span style=color:#8839ef>const</span> isFollowed <span style=color:#04a5e5;font-weight:700>=</span> loginUser.following.some(item =&gt; item.toString() <span style=color:#04a5e5;font-weight:700>===</span> id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">133</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">134</span><span>		<span style=color:#8839ef>if</span> (isFollowed) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">135</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>409</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;已经关注过该用户&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">136</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">137</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">138</span><span>		<span style=color:#9ca0b0;font-style:italic>// 关注用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">139</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> User.findByIdAndUpdate(ctx.user.id, { $push<span style=color:#04a5e5;font-weight:700>:</span> { following<span style=color:#04a5e5;font-weight:700>:</span> id } })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">140</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">141</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">142</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userIsExist._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">143</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">144</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">145</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">146</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">147</span><span>			isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">148</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">149</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">150</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">151</span><span>	<span style=color:#9ca0b0;font-style:italic>// 取消关注用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">152</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> unfollow(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">153</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">154</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">155</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询用户是否存在
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">156</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> userIsExist <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">157</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">158</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>userIsExist) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">159</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>404</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;用户不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">160</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">161</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">162</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询是否已经关注
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">163</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(ctx.user.id).select(<span style=color:#40a02b>&#39;+following&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">164</span><span>		<span style=color:#8839ef>const</span> isFollowed <span style=color:#04a5e5;font-weight:700>=</span> loginUser.following.some(item =&gt; item.toString() <span style=color:#04a5e5;font-weight:700>===</span> id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">165</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">166</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>isFollowed) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">167</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>409</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;还未关注该用户&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">168</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">169</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">170</span><span>		<span style=color:#9ca0b0;font-style:italic>// 取消关注用户
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">171</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> User.findByIdAndUpdate(ctx.user.id, { $pull<span style=color:#04a5e5;font-weight:700>:</span> { following<span style=color:#04a5e5;font-weight:700>:</span> id } })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">172</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">173</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">174</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> userIsExist._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">175</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">176</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">177</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">178</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> userIsExist.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">179</span><span>			isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">180</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">181</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">182</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">183</span><span>	<span style=color:#9ca0b0;font-style:italic>// 获取用户关注列表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">184</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> followings(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">185</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">186</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">187</span><span>		<span style=color:#8839ef>const</span> users <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id).select(<span style=color:#40a02b>&#39;+following&#39;</span>).populate(<span style=color:#40a02b>&#39;following&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">188</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">189</span><span>		<span style=color:#8839ef>const</span> userList <span style=color:#04a5e5;font-weight:700>=</span> users.following.map(user =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">190</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">191</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">192</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">193</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">194</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">195</span><span>			isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">196</span><span>		}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">197</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">198</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> userList
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">199</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">200</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">201</span><span>	<span style=color:#9ca0b0;font-style:italic>// 获取用户粉丝列表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">202</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> followers(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">203</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">204</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">205</span><span>		<span style=color:#8839ef>const</span> users <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.find({ following<span style=color:#04a5e5;font-weight:700>:</span> id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">206</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">207</span><span>		<span style=color:#8839ef>const</span> userList <span style=color:#04a5e5;font-weight:700>=</span> users.map(user =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">208</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> user._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">209</span><span>			username<span style=color:#04a5e5;font-weight:700>:</span> user.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">210</span><span>			email<span style=color:#04a5e5;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">211</span><span>			bio<span style=color:#04a5e5;font-weight:700>:</span> user.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">212</span><span>			image<span style=color:#04a5e5;font-weight:700>:</span> user.image,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">213</span><span>			isFollowed<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">214</span><span>		}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">215</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">216</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> userList
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">217</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">218</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">219</span><span>	<span style=color:#9ca0b0;font-style:italic>// 获取用户收藏文章列表
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">220</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> favorite(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">221</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">222</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">223</span><span>		<span style=color:#8839ef>const</span> posts <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Favorite.find({ user<span style=color:#04a5e5;font-weight:700>:</span> id }).populate(<span style=color:#40a02b>&#39;post&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">224</span><span>		console.log(<span style=color:#40a02b>&#39;posts&#39;</span>, posts)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">225</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">226</span><span>		<span style=color:#8839ef>const</span> postList <span style=color:#04a5e5;font-weight:700>=</span> posts.map(post =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">227</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> post.post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">228</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> post.post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">229</span><span>			description<span style=color:#04a5e5;font-weight:700>:</span> post.post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">230</span><span>			body<span style=color:#04a5e5;font-weight:700>:</span> post.post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">231</span><span>			tagList<span style=color:#04a5e5;font-weight:700>:</span> post.post.tagList,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">232</span><span>			isFavorite<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">233</span><span>			createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">234</span><span>			updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">235</span><span>		}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">236</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">237</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> postList
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">238</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">239</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">240</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">241</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> UserController()
</span></span></code></pre></div><p>关注用户： 只需要将用户添加到User的<code>following</code>中则可实现。</p><p>取消关注：只需要将用户从<code>following</code>中移除即可。</p><p>用户关注列表：查询用户<code>following</code>字段。</p><p>用户粉丝列表：查询所有用户的<code>following</code>字段中包含用户<code>id</code>的用户。</p><p>用户收藏文章：直接去查询<code>favorite</code>集合中的<code>user</code>，并展开<code>post</code>即可获得用户收藏文章的具体内容。</p><h5 id=post-1>post<a class=anchorjs-link href=#post-1></a></h5><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  1</span><span><span style=color:#8839ef>const</span> { Post, User, Favorite } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@model&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  3</span><span><span style=color:#8839ef>class</span> PostController {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  4</span><span>	<span style=color:#9ca0b0;font-style:italic>// 创建文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  5</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> create(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  6</span><span>		<span style=color:#8839ef>const</span> post <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.body
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  7</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">  9</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询作者信息
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 10</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> author <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> User.findById(id, <span style=color:#40a02b>&#39;username bio image&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 11</span><span>		<span style=color:#9ca0b0;font-style:italic>// 添加作者信息到文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 12</span><span><span style=color:#9ca0b0;font-style:italic></span>		post.author <span style=color:#04a5e5;font-weight:700>=</span> id
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 13</span><span>		<span style=color:#9ca0b0;font-style:italic>// 创建文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 14</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> postInfo <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.create(post)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 16</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 17</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> postInfo._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 18</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> postInfo.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 19</span><span>			description<span style=color:#04a5e5;font-weight:700>:</span> postInfo.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 20</span><span>			body<span style=color:#04a5e5;font-weight:700>:</span> postInfo.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 21</span><span>			tags<span style=color:#04a5e5;font-weight:700>:</span> postInfo.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 22</span><span>			author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 23</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 24</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 25</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 26</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 27</span><span>			createdAt<span style=color:#04a5e5;font-weight:700>:</span> postInfo.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 28</span><span>			updatedAt<span style=color:#04a5e5;font-weight:700>:</span> postInfo.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 29</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 30</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 32</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询所有文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 33</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findAllPosts(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 34</span><span>		<span style=color:#8839ef>const</span> { page <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>1</span>, per_page <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>10</span>, q } <span style=color:#04a5e5;font-weight:700>=</span> ctx.query
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 36</span><span>		<span style=color:#8839ef>const</span> posts <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.find({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 37</span><span>			tags<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#8839ef>new</span> <span style=color:#04a5e5>RegExp</span>(q)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 38</span><span>		})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 39</span><span>			.populate(<span style=color:#40a02b>&#39;author&#39;</span>, <span style=color:#40a02b>&#39;-_id username bio image&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 40</span><span>			.sort({ createdAt<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#04a5e5;font-weight:700>-</span><span style=color:#fe640b>1</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 41</span><span>			.skip((<span style=color:#04a5e5;font-weight:700>+</span>page <span style=color:#04a5e5;font-weight:700>-</span> <span style=color:#fe640b>1</span>) <span style=color:#04a5e5;font-weight:700>*</span> <span style=color:#04a5e5;font-weight:700>+</span>per_page)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 42</span><span>			.limit(<span style=color:#04a5e5;font-weight:700>+</span>per_page)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 44</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>ctx.user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 45</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 46</span><span>				...posts.map(post =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 47</span><span>					id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 48</span><span>					title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 49</span><span>					description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 50</span><span>					body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 51</span><span>					tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 52</span><span>					autor<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 53</span><span>						username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 54</span><span>						bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 55</span><span>						image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 56</span><span>					},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 57</span><span>					isFavorite<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 58</span><span>					createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 59</span><span>					updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 60</span><span>				}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 61</span><span>			]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 62</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 63</span><span>			<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 65</span><span>			<span style=color:#8839ef>const</span> favorites <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Favorite.find({ author<span style=color:#04a5e5;font-weight:700>:</span> id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 67</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 68</span><span>				...posts.map(post =&gt; ({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 69</span><span>					id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 70</span><span>					title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 71</span><span>					description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 72</span><span>					body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 73</span><span>					tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 74</span><span>					autor<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 75</span><span>						username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 76</span><span>						bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 77</span><span>						image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 78</span><span>					},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 79</span><span>					isFavorite<span style=color:#04a5e5;font-weight:700>:</span> favorites.some(favorite =&gt; favorite.post.toString() <span style=color:#04a5e5;font-weight:700>===</span> post._id.toString()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 80</span><span>					createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 81</span><span>					updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 82</span><span>				}))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 83</span><span>			]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 84</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 85</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 86</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 87</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 88</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findPost(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 89</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 90</span><span>		<span style=color:#8839ef>const</span> post <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.findById(id).populate(<span style=color:#40a02b>&#39;author&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 91</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 92</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>post) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 93</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>404</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;文章不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 94</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 95</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 96</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>ctx.user) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 97</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 98</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 99</span><span>				title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">100</span><span>				description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">101</span><span>				body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">102</span><span>				tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">103</span><span>				author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">104</span><span>					username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">105</span><span>					bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">106</span><span>					image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">107</span><span>				},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">108</span><span>				isFavorite<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">109</span><span>				createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">110</span><span>				updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">111</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">112</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">113</span><span>			<span style=color:#8839ef>const</span> favorites <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Favorite.find({ user<span style=color:#04a5e5;font-weight:700>:</span> ctx.user.id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">114</span><span>			<span style=color:#8839ef>const</span> isFavorite <span style=color:#04a5e5;font-weight:700>=</span> favorites.some(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">115</span><span>				favorite =&gt; favorite.post.toString() <span style=color:#04a5e5;font-weight:700>===</span> post._id.toString()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">116</span><span>			)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">117</span><span>			ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">118</span><span>				id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">119</span><span>				title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">120</span><span>				description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">121</span><span>				body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">122</span><span>				tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">123</span><span>				author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">124</span><span>					username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">125</span><span>					bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">126</span><span>					image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">127</span><span>				},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">128</span><span>				isFavorite,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">129</span><span>				createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">130</span><span>				updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">131</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">132</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">133</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">134</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">135</span><span>	<span style=color:#9ca0b0;font-style:italic>// 收藏文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">136</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> favorite(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">137</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">138</span><span>		<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> ctx.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">139</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">140</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询文章是否存在
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">141</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> post <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.findById(id).populate(<span style=color:#40a02b>&#39;author&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">142</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">143</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>post) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">144</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>404</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;文章不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">145</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">146</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">147</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询是否已经收藏
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">148</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> favorite <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Favorite.findOne({ user<span style=color:#04a5e5;font-weight:700>:</span> loginUser.id, post<span style=color:#04a5e5;font-weight:700>:</span> id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">149</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">150</span><span>		<span style=color:#8839ef>if</span> (favorite) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">151</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>409</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;文章已收藏&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">152</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">153</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">154</span><span>		<span style=color:#9ca0b0;font-style:italic>// 收藏文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">155</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> Favorite.create({ post<span style=color:#04a5e5;font-weight:700>:</span> id, user<span style=color:#04a5e5;font-weight:700>:</span> loginUser.id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">156</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">157</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">158</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">159</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">160</span><span>			description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">161</span><span>			body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">162</span><span>			tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">163</span><span>			author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">164</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">165</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">166</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">167</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">168</span><span>			isFavorite<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">169</span><span>			createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">170</span><span>			updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">171</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">172</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">173</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">174</span><span>	<span style=color:#9ca0b0;font-style:italic>// 取消收藏文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">175</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> unfavorite(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">176</span><span>		<span style=color:#8839ef>const</span> { id } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">177</span><span>		<span style=color:#8839ef>const</span> loginUser <span style=color:#04a5e5;font-weight:700>=</span> ctx.user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">178</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">179</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询文章是否存在
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">180</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> post <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.findById(id).populate(<span style=color:#40a02b>&#39;author&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">181</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">182</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>post) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">183</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>404</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;文章不存在&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">184</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">185</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">186</span><span>		<span style=color:#9ca0b0;font-style:italic>// 查询是否已经收藏
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">187</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>const</span> favorite <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Favorite.findOne({ user<span style=color:#04a5e5;font-weight:700>:</span> loginUser.id, post<span style=color:#04a5e5;font-weight:700>:</span> id })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">188</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">189</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>favorite) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">190</span><span>			ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>409</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;文章未收藏&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">191</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">192</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">193</span><span>		<span style=color:#9ca0b0;font-style:italic>// 取消收藏文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">194</span><span><span style=color:#9ca0b0;font-style:italic></span>		<span style=color:#8839ef>await</span> Favorite.findByIdAndRemove(favorite._id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">195</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">196</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">197</span><span>			id<span style=color:#04a5e5;font-weight:700>:</span> post._id.toString(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">198</span><span>			title<span style=color:#04a5e5;font-weight:700>:</span> post.title,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">199</span><span>			description<span style=color:#04a5e5;font-weight:700>:</span> post.description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">200</span><span>			body<span style=color:#04a5e5;font-weight:700>:</span> post.body,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">201</span><span>			tags<span style=color:#04a5e5;font-weight:700>:</span> post.tags,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">202</span><span>			author<span style=color:#04a5e5;font-weight:700>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">203</span><span>				username<span style=color:#04a5e5;font-weight:700>:</span> post.author.username,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">204</span><span>				bio<span style=color:#04a5e5;font-weight:700>:</span> post.author.bio,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">205</span><span>				image<span style=color:#04a5e5;font-weight:700>:</span> post.author.image
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">206</span><span>			},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">207</span><span>			isFavorite<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>false</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">208</span><span>			createdAt<span style=color:#04a5e5;font-weight:700>:</span> post.createdAt,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">209</span><span>			updatedAt<span style=color:#04a5e5;font-weight:700>:</span> post.updatedAt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">210</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">211</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">212</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">213</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询所有标签
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">214</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findAllTags(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">215</span><span>		<span style=color:#8839ef>const</span> tags <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.find().distinct(<span style=color:#40a02b>&#39;tags&#39;</span>).exec()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">216</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">217</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> tags
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">218</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">219</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">220</span><span>	<span style=color:#9ca0b0;font-style:italic>// 查询所有标签文章
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">221</span><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>async</span> findAllTagPosts(ctx) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">222</span><span>		<span style=color:#8839ef>const</span> { tag } <span style=color:#04a5e5;font-weight:700>=</span> ctx.params
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">223</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">224</span><span>		<span style=color:#8839ef>const</span> posts <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>await</span> Post.find({ tags<span style=color:#04a5e5;font-weight:700>:</span> tag })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">225</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">226</span><span>		ctx.body <span style=color:#04a5e5;font-weight:700>=</span> posts
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">227</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">228</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">229</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">230</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> PostController()
</span></span></code></pre></div><p>文章通过<code>tag</code>标签查询：通过正则匹配文章中<code>tags</code>的内容即可实现。</p><p>文章收藏：通过将文章<code>id</code>和用户<code>id</code>添加到<code>Favorite</code>集合实现，添加到该集合的即表示用户收藏了文章。</p><p>取消收藏： 删除<code>Favorite</code>中的关联数据。</p><p>查询标签：直接查询所有文章，并通过<code>.distinct('tags')</code>将<code>tags</code>中的数据进行去重处理。</p><h4 id=middleware>Middleware<a class=anchorjs-link href=#middleware></a></h4><p>中间件主要是来做用户登录判断的，为后面的<code>controller</code>做一些登录和没登录的场景做区分。在post中做了用户登录可以看到哪些文章是被收藏过的，未登录的用户则都默认是为未收藏的。在<code>user</code>中也是一样，登录用户可以看到哪些用户是关注过的，未登录默认都是为关注。</p><p>因为有些场景是登录和未登录都可以的情况，所以需要通过传入判断来处理是否登录。</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 1</span><span><span style=color:#8839ef>const</span> { jwtVerify } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#39;@utils/handleJwt&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 3</span><span>module.exports <span style=color:#04a5e5;font-weight:700>=</span> (required <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#fe640b>true</span>) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 4</span><span>	<span style=color:#8839ef>return</span> <span style=color:#8839ef>async</span> (ctx, next) =&gt; {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 5</span><span>		<span style=color:#8839ef>const</span> { authorization <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>&#39;&#39;</span> } <span style=color:#04a5e5;font-weight:700>=</span> ctx.request.header
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 7</span><span>		<span style=color:#8839ef>if</span> (<span style=color:#04a5e5;font-weight:700>!</span>authorization) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 8</span><span>			<span style=color:#8839ef>if</span> (required) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1"> 9</span><span>				ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>401</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;请先登录&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">10</span><span>			} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">11</span><span>				<span style=color:#8839ef>await</span> next()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">12</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">13</span><span>		} <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">14</span><span>			<span style=color:#8839ef>try</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">15</span><span>				<span style=color:#8839ef>const</span> token <span style=color:#04a5e5;font-weight:700>=</span> authorization.replace(<span style=color:#40a02b>&#39;Bearer &#39;</span>, <span style=color:#40a02b>&#39;&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">16</span><span>				<span style=color:#8839ef>const</span> user <span style=color:#04a5e5;font-weight:700>=</span> jwtVerify(token)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">18</span><span>				ctx.user <span style=color:#04a5e5;font-weight:700>=</span> user
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">19</span><span>				<span style=color:#8839ef>await</span> next()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">20</span><span>			} <span style=color:#8839ef>catch</span> (err) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">21</span><span>				console.log(<span style=color:#40a02b>&#39;err: &#39;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">22</span><span>				ctx.<span style=color:#8839ef>throw</span>(<span style=color:#fe640b>401</span>, { message<span style=color:#04a5e5;font-weight:700>:</span> err <span style=color:#04a5e5;font-weight:700>||</span> <span style=color:#40a02b>&#39;token无效&#39;</span> })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">23</span><span>			}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">24</span><span>		}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">25</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#8c8fa1">26</span><span>}
</span></span></code></pre></div><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/posts/node-mongodb/ data-toggle=tooltip data-placement=top title="Node 14 Mongodb">Previous<br><span>Node 14 Mongodb</span></a></li><li class=next><a href=/posts/node-egg/ data-toggle=tooltip data-placement=top title="Node 16 Egg">Next<br><span>Node 16 Egg</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/api/>Api</a>
<a href=/tags/auth0/>Auth0</a>
<a href=/tags/chakraui/>Chakraui</a>
<a href=/tags/css/>Css</a>
<a href=/tags/egg/>Egg</a>
<a href=/tags/electron/>Electron</a>
<a href=/tags/elementplus/>ElementPlus</a>
<a href=/tags/elementui/>Elementui</a>
<a href=/tags/elint/>Elint</a>
<a href=/tags/eslint/>Eslint</a>
<a href=/tags/express/>Express</a>
<a href=/tags/firebase/>Firebase</a>
<a href=/tags/formik/>Formik</a>
<a href=/tags/git/>Git</a>
<a href=/tags/graphql/>GraphQL</a>
<a href=/tags/hexo/>Hexo</a>
<a href=/tags/icon/>Icon</a>
<a href=/tags/javascript/>Javascript</a>
<a href=/tags/koa/>Koa</a>
<a href=/tags/mongoddb/>Mongoddb</a>
<a href=/tags/nextjs/>Nextjs</a>
<a href=/tags/node/>Node</a>
<a href=/tags/pinia/>Pinia</a>
<a href=/tags/prettier/>Prettier</a>
<a href=/tags/prisma/>Prisma</a>
<a href=/tags/react/>React</a>
<a href=/tags/react-query/>React-Query</a>
<a href=/tags/react-router/>React-Router</a>
<a href=/tags/redux-toolkit/>Redux-Toolkit</a>
<a href=/tags/sequelize/>Sequelize</a>
<a href=/tags/strapi/>Strapi</a>
<a href=/tags/styled-components/>Styled-Components</a>
<a href=/tags/typescript/>Typescript</a>
<a href=/tags/valtio/>Valtio</a>
<a href=/tags/vite/>Vite</a>
<a href=/tags/vscode/>Vscode</a>
<a href=/tags/vue/>Vue</a>
<a href=/tags/vuex/>Vuex</a>
<a href=/tags/zustand/>Zustand</a>
<a href=/tags/%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/>避坑指南</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; SimFantasy 2024<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js crossorigin=anonymous></script><script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script><script src=/js/simple-jekyll-search.min.js></script><script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")})</script><script type=text/javascript src=/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js></script><script>$(document).ready(function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script src=/zoomjs/zoom.min.js></script></body></html>